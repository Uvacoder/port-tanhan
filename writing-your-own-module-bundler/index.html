<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:118.75%/1.58 'Lora',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.73);font-family:'Lora',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}ul{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.85rem;line-height:1.58rem;overflow:scroll;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1rem;line-height:1.58rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0.9875rem;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1.1487rem;line-height:1.58rem;border-left:0.5925rem solid #134896;color:hsla(0,0%,0%,0.65);font-style:italic;border-left-color:#612e77;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.58rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:0;}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}li > ul{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:0;}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:0;}code{font-size:0.85rem;line-height:1.58rem;}kbd{font-size:0.85rem;line-height:1.58rem;}samp{font-size:0.85rem;line-height:1.58rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.05333rem;padding-right:1.05333rem;padding-top:0.79rem;padding-bottom:calc(0.79rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#612e77;text-decoration:underline;text-shadow:initial;background-image:initial;font-weight:600;}a:hover,a:active{text-shadow:none;background-image:none;}h1,h2,h3,h4,h5,h6{margin-top:2.37rem;margin-bottom:0.79rem;}li>ol,li>ul{margin-left:20px;margin-bottom:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.58rem;color:hsla(0,0%,0%,0.73);font-style:normal;font-weight:400;}blockquote cite:before{content:"— ";}@media only screen and (max-width:480px){html{font-size:106.25%;line-height:28px;}blockquote{border-left:0.29625rem solid #134896;color:hsla(0,0%,0%,0.59);padding-left:0.88875rem;font-style:italic;margin-left:-1.185rem;margin-right:0;}}a.gatsby-resp-image-link{box-shadow:none;}</style><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="alternate" type="application/rss+xml" title="Tan Li Hau&#x27;s RSS Feed" href="/rss.xml"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#612e77"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><meta name="generator" content="Gatsby 2.13.6"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><title data-react-helmet="true">Writing your own module bundler | Tan Li Hau</title><meta data-react-helmet="true" name="description" content="Tan Li Hau is a frontend engineer who is currently working in Shopee"/><meta data-react-helmet="true" name="image" content="/static/profile-pic-65797d16af424cddbffebd0e19ab2f56.png"/><meta data-react-helmet="true" name="og:image" content="/static/profile-pic-65797d16af424cddbffebd0e19ab2f56.png"/><meta data-react-helmet="true" property="og:title" content="Writing your own module bundler"/><meta data-react-helmet="true" property="og:description" content="Tan Li Hau is a frontend engineer who is currently working in Shopee"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:site" content="@lihautan"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Tan Li Hau"/><meta data-react-helmet="true" name="twitter:title" content="Writing your own module bundler"/><meta data-react-helmet="true" name="twitter:description" content="Tan Li Hau is a frontend engineer who is currently working in Shopee"/><style data-href="/styles.a8c4ad346a5806bac5ff.css">@font-face{font-family:Varela Round;font-style:normal;font-display:swap;font-weight:400;src:local("Varela Round Regular "),local("Varela Round-Regular"),url(/static/varela-round-latin-400-579fc6ff502e1f1e998dacea2e83bf37.woff2) format("woff2"),url(/static/varela-round-latin-400-ed1cf004373cd51bd0fd4c0e3dca9fae.woff) format("woff")}@font-face{font-family:Lora;font-style:normal;font-display:swap;font-weight:400;src:local("Lora Regular "),local("Lora-Regular"),url(/static/lora-latin-400-e4cdb14bf148f2846997a6be7ba648bd.woff2) format("woff2"),url(/static/lora-latin-400-0d78d370987954fb6b9f0efec3065e83.woff) format("woff")}@font-face{font-family:Lora;font-style:italic;font-display:swap;font-weight:400;src:local("Lora Regular italic"),local("Lora-Regularitalic"),url(/static/lora-latin-400italic-2c4801fad2634e6dac678d8826cf417c.woff2) format("woff2"),url(/static/lora-latin-400italic-7beffbacbbde86423a7ee771f31c1626.woff) format("woff")}@font-face{font-family:Lora;font-style:normal;font-display:swap;font-weight:700;src:local("Lora Bold "),local("Lora-Bold"),url(/static/lora-latin-700-ce18d17335e3ef2119d76f5dff177c66.woff2) format("woff2"),url(/static/lora-latin-700-1617380e0dea667b61cf44e86f3d0f10.woff) format("woff")}@font-face{font-family:Lora;font-style:italic;font-display:swap;font-weight:700;src:local("Lora Bold italic"),local("Lora-Bolditalic"),url(/static/lora-latin-700italic-b4bb1fa2335d49d4bc7e7ddd944cee44.woff2) format("woff2"),url(/static/lora-latin-700italic-6ec37b950cf9829a2cad7d02b11810c9.woff) format("woff")}img{z-index:1}.gatsby-highlight,span.emoji{z-index:1;position:relative}body,div#___gatsby{background:#faf0fd}body.mode--dark{background:#050f02}div#___gatsby:after{content:"";background:#fff;position:fixed;top:0;bottom:0;left:0;right:0;pointer-events:none;mix-blend-mode:difference;opacity:0;-webkit-transition:.5s ease;transition:.5s ease}.mode--dark div#___gatsby:after{opacity:1}.dark-mode-checkbox{position:fixed;bottom:20px;right:20px;z-index:1;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50% 50% 0 0;border:solid #612e77;border-width:0 0 2px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;overflow:hidden;-webkit-tap-highlight-color:transparent}.mode--dark .dark-mode-checkbox{border-color:#9ed188}.dark-mode-checkbox input{display:none}.dark-mode-checkbox span{font-size:30px;line-height:30px;position:absolute;-webkit-animation-duration:.5s;animation-duration:.5s;-webkit-animation-timing-function:ease-in-out;animation-timing-function:ease-in-out}@-webkit-keyframes sun{0%{-webkit-transform:translateY(150%);transform:translateY(150%)}to{-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes sun{0%{-webkit-transform:translateY(150%);transform:translateY(150%)}to{-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes sun-dark{0%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(-150%);transform:translateY(-150%)}}@keyframes sun-dark{0%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(-150%);transform:translateY(-150%)}}@-webkit-keyframes moon{0%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(-150%);transform:translateY(-150%)}}@keyframes moon{0%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(-150%);transform:translateY(-150%)}}@-webkit-keyframes moon-dark{0%{-webkit-transform:translateY(150%);transform:translateY(150%)}to{-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes moon-dark{0%{-webkit-transform:translateY(150%);transform:translateY(150%)}to{-webkit-transform:translateY(0);transform:translateY(0)}}.dark-mode-checkbox .sun{-webkit-animation-name:sun;animation-name:sun;-webkit-transform:0;transform:0}.dark-mode-checkbox .moon{-webkit-animation-name:moon;animation-name:moon}.dark-mode-checkbox .moon,.mode--dark .dark-mode-checkbox .sun{-webkit-transform:translateY(-150%);transform:translateY(-150%)}.mode--dark .dark-mode-checkbox .sun{-webkit-animation-name:sun-dark;animation-name:sun-dark}.mode--dark .dark-mode-checkbox .moon{-webkit-animation-name:moon-dark;animation-name:moon-dark;-webkit-transform:translateY(0);transform:translateY(0)}.BioImage-module--container--1PFVh{position:relative}.BioImage-module--image1--14nWk{opacity:0;color:green}.BioImage-module--image2--1Blhq{position:absolute!important;left:0;opacity:1}.BioImage-module--image1--14nWk,.BioImage-module--image2--1Blhq{-webkit-transition:opacity .5s ease-in-out;transition:opacity .5s ease-in-out}.BioImage-module--showImage--2hBbU .BioImage-module--image1--14nWk{opacity:1}.BioImage-module--showImage--2hBbU .BioImage-module--image2--1Blhq{opacity:0}:root{--prism-padding:20px}pre::-webkit-scrollbar{width:14px}pre::-webkit-scrollbar-track{background-color:#6272a4;border-radius:0}pre::-webkit-scrollbar-thumb{background-color:#bd93f9;border-radius:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:#282936;text-shadow:none;font-family:PT Mono,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background-color:#5a5f80}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background-color:#5a5f80}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{background:#282936!important;border-radius:.5em;padding:var(--prism-padding,1em);margin:.5em 0;overflow:auto;height:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#282936}:not(pre)>code[class*=language-]{padding:4px 7px;border-radius:.3em;white-space:normal}.limit-300{height:300px!important}.limit-400{height:400px!important}.limit-500{height:500px!important}.limit-600{height:600px!important}.limit-700{height:700px!important}.limit-800{height:800px!important}.token.comment{color:#6272a4}.token.prolog{color:#cfcfc2}.token.tag{color:#dc68aa}.token.entity{color:#8be9fd}.token.atrule{color:#62ef75}.token.url{color:#66d9ef}.token.selector{color:#cfcfc2}.token.string{color:#f1fa8c}.token.property{color:#ffb86c}.token.important{color:#ff79c6;font-weight:700}.token.punctuation{color:#e6db74}.token.number{color:#bd93f9}.token.function{color:#50fa7b}.token.class-name{color:#ffb86c}.token.keyword{color:#ff79c6}.token.boolean{color:#ffb86c}.token.operator{color:#8be9fd}.token.char{color:#ff879d}.token.regex,.token.variable{color:#50fa7b}.token.constant,.token.symbol{color:#ffb86c}.token.builtin{color:#ff79c6}.token.attr-value{color:#7ec699}.token.deleted,.token.namespace{color:#e2777a}.token.bold{font-weight:700}.token.italic{font-style:italic}.token{color:#ff79c6}.langague-c .token.string,.langague-cpp .token.string{color:#8be9fd}.language-css .token.selector{color:#50fa7b}.language-css .token.property{color:#ffb86c}.language-java .token.class-name,.language-java span.token.class-name{color:#8be9fd}.language-markup .token.attr-value{color:#66d9ef}.language-markup .token.tag{color:#50fa7b}.language-objectivec .token.property{color:#66d9ef}.language-objectivec .token.string{color:#50fa7b}.language-php .token.boolean{color:#8be9fd}.language-php .token.function{color:#ff79c6}.language-php .token.keyword{color:#66d9ef}.language-ruby .token.symbol{color:#8be9fd}.language-ruby .token.class-name{color:#cfcfc2}pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre.line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}div.code-toolbar{position:relative}div.code-toolbar>.toolbar{position:absolute;top:.3em;right:.2em;-webkit-transition:opacity .3s ease-in-out;transition:opacity .3s ease-in-out;opacity:0}div.code-toolbar:hover>.toolbar{opacity:1}div.code-toolbar>.toolbar .toolbar-item{display:inline-block;padding-right:20px}div.code-toolbar>.toolbar a{cursor:pointer}div.code-toolbar>.toolbar button{background:none;border:0;color:inherit;font:inherit;line-height:normal;overflow:visible;padding:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}div.code-toolbar>.toolbar a,div.code-toolbar>.toolbar button,div.code-toolbar>.toolbar span{color:#ccc;font-size:.8em;padding:.5em;background:#6272a4;border-radius:.5em}div.code-toolbar>.toolbar a:focus,div.code-toolbar>.toolbar a:hover,div.code-toolbar>.toolbar button:focus,div.code-toolbar>.toolbar button:hover,div.code-toolbar>.toolbar span:focus,div.code-toolbar>.toolbar span:hover{color:inherit;text-decoration:none;background-color:var(--verde)}.gatsby-highlight-code-line{background-color:#2f3041;display:block;margin-right:-1em;margin-left:-1.25em;padding-right:1em;padding-left:.75em;border-left:.5em solid #ff79c6}:not(pre)>code.language-text{background-color:rgba(40,41,54,.2);color:rgba(0,0,0,.73)}:not(pre)>code.language-text::-moz-selection{color:#fff}:not(pre)>code.language-text::selection{color:#fff}.gatsby-highlight,p.filename{margin-left:calc(-1*var(--prism-padding));margin-right:calc(-1*var(--prism-padding))}.gatsby-highlight+blockquote,.gatsby-highlight+p:not(.filename){margin-top:1.58em}.index-module--list--3C1Zu{margin-bottom:0;margin-top:0}.index-module--p--4EDuH{margin-bottom:.4rem;margin-top:.4rem}.gatsby-highlight+.caption,figcaption{font-size:.8rem;font-style:italic;font-weight:lighter;color:rgba(0,0,0,.65);text-decoration:underline;margin-bottom:1em}.gatsby-highlight+.caption{margin-top:-.5em}.gatsby-highlight+.caption>code[class*=language-],figcaption>code[class*=language-]{padding:2px 4px;font-size:.8em;background-color:rgba(0,0,0,.65);color:#faf0fd}.filename{font-size:.85em;font-style:italic;margin-bottom:0;padding:8px var(--prism-padding);padding-bottom:0;background:#282936;color:#faf0fd;border-top-left-radius:.5em;border-top-right-radius:.5em;text-decoration:underline}.filename+.gatsby-highlight pre{border-top-left-radius:0;border-top-right-radius:0;margin-top:0;padding-top:2px}</style><link href="//fonts.googleapis.com/css?family=Varela+Round:400|Lora:400,400i,700" rel="stylesheet" type="text/css"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-3344a3abd0492eb674d1.js"/><link as="script" rel="preload" href="/1-d685488249c35c265129.js"/><link as="script" rel="preload" href="/app-aff19638c33f24dd1a38.js"/><link as="script" rel="preload" href="/styles-0bf1084b9cad04e11a70.js"/><link as="script" rel="preload" href="/webpack-runtime-bac7fb22492d2147b953.js"/><link as="fetch" rel="preload" href="/page-data/writing-your-own-module-bundler/page-data.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:37.92rem;padding:2.37rem 1.185rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;text-decoration:none;color:inherit" href="/">Tan Li Hau</a></h3></header><main><script type="application/ld+json">{&quot;@context&quot;:&quot;http://schema.org&quot;,&quot;@type&quot;:&quot;Article&quot;,&quot;author&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;},&quot;copyrightHolder&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;},&quot;copyrightYear&quot;:&quot;2019&quot;,&quot;creator&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;},&quot;publisher&quot;:{&quot;@type&quot;:&quot;Organization&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;,&quot;logo&quot;:{&quot;@type&quot;:&quot;ImageObject&quot;,&quot;url&quot;:&quot;/static/profile-pic-65797d16af424cddbffebd0e19ab2f56.png&quot;}},&quot;datePublished&quot;:&quot;June 29, 2019&quot;,&quot;dateModified&quot;:&quot;June 29, 2019&quot;,&quot;description&quot;:&quot;Tan Li Hau is a frontend engineer who is currently working in Shopee&quot;,&quot;headline&quot;:&quot;Writing your own module bundler&quot;,&quot;inLanguage&quot;:&quot;en&quot;,&quot;url&quot;:&quot;https://lihautan.com//writing-your-own-module-bundler/&quot;,&quot;name&quot;:&quot;Writing your own module bundler&quot;,&quot;image&quot;:{&quot;@type&quot;:&quot;ImageObject&quot;,&quot;url&quot;:&quot;/static/profile-pic-65797d16af424cddbffebd0e19ab2f56.png&quot;},&quot;mainEntityOfPage&quot;:&quot;https://lihautan.com//writing-your-own-module-bundler/&quot;}</script><script type="application/ld+json">{&quot;@context&quot;:&quot;http://schema.org&quot;,&quot;@type&quot;:&quot;BreadcrumbList&quot;,&quot;description&quot;:&quot;Breadcrumbs list&quot;,&quot;name&quot;:&quot;Breadcrumbs&quot;,&quot;itemListElement&quot;:[{&quot;@type&quot;:&quot;ListItem&quot;,&quot;item&quot;:{&quot;@id&quot;:&quot;https://lihautan.com&quot;,&quot;name&quot;:&quot;Homepage&quot;},&quot;position&quot;:1},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;item&quot;:{&quot;@id&quot;:&quot;https://lihautan.com//writing-your-own-module-bundler/&quot;,&quot;name&quot;:&quot;Writing your own module bundler&quot;},&quot;position&quot;:2}]}</script><h1>WIP: <!-- -->Writing your own module bundler</h1><p style="font-size:0.87055rem;line-height:1.58rem;display:block;margin-bottom:1.58rem;margin-top:-0.79rem">June 29, 2019</p><div><p>In my <a href="/what-is-module-bundler-and-how-does-it-work/">previous article</a>, I explained how module bundler works, and I used <a href="https://webpack.js.org">webpack</a> and <a href="https://rollupjs.org">rollup</a> as example, and each of them gave us a different perspective in how we can bundle our JavaScript application.</p>
<p>If you haven’t read it, please do <a href="/what-is-module-bundler-and-how-does-it-work/">check it out</a>, because in this article, I am going to talk about how we are going to write a module bundler ourselves.</p>
<hr>
<p><span class="emoji">⚠️</span> <strong>Warning: Tons of code ahead. <span class="emoji">🙈</span><span class="emoji">😱</span><span class="emoji">😨</span></strong> <span class="emoji">⚠️</span></p>
<hr>
<h1>Getting Started</h1>
<p>We have seen the input (the JavaScript modules) and the output (the bundled JavaScript file) of a module bundler in the <a href="/what-is-module-bundler-and-how-does-it-work/">previous article</a>, now let’s take a look how we can create a tool to get takes in the input and produce the output.</p>
<p>A basic module bundler can be broken down into 2 parts:</p>
<ul>
<li>Understands the code and constructs the dependency graph <strong>(Dependency Resolution)</strong></li>
<li>Assembles the module into a single (or multiple) JavaScript file <strong>(Bundle)</strong></li>
</ul>
<blockquote>
<p>A <strong>dependency graph</strong> is a graph representation of the dependency relationship between modules.</p>
</blockquote>
<h2>The Input</h2>
<p>We will be using the following files as input to our bundler:</p>
<p class="filename">index.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> squareArea <span class="token keyword">from</span> <span class="token string">'./square.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> circleArea <span class="token keyword">from</span> <span class="token string">'./circle.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p class="filename">square.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span>side<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> side <span class="token operator">*</span> side<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> area<span class="token punctuation">;</span></code></pre></div>
<p class="filename">circle.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> area<span class="token punctuation">;</span></code></pre></div>
<p>If you want to try along, you can clone <a href="https://github.com/tanhauhau/byo-bundler/tree/master/fixture">this project</a> and checkout the <code class="language-text">fixture-1</code> tag. the input files are in the <code class="language-text">fixture/</code> folder.</p>
<h1>Writing</h1>
<p>So let’s start with creating the outline of the main function of our module bundler, and let’s call it <code class="language-text">build</code>.</p>
<!-- prettier-ignore -->
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entryFile<span class="token punctuation">,</span> outputFolder <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// build dependency graph</span>
  <span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token function">createDependencyGraph</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// bundle the asset</span>
  <span class="token keyword">const</span> outputFiles <span class="token operator">=</span> <span class="token function">bundle</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// write to output folder</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> outputFile <span class="token keyword">of</span> outputFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>
      path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>outputFolder<span class="token punctuation">,</span> outputFile<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
      outputFile<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
      <span class="token string">'utf-8'</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>The <strong>dependency graph</strong> that we are going to build, is a <a href="https://en.wikipedia.org/wiki/Directed_graph">directed graph</a>, where the vertex is the module, and the directed edge is the dependency relationship between the modules.</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createDependencyGraph</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rootModule <span class="token operator">=</span> <span class="token function">createModule</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> rootModule<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The dependency graph creates a module with the entry file, and we are going to return just that at the moment.</p>
<p>So, let’s implement <code class="language-text">createModule</code>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createModule</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The class <code class="language-text">Module</code> will be used to record module properties, such as the content, the dependencies, exported keys, etc.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>While the <code class="language-text">content</code> is the string content of the module, to understand what it actually means, we would need to <em>parse the content</em> into AST (Abstract Syntax Tree). Let’s use <a href="http://babeljs.io">babel</a> to parse the code:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>ast <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">parseSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The next thing we are looking for, is the dependency of this module:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ast <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">parseSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">  <span class="token function">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token comment">//</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">}</span></code></pre></div>
<p>So, how do we know what is the dependency of this module? Well we can find the <code class="language-text">import</code> statement from the AST we just got. How do we know how does our AST look like, and how to find the <code class="language-text">import</code> statement from our AST? Well, you can visualise it through <a href="https://lihautan.com/babel-ast-explorer/#?eyJiYWJlbFNldHRpbmdzIjp7InZlcnNpb24iOiI3LjQuNSJ9LCJ0cmVlU2V0dGluZ3MiOnsiaGlkZUVtcHR5Ijp0cnVlLCJoaWRlTG9jYXRpb24iOnRydWUsImhpZGVUeXBlIjp0cnVlfSwiY29kZSI6ImltcG9ydCBzcXVhcmVBcmVhIGZyb20gJy4vc3F1YXJlLmpzJztcbmltcG9ydCBjaXJjbGVBcmVhIGZyb20gJy4vY2lyY2xlLmpzJztcblxuY29uc29sZS5sb2coJ0FyZWEgb2Ygc3F1YXJlOiAnLCBzcXVhcmVBcmVhKDUpKTtcbmNvbnNvbGUubG9nKCdBcmVhIG9mIGNpcmNsZScsIGNpcmNsZUFyZWEoNSkpO1xuIn0=">babel-ast-explorer</a>:</p>
<p>
  <a class="gatsby-resp-image-link" href="/static/87b78a845870fcfa5bb6756e80815d95/bb144/ast-import.png" style="display: block" target="_blank" rel="noopener">
  
  <figure class="gatsby-resp-image-wrapper" style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 38.67187499999999%; position: relative; bottom: 0; left: 0; background-image: url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABNUlEQVQoz41Ry0rDQBSd0gqC4La49jtcVa0bEfwAv0hX+iP6MwWF9DFpO5OkaYtN2mQm93jzIE1RoQdOztzHnNybiNHQgTMaYjIaQ8spPM+DUqqm1gqfEw9SSozdORw5x2zq4ktqSNfluobv+wiCAIPBAGKmNJbaR+KHiMMVFsslsixDE8YQNivCeksw+B9KeRCpsaCU21iTNEUUxyAi8KNQIls0x9EH/PAe37sHfuEN53sNXnNHjyd9hMibqWITVBua3JvxjO1WwAvPoaMOLOVXBdea7FaG9eU99/lyScreYK3g6U4512G2OduuNI9brJeHhn+hNqRXROsOFqsu1unZgWF5brEeYcgft1r5BWYnEMYn2Njf65bxxTETlj8lMe/Y7K6Q2DuO+lzoc61fnEu9ZX3CD9ttQVhUpVN6AAAAAElFTkSuQmCC&#x27;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="babel-ast-explorer" title="Visualizing AST through babel-ast-explorer" src="/static/87b78a845870fcfa5bb6756e80815d95/623ee/ast-import.png" srcset="/static/87b78a845870fcfa5bb6756e80815d95/816c5/ast-import.png 148w, /static/87b78a845870fcfa5bb6756e80815d95/c766b/ast-import.png 295w, /static/87b78a845870fcfa5bb6756e80815d95/623ee/ast-import.png 590w, /static/87b78a845870fcfa5bb6756e80815d95/e5345/ast-import.png 885w, /static/87b78a845870fcfa5bb6756e80815d95/7a439/ast-import.png 1180w, /static/87b78a845870fcfa5bb6756e80815d95/84fe0/ast-import.png 1770w, /static/87b78a845870fcfa5bb6756e80815d95/bb144/ast-import.png 2560w" sizes="(max-width: 590px) 100vw, 590px">
    </span>
  <figcaption>Visualizing AST through babel-ast-explorer</figcaption></figure>
  
  </a>
    </p>
<p>We can see that the node we are looking for is called <code class="language-text">ImportDeclaration</code>, and the property that tells us where we are importing from is the <code class="language-text">source.value</code>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>node <span class="token operator">=></span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>node <span class="token operator">=></span> node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">)</span></span><span class="token punctuation">}</span></code></pre></div>
<p>So now we have the path that we are requesting, it could be relative to our current file, eg <em>”./foo/bar”</em>, or from our node*modules, eg: *“lodash”_, so how do we know what is the actual file path that we are requesting?</p>
<p>The step that we need to do, to figure out the actual path based on the requested path, is called <strong>“Resolving”</strong>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>node <span class="token operator">=></span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>node <span class="token operator">=></span> node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line">    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>relativePath <span class="token operator">=></span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filePath<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>

<span class="gatsby-highlight-code-line"><span class="token comment">// resolving</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span>requester<span class="token punctuation">,</span> requestedPath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token comment">//</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code></pre></div>
<div class="caption">Resolving path to the actual file path</div>
<h2>Resolving</h2>
<p>We know that “import”ing <code class="language-text">./b.js</code> in the following examples will result in getting a different file, because when we specify <code class="language-text">./</code>, we are “import”ing relative to the current file.</p>
<p class="filename"><root>/a.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token string">'./b.js'</span><span class="token punctuation">;</span></code></pre></div>
<p class="filename"><root>/foo/a.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token string">'./b.js'</span><span class="token punctuation">;</span></code></pre></div>
<p>So, what are the rules of resolving a module? <a href="http://nodejs.org/api/modules.html#modules_all_together">Node.js Modules Resolving</a> list out the detail step of the Node.js resolving algorithm:</p>
<p>When we specify a relative path, <code class="language-text">./b</code>, Node.js will first assume that <code class="language-text">./b</code> is a file, and tries the following extension if it doesn’t exactly match the file name:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">b
b.js
b.json
b.node</code></pre></div>
<p>If the file does not exist, Node.js will then try to treat <code class="language-text">./b</code> as a directory, and try the following:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">&quot;main&quot; in b/package.json
b/index.js
b/index.json
b/index.node</code></pre></div>
<p>If we specify <code class="language-text">import &#39;b&#39;</code> instead, Node.js will treat it as a package within <code class="language-text">node_modules/</code>, and have a different resolving strategy.</p>
<p>Through the above illustration, we can see that resolving <code class="language-text">import &#39;./b&#39;</code> is not as simple as it seems. Besides the default Node.js resolving behaviour, <a href="https://webpack.js.org/configuration/resolve/">webpack provides a lot more customisation options</a>, such as custom extensions, alias, modules folders, etc.</p>
<p>To move things forward, we are going to handle resolving relative path for now:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line"><span class="token comment">// resolving</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span>requester<span class="token punctuation">,</span> requestedPath<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>requester<span class="token punctuation">)</span><span class="token punctuation">,</span> requestedPath<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code></pre></div>
<blockquote>
<p><small><strong>Note:</strong> You should try out writing a full node resolvers that resolve relatively as well as absolutely from <code class="language-text">node_modules/</code></small></p>
</blockquote>
<p>Now we know the actual requested file path, let’s create a module out of them as well!</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>program<span class="token punctuation">.</span>body
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>node <span class="token operator">=></span> node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>node <span class="token operator">=></span> node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>relativePath <span class="token operator">=></span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filePath<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line">    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>absolutePath <span class="token operator">=></span> <span class="token function">createModule</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></code></pre></div>
<p>So, for each module, we find their dependencies, parse them, and find each dependency’s dependencies recursively. At the end of the process, we will get a module dependency graph. If you console out the dependency graph, you will see something like this:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">Module <span class="token punctuation">{</span>
  filePath<span class="token punctuation">:</span> <span class="token string">'/Projects/byo-bundler/fixture/index.js'</span><span class="token punctuation">,</span>
  content<span class="token punctuation">:</span>
   <span class="token string">'import squareArea from \'./square.js\';\nimport circleArea from \'./circle.js\';\n\nconsole.log(\'Area of square: \', squareArea(5));\nconsole.log(\'Area of circle\', circleArea(5));\n'</span><span class="token punctuation">,</span>
  ast<span class="token punctuation">:</span>
   Node <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  dependencies<span class="token punctuation">:</span>
   <span class="token punctuation">[</span> Module <span class="token punctuation">{</span>
       filePath<span class="token punctuation">:</span> <span class="token string">'/Projects/byo-bundler/fixture/square.js'</span><span class="token punctuation">,</span>
       content<span class="token punctuation">:</span>
        <span class="token string">'function area(side) {\n  return side * side;\n}\nexport default area;\n'</span><span class="token punctuation">,</span>
       ast<span class="token punctuation">:</span> Node <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
       dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
     Module <span class="token punctuation">{</span>
       filePath<span class="token punctuation">:</span> <span class="token string">'/Projects/byo-bundler/fixture/circle.js'</span><span class="token punctuation">,</span>
       content<span class="token punctuation">:</span>
        <span class="token string">'const PI = 3.141;\nfunction area(radius) {\n    return PI * radius * radius;\n}\nexport default area;\n'</span><span class="token punctuation">,</span>
       ast<span class="token punctuation">:</span> Node <span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
       dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The root of the graph is our entry module, and you can traverse the graph through the <code class="language-text">dependencies</code> of the module. As you can see, the <code class="language-text">index.js</code> has 2 dependencies, the <code class="language-text">square.js</code> and the <code class="language-text">circle.js</code>.</p>
<blockquote>
<p><small><strong>Note:</strong> If you are following along, you can checkout the tag <code class="language-text">feat-1-module-dependency-graph</code>, to see the code that we have written so far.</small></p>
</blockquote>
<h2>Bundling</h2>
<p>So now with the module dependency graph, it’s time for us to bundle them into a file!</p>
<p>At this point in time, we can choose whether we want to bundle it in the <strong>“webpack way”</strong> or the <strong>“rollup way”</strong>. In this article we are going to look at the <strong>“webpack way”</strong>, I’ll write about bundling in the <strong>“rollup way”</strong> in the next article.</p>
<blockquote>
<p>If you have no idea about what is the <strong>“webpack way”</strong> or <strong>“rollup way”</strong>, I have coined the term in my <a href="/what-is-module-bundler-and-how-does-it-work/">previous article</a> and have detailed explanation about them!</p>
</blockquote>
<p>Let’s take a look how the final bundled file would look like:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'circle.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'square.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exports<span class="token punctuation">.</span><span class="token function-variable function">default</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span>side<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> side <span class="token operator">*</span> side<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">'app.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> squareArea <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'square.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> circleArea <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'circle.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">webpackStart</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  modules<span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span> <span class="token string">'app.js'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Let’s break it down to a few steps:</p>
<ul>
<li><strong>Group modules into files</strong></li>
<li><strong>Create the module map</strong> and wrapping each module in a “special” module factory function</li>
<li><strong>Create the “runtime”</strong>, the glue that links each module together.</li>
</ul>
<h3>Grouping modules into files</h3>
<p>We need to decide which modules goes to which file. We split them into different files because of <a href="https://webpack.js.org/guides/code-splitting/">code splitting</a> due to dynamic import as well as optimisation, such as the webpack’s <a href="https://webpack.js.org/plugins/split-chunks-plugin/">Chunk Splitting</a>.
We’ll work on the code splitting later, let us first focus on making our module bundler works.</p>
<p>So, we collect all the modules into a list, by doing a graph traversal:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token function">collectModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">collectModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token function">collect</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> modules<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> modules<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">function</span> <span class="token function">collect</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> modules<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    module<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dependency <span class="token operator">=></span> <span class="token function">collect</span><span class="token punctuation">(</span>dependency<span class="token punctuation">,</span> modules<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code></pre></div>
<p>…and we’ll take the list and make them into a module map.</p>
<h3>Creating module map</h3>
<p>Module map that we are creating here is a string, that would be inlined into the bundle file.</p>
<p>So, we loop through each module, and add use <code class="language-text">module.filePath</code> as the key, and <code class="language-text">module.content</code> as the value.</p>
<p>The reason I dont use <code class="language-text">JSON.stringify(moduleMap)</code> instead of manually concatenating to build up the module map, is because JSON can only takes in <a href="https://documentation.progress.com/output/ua/OpenEdge_latest/index.html#page/dvjsn/json-data-types.html">JSON primitive data type</a> as value, but what I want to build here is a JavaScript map, with <code class="language-text">function</code> as value, but in string.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">collectModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> moduleMap <span class="token operator">=</span> <span class="token function">toModuleMap</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">toModuleMap</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> moduleMap <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  moduleMap <span class="token operator">+=</span> <span class="token string">'{'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    moduleMap <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">": </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,`</span></span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">  moduleMap <span class="token operator">+=</span> <span class="token string">'}'</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> moduleMap<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code></pre></div>
<p>If you have noticed, we need to wrap the <code class="language-text">module.content</code> with a module factory function:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  moduleMap <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">": function(exports, require) { </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span></span>    module<span class="token punctuation">.</span>content
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> },`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>So, what this function do is that, it provides 2 parameter to the module:</p>
<ul>
<li><code class="language-text">exports</code>, an object that the module can assign its exported value onto</li>
<li><code class="language-text">require</code>, a function that the module can invoke with module path to import exported value from another module</li>
</ul>
<p>So, if you console out the module map right now, it doesn’t seemed to be something that can be executed:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token string">"index.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">import</span> squareArea <span class="token keyword">from</span> <span class="token string">'./square.js'</span><span class="token punctuation">;</span>
    <span class="token keyword">import</span> circleArea <span class="token keyword">from</span> <span class="token string">'./circle.js'</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"square.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span>side<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> side <span class="token operator">*</span> side<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"circle.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>That’s because it still uses <code class="language-text">import</code> and <code class="language-text">export</code> and we need to transform them to use <code class="language-text">exports</code> and <code class="language-text">require</code> that we pass in.</p>
<p>To transform the code, we can utilise the <code class="language-text">ast</code> of the module: we do transformation on the ast, and then generate the code based on the transformed ast.</p>
<p>So how do we get started in transforming the ast?</p>
<p>I wrote a <a href="/step-by-step-guide-for-writing-a-babel-transformation">step by step guide</a> on how to do it, so I am not going to repeat the details over here.</p>
<p>Right now, what we need is the following transformation:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// #1</span>
<span class="token comment">// from</span>
<span class="token keyword">import</span> a<span class="token punctuation">,</span> <span class="token punctuation">{</span> b<span class="token punctuation">,</span> c <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
<span class="token comment">// to</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// #2</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> a<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> c <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// to</span>
exports<span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">=</span> a<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>c <span class="token operator">=</span> c<span class="token punctuation">;</span></code></pre></div>
<p>Now knowing <strong>what to target on AST</strong> and <strong>how the transformed AST look like</strong>, let’s write the transformation code:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  module<span class="token punctuation">.</span><span class="token function">transformModuleInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>  moduleMap <span class="token operator">+=</span> <span class="token template-string"><span class="token string">`"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">": function(exports, require) { </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token punctuation">.</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> },`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="gatsby-highlight-code-line">  <span class="token function">transformModuleInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> ast<span class="token punctuation">,</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transformFromAstSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>ast <span class="token operator">=</span> ast<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token operator">=</span> code<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">}</span></code></pre></div>
<p>I purposely omitted the actual babel transformation code, because it is lengthy. If you are interested to read about it, you can check out</p>
<!-- TODO: -->.
<p>So, now the module map looks ready:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token string">"index.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> squareArea <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'square.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> circleArea <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'circle.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"square.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span>side<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> side <span class="token operator">*</span> side<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    exports<span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">=</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"circle.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span>radius<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    exports<span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">=</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>One thing we need to take note is that, for the <code class="language-text">require</code> statements, we need to replace those requested path to the actual resolved path.</p>
<h3><strong>Create the “runtime”</strong>,</h3>
<p>Now you have the module map, it’s time to create the runtime. The runtime is a piece of code that is part of the output bundle, that runs when the application code is running, therefore, the runtime.</p>
<p>We can store the runtime code in a template file or as a string, and then concatenate with the module map string:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">collectModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleMap <span class="token operator">=</span> <span class="token function">toModuleMap</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> moduleCode <span class="token operator">=</span> <span class="token function">addRuntime</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">,</span> modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">addRuntime</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">,</span> entryPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="gatsby-highlight-code-line">    const modules = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>moduleMap<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="gatsby-highlight-code-line">    const entry = "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>entryPoint<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">";</span><span class="gatsby-highlight-code-line">    function webpackStart({ modules, entry }) {</span><span class="gatsby-highlight-code-line">      const moduleCache = {};</span><span class="gatsby-highlight-code-line">      const require = moduleName => {</span><span class="gatsby-highlight-code-line">        // if in cache, return the cached version</span><span class="gatsby-highlight-code-line">        if (moduleCache[moduleName]) {</span><span class="gatsby-highlight-code-line">          return moduleCache[moduleName];</span><span class="gatsby-highlight-code-line">        }</span><span class="gatsby-highlight-code-line">        const exports = {};</span><span class="gatsby-highlight-code-line">        // this will prevent infinite "require" loop</span><span class="gatsby-highlight-code-line">        // from circular dependencies</span><span class="gatsby-highlight-code-line">        moduleCache[moduleName] = exports;</span><span class="gatsby-highlight-code-line">    </span><span class="gatsby-highlight-code-line">        // "require"-ing the module,</span><span class="gatsby-highlight-code-line">        // exported stuff will assigned to "exports"</span><span class="gatsby-highlight-code-line">        modules[moduleName](exports, require);</span><span class="gatsby-highlight-code-line">        return moduleCache[moduleName];</span><span class="gatsby-highlight-code-line">      };</span><span class="gatsby-highlight-code-line">    </span><span class="gatsby-highlight-code-line">      // start the program</span><span class="gatsby-highlight-code-line">      require(entry);</span><span class="gatsby-highlight-code-line">    }</span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">    webpackStart({ modules, entry });`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line"><span class="token comment">// trim away spaces before the line</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">function</span> <span class="token function">trim</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> lines <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> padLength <span class="token operator">=</span> lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trimLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`^\\s{</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>padLength<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">}`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> lines<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">=></span> line<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code></pre></div>
<p>The code above is self explanatory, except if you have no idea what does the <code class="language-text">webpackStart()</code> do, you can read more about it in <a href="/what-is-module-bundler-and-how-does-it-work/">my previous post</a>.</p>
<p>Finally, we return the module code from the <code class="language-text">bundle</code> function:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">collectModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleMap <span class="token operator">=</span> <span class="token function">toModuleMap</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleCode <span class="token operator">=</span> <span class="token function">addRuntime</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">,</span> modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> moduleCode <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="token punctuation">}</span></code></pre></div>
<p>Now if you run the code, you will see a <code class="language-text">output/bundle.js</code> file generated. Run it with node, you will see:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Area of square:  25
Area of circle 78.525</code></pre></div>
<p>That’s it! You have a working module bundler!</p>
<p>Of course, the module bundler we have is nowhere near webpack. Webpack supports more module system, resolving strategies, loading strategies, plugin system, optimisation, and many many more. Hopefully through this exercise of writing our own module bundler, I hope we can be more appreciative of what webpack has provided to us.</p>
<h1>Optimisation</h1>
<p>Before we pat ourself on the back and call it a day, there is a bug that we need to fix: Circular Dependency.</p>
<h2>Circular dependency</h2>
<h2>Module ID</h2>
<h1>Summary</h1>
<ul>
<li>bundle(graph); returns an array -> we are going to do code splitting</li>
</ul>
<h1>Further Readings</h1>
<ul>
<li><a href="https://slides.com/lucianomammino/unbundling-the-javascript-module-bundler-dublinjs">Luciano Mammino, Unbundling the JavaScript module bundler - DublinJS July 2018</a></li>
<li><a href="https://www.youtube.com/watch?v=Gc9-7PBqOC8">Ronen Amiel, Build Your Own Webpack - You Gotta Love Frontend 2018</a></li>
</ul></div><hr style="margin-bottom:1.58rem"/><p>Thank you for your time reading through this article.<br/>It means a lot to me.</p><p> If you like what you have just read,<br/><a href="https://twitter.com/intent/tweet?text=Insightful%20article%20from%20%40lihautan&amp;url=undefined">Tweet about it</a> so I will write more related articles;<br/>If you disagree or you have opinions about this article,<br/><a href="https://twitter.com/intent/tweet?text=I%20disgree%20with%20%40lihautan&#x27;s%20article&amp;url=undefined">Tweet about it too</a> so I can take your suggestions and improve on it.</p><hr style="margin-bottom:1.58rem"/><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li></li><li></li></ul></main><footer style="margin-top:3.16rem">Built with <span role="img" class="emoji">💻</span> and <span role="img" class="emoji">❤️</span> • <a href="/notes">notes</a> • <a href="https://twitter.com/lihautan">twitter</a> • <a href="https://github.com/tanhauhau">github</a> • <a href="https://github.com/tanhauhau/tanhauhau.github.io/issues/new?assignees=&amp;labels=grammar%2C+typo&amp;template=fix-typos-and-grammars.md&amp;title=%5BTYPO%5D">discuss</a></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-135921142-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/writing-your-own-module-bundler/";window.webpackCompilationHash="b053f9a9377ab371c732";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-aff19638c33f24dd1a38.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-7e2f16b57f11ba82672c.js"],"component---src-templates-note-post-js":["/component---src-templates-note-post-js-f82879d8f28164bc7e86.js"],"component---src-templates-talk-post-js":["/component---src-templates-talk-post-js-56e9ff31906d8de5db73.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-3344a3abd0492eb674d1.js"],"component---src-pages-404-js":["/component---src-pages-404-js-cd68818fa1fba6728cb6.js"],"component---src-pages-blogs-js":["/component---src-pages-blogs-js-ae1884ddebc9fe4f810c.js"],"component---src-pages-index-js":["/component---src-pages-index-js-b7ae6d07197ed2dc4ddf.js"],"component---src-pages-notes-js":["/component---src-pages-notes-js-d0ce6c763fd241b9575b.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-131cc7483942dbe20000.js"],"component---src-pages-talks-js":["/component---src-pages-talks-js-bb4fc97bafc2f9f34977.js"]};/*]]>*/</script><script src="/webpack-runtime-bac7fb22492d2147b953.js" async=""></script><script src="/styles-0bf1084b9cad04e11a70.js" async=""></script><script src="/app-aff19638c33f24dd1a38.js" async=""></script><script src="/1-d685488249c35c265129.js" async=""></script><script src="/component---src-templates-blog-post-js-3344a3abd0492eb674d1.js" async=""></script></body></html>