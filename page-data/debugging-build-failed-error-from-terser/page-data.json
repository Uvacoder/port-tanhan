{"componentChunkName":"component---src-templates-blog-post-js","path":"/debugging-build-failed-error-from-terser/","result":{"data":{"site":{"siteMetadata":{"title":"Tan Li Hau","author":"Tan Li Hau"}},"markdownRemark":{"id":"b32b81aa-3d4f-5b87-a321-e214c78063f6","excerpt":"","html":"<p>The following is a record of the steps I went through when debugging a build-time bug I encountered during work.</p>\n<p>It all started with an error message during the build.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ERROR in bundle.xxxx.js from Terser\nundefined\n\n...\n\nCommand failed with exit code 2\nVisit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\nError: Command failed: yarn build</code></pre></div>\n<p>What is wrong with Terser and our code?</p>\n<p><strong>I must find the root cause of this!</strong></p>\n<h2 id=\"act-i---the-first-attempt\"><a href=\"#act-i---the-first-attempt\" aria-label=\"act i   the first attempt permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Act I - The First Attempt</h2>\n<p>We used Terser to minify our build code. It was part of our webpack pipeline, installed through <code class=\"language-text\">terser-webpack-plugin</code>. Since terser is throwing an error, so I disabled <code class=\"language-text\">terser-webpack-plugin</code> and build again.</p>\n<p class=\"filename\">webpackConfig.prod.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token comment\">// disable terser first</span>\n    <span class=\"token comment\">// new TerserPlugin({</span>\n    <span class=\"token comment\">// \tterserOptions: {</span>\n    <span class=\"token comment\">//     // ...</span>\n    <span class=\"token comment\">//   },</span>\n    <span class=\"token comment\">// }),</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Ok. The build was successful. Nothing wrong with the code nor the build.</p>\n<p>So, I run the terser manually:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> terser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'terser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> input <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>\n  path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist/bundle.xxxx.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'utf-8'</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> terser<span class=\"token punctuation\">.</span><span class=\"token function\">minify</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...terser options</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The console output an error that was cryptic</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  &quot;error&quot;:\n  TypeError: Cannot read property &#39;name&#39; of undefined\n      at A.f (node_modules/terser/dist/bundle.js:44:146028)\n      at D (node_modules/terser/dist/bundle.js:44:2863)\n      at A (node_modules/terser/dist/bundle.js:44:146075)\n      at k (node_modules/terser/dist/bundle.js:44:146998)\n      at vn (node_modules/terser/dist/bundle.js:44:133003)\n      at node_modules/terser/dist/bundle.js:44:165250\n      at AST_BlockStatement.optimize (node_modules/terser/dist/bundle.js:44:121400)\n      at Ct.before (node_modules/terser/dist/bundle.js:44:121157)\n      at AST_BlockStatement.transform (node_modules/terser/dist/bundle.js:44:78200)\n      at node_modules/terser/dist/bundle.js:44:78849\n}</code></pre></div>\n<p>I clicked into the terser source code to see what was going wrong over there. <em>(Maybe it’s my chance to contribute to terser?)</em></p>\n<p>Little did I know, how wrong I could be.</p>\n<p><code class=\"language-text\">terser/dist/bundle.js</code> was a minified code and it wasn’t meant for humans eyes <span class=\"emoji\">😭</span></p>\n<p>Allow me to share a small snippet of what I saw:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\ns) } else if (u instanceof Se &amp;&amp; r === u.expression &amp;&amp; (p(e, t, i, u, o = n(o, u.property), a + 1,\n  s + 1), o)) return; a &gt; 0 || u instanceof Be &amp;&amp; r !== u.tail_node() || u instanceof S ||\n(t.direct_access = !0) } e(F, u); var d = new qn(function (e) { if (e instanceof Je) { var n =\ne.definition(); n &amp;&amp; (e instanceof hn &amp;&amp; n.references.push(e), n.fixed = !1) } }); function h(e, n,\nt) { this.inlined = !1; var r = e.safe_ids; return e.safe_ids = Object.create(null), i(e, t, this),\nn(), e.safe_ids = r, !0 } function m(e, n, t) { var r, o = this; return o.inlined = !1, a(e), i(e,\nt, o), !o.name &amp;&amp; (r = e.parent()) instanceof ke &amp;&amp; r.expression === o &amp;&amp; o.argnames.forEach(\nfunction (n, t) { if (n.definition) { var i = n.definition(); void 0 !== i.fixed || o.uses_arguments\n&amp;&amp; !e.has_directive(&quot;use strict&quot;) ? i.fixed = !1 : (i.fixed = function () { return r.args[t] || v(kn, r)\n...</code></pre></div>\n<p>At this point in time, I had another meeting to attend, so I stopped at this juncture.</p>\n<p>On my way there, I was thinking, well, maybe I should probe this later in another direction.</p>\n<h2 id=\"act-ii---terser-webpack-plugin\"><a href=\"#act-ii---terser-webpack-plugin\" aria-label=\"act ii   terser webpack plugin permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Act II - terser-webpack-plugin</h2>\n<p>After the meeting, I was thinking, well let me reenable the terser plugin, and try to probe through the plugin.</p>\n<p>Remember the error message: <code class=\"language-text\">&quot;ERROR in bundle.xxxx.js from Terser&quot;</code> ?</p>\n<p>I looked into the <code class=\"language-text\">node_modules/terser-webpack/plugin/dist/index.js</code> and search for the word <code class=\"language-text\">&quot;from Terser&quot;</code>.</p>\n<p><strong>Tip:</strong> Usually when you want to debug a library installed in <code class=\"language-text\">node_modules</code>, you can first look at the <code class=\"language-text\">package.json</code>, it usually has an entry called <code class=\"language-text\">&quot;main&quot;</code> that tells you the entry file to first look into. The main file usually exports all the public API that you use, so it is a good place to start diving into.</p>\n<p>So I found the line:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>file<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> from Terser\\n</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>err<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>After adding logs <code class=\"language-text\">console.log(err)</code> and run the build again, I realised the err is an empty object <code class=\"language-text\">{}</code>, which explained why I saw <code class=\"language-text\">undefined</code> after the <code class=\"language-text\">ERROR in ... from Terser</code>.</p>\n<p>So, I slowly traced back the caller, and find out where this <code class=\"language-text\">err</code> object was initially created.</p>\n<p><strong>Tip:</strong> To trace the callers of a function that leads up to a certain state of your application, you can:</p>\n<ul>\n<li>Use a <a href=\"https://blittle.github.io/chrome-dev-tools/sources/conditional-breakpoints.html\">conditional breakpoint</a> if you are debugging through a debugger</li>\n<li>Throw an error within a try catch</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">someFunction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>someConditionThatLeadsToErrorLaterOn<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This is especially useful if you are tracing an unfamiliar code, you can quickly get a call stack that leads up to the current condition.</p>\n<p>After tracing through the call stack, I ended up at the line where the <code class=\"language-text\">terser-webpack-plugin</code> calls the terser, and when I logged out the error, it shows:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\n  &quot;error&quot;:\n  TypeError: Cannot read property &#39;name&#39; of undefined\n      at A.f (node_modules/terser/dist/bundle.js:44:146028)\n      at D (node_modules/terser/dist/bundle.js:44:2863)\n      at A (node_modules/terser/dist/bundle.js:44:146075)\n      at k (node_modules/terser/dist/bundle.js:44:146998)\n      at vn (node_modules/terser/dist/bundle.js:44:133003)\n      at node_modules/terser/dist/bundle.js:44:165250\n      at AST_BlockStatement.optimize (node_modules/terser/dist/bundle.js:44:121400)\n      at Ct.before (node_modules/terser/dist/bundle.js:44:121157)\n      at AST_BlockStatement.transform (node_modules/terser/dist/bundle.js:44:78200)\n      at node_modules/terser/dist/bundle.js:44:78849\n}</code></pre></div>\n<p>So familiar! After an hour of tracing and debugging, I ended up at the same place.</p>\n<p><strong>Note:</strong> the error must have lost somewhere from the terser to the actual print out of <code class=\"language-text\">terser-webpack-plugin</code>, it might have fixed in a later version of <code class=\"language-text\">terser-webpack-plugin</code>, but I’m not sure of it yet. Anyone interested can help check.</p>\n<h2 id=\"act-iii---terser\"><a href=\"#act-iii---terser\" aria-label=\"act iii   terser permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Act III - Terser</h2>\n<p>The circumstances left me with no choice. I needed to face the cryptic minified code.</p>\n<p>Luckily VSCode still able to open the huge minified file, and able to set the cursor to the right line and column:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> f <span class=\"token operator\">=</span> n<span class=\"token punctuation\">.</span><span class=\"token function\">option</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ecma\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">6</span> <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token punctuation\">.</span><span class=\"token function\">has_directive</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"use strict\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span>\n<span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">.</span>key<span class=\"token operator\">!=</span>u <span class=\"token operator\">&amp;&amp;</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">.</span>name<span class=\"token operator\">!=</span>u <span class=\"token punctuation\">}</span>\n                                        <span class=\"token operator\">^</span></code></pre></div>\n<p>(By the way, in the minified code, all the code is in one line. <span class=\"emoji\">🤦‍♂️</span>)</p>\n<p>Well, this may seem like the right place to throw the <code class=\"language-text\">&quot;Cannot read property &#39;name&#39; of undefined&quot;</code> error.</p>\n<p>To understand what is going on in this line, I cloned <a href=\"https://github.com/terser/terser\">terser</a>, checked out to the version tag that was installed in our codebase, and tried to figure out where that line was in the original code.</p>\n<p><strong>Tip:</strong> String, property and method names are usually the best marker to trace a <a href=\"http://lisperator.net/uglifyjs/mangle\">mangled code</a>. Even though all the variables have mangled into a single character variable name, you can still clearly see the method <code class=\"language-text\">has_directive()</code> and the string <code class=\"language-text\">&quot;use strict&quot;</code>.</p>\n<p>Conversely, please don’t write long windy property / method names, it doesn’t mangle well.</p>\n<p>So I global searched the keyword <code class=\"language-text\">has_directive(&quot;use strict&quot;)</code> and landed with a small number of results, which I looked through every one of them and ended up with the following line:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> diff <span class=\"token operator\">=</span>\n  compressor<span class=\"token punctuation\">.</span><span class=\"token function\">option</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ecma'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">6</span> <span class=\"token operator\">&amp;&amp;</span> compressor<span class=\"token punctuation\">.</span><span class=\"token function\">has_directive</span><span class=\"token punctuation\">(</span><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">?</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">.</span>key <span class=\"token operator\">!=</span> prop <span class=\"token operator\">&amp;&amp;</span> node<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">.</span>name <span class=\"token operator\">!=</span> prop<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">.</span>name <span class=\"token operator\">!=</span> prop<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Which I was and still am clueless of what this code was trying to do.</p>\n<p>So I did the most reasonable thing, add a <code class=\"language-text\">console.log(node)</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> f <span class=\"token operator\">=</span> n<span class=\"token punctuation\">.</span><span class=\"token function\">option</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ecma\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">6</span> <span class=\"token operator\">&amp;&amp;</span> n<span class=\"token punctuation\">.</span><span class=\"token function\">has_directive</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"use strict\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span>\n<span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">return</span> e<span class=\"token punctuation\">.</span>key<span class=\"token operator\">!=</span>u\n               <span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span><span class=\"token operator\">^</span>\n<span class=\"token operator\">&amp;&amp;</span> e<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">.</span>name<span class=\"token operator\">!=</span>u <span class=\"token punctuation\">}</span></code></pre></div>\n<p>I found out that the <code class=\"language-text\">node</code> is an object, that does not have a property <code class=\"language-text\">key</code>, which explains the error. And <code class=\"language-text\">node</code> has a property call <code class=\"language-text\">name</code> that has a value <code class=\"language-text\">&quot;foobar&quot;</code>, which I assumed is a variable name in our codebase. Luckily <code class=\"language-text\">foobar</code> wasn’t commonly used in our codebase, and I managed to find only 1 instance of it, and astonishingly, the code was last changed 1 year ago!</p>\n<p>So Terser just decided to break, without a sign, on a line of code that was written 1 year ago. This is the life of a programmer.</p>\n<h2 id=\"final-act---the-resolution\"><a href=\"#final-act---the-resolution\" aria-label=\"final act   the resolution permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final Act - The Resolution</h2>\n<p>I kind of concluded that the root cause was a Terser bug, (because I can’t just change the code that wasn’t touched for nearly 1 year for no good reason), so the obvious thing to do next was to figured out whether someone fixed it on Terser upstream.</p>\n<p>So, I checked out the master branch of Terser, found out the code has changed to</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> diff <span class=\"token operator\">=</span> compressor<span class=\"token punctuation\">.</span><span class=\"token function\">option</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ecma\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">2015</span>\n    <span class=\"token operator\">&amp;&amp;</span> compressor<span class=\"token punctuation\">.</span><span class=\"token function\">has_directive</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"use strict\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">.</span>key <span class=\"token operator\">!=</span> prop <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>key <span class=\"token operator\">&amp;&amp;</span> node<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">.</span>name <span class=\"token operator\">!=</span> prop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">.</span>key <span class=\"token operator\">&amp;&amp;</span> node<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">.</span>name <span class=\"token operator\">!=</span> prop<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">node.key</code> is checked to be existed before checking <code class=\"language-text\">node.key.name</code>. What a simple patch!</p>\n<p>The next thing I needed to figure out was when was this fix landed, whether I can upgrade it.</p>\n<p>The Terser in the codebase was one major version behind the latest Terser version, so, I was more reserved to upgrade to the latest version.</p>\n<p>The git blame for the line of code was for some code refactoring, so I went to Github to trace the blame.</p>\n<p><strong>Tip:</strong> Github blame has this very useful button, that allows you to view blame prior to the change.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f8cd119b358f913a6b645894f8bc9c35/51843/github%20blame.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.58515283842795%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAA6UlEQVQY022QzW7CMBCE8/6vQhFqL6U3oEoblceIEJxI4h8M3nWmuw5BIe1KY1s+fDOzRV3XMMaILLrOoGlatG2X5ZxHjATvPRIz5pNCQCLK777vs4p9VeJ4PGWdz00GKdg5l0F6O2tRH05YLFdYvb5h8bLE+/pjMLxFkEAVlpIAraRjcSdi+cTfFCnJQdlssytRfn1ju/tEVf3AizHZibEYFHPAGH3UQOVBk2FJ4wM9VvGorAnmgCfoHcgxwl8CWOppTd0tc8o1lTFyiink37R3YKKIq0B6XY9Uu7gbgotw3RXWeFipria/2/TQXXvYKcwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Github: view blame prior to the change\"\n        title=\"Github: view blame prior to the change\"\n        src=\"/static/f8cd119b358f913a6b645894f8bc9c35/799d3/github%20blame.png\"\n        srcset=\"/static/f8cd119b358f913a6b645894f8bc9c35/00d96/github%20blame.png 148w,\n/static/f8cd119b358f913a6b645894f8bc9c35/0b23c/github%20blame.png 295w,\n/static/f8cd119b358f913a6b645894f8bc9c35/799d3/github%20blame.png 590w,\n/static/f8cd119b358f913a6b645894f8bc9c35/2a3d6/github%20blame.png 885w,\n/static/f8cd119b358f913a6b645894f8bc9c35/51843/github%20blame.png 916w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>A few blame traces later, I ended up with a commit that fixed the bug:</p>\n<blockquote>\n<p><a href=\"https://github.com/terser/terser/pull/286\">fix node.key crashing lib/compress by hytromo · Pull Request #286 · terser/terser</a></p>\n</blockquote>\n<p>By looking at the MR merged date, I found that the commit was landed in between <a href=\"https://github.com/terser/terser/compare/v3.16.0...v3.17.0\">v3.16.0 and v3.17.0</a>.</p>\n<p>v3.17.0 was a minor version bump for our codebase, so I assumed it has no breaking changes.</p>\n<p><code class=\"language-text\">terser</code> was installed as a dependency of <code class=\"language-text\">terser-webpack-plugin</code>, which we had no control on the terser version, so I added a resolution to our <code class=\"language-text\">package.json</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"resolution\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"terser\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.17.0\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>After I upgraded terser, I build the code again.</p>\n<p>The build was successful! <span class=\"emoji\">🎉</span></p>\n<h2 id=\"closing-note\"><a href=\"#closing-note\" aria-label=\"closing note permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Closing Note</h2>\n<p>As I was explaining all these to my colleague, I realised that should I upgraded the terser once I found out that it was a terser error, it would have fixed the bug as well. I wouldn’t need to go through all these to end up in the same fix.</p>\n<p>Oh well. <span class=\"emoji\">🤷‍♂️</span></p>","fields":{"slug":"/debugging-build-failed-error-from-terser/","wip":false},"frontmatter":{"title":"Debugging Story: Build failed, error from Terser","date":"January 08, 2020","lastUpdated":null,"description":"It all started with an error message during the build: 'ERROR in bundle.xxx.js from Terser'.","tags":"debugging"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/debugging-build-failed-error-from-terser/","type":"blog","noteDate":null,"noteTitle":null,"wip":false,"heroImageUrl":null,"heroTwitterImageUrl":"/static/hero-twitter-bae704a56402e1389ab38285fdc33c89.jpg","previous":{"id":"9f2513a5-449b-5eb9-b0cf-cf449bf16288","fields":{"slug":"/reactivity-in-web-frameworks-the-when/","type":"blog","noteDate":null,"noteTitle":null,"wip":false},"frontmatter":{"title":"Reactivity in Web Frameworks (Part 1)"}},"next":{"id":"1bea80d4-7278-5453-b8f5-e2873de1800b","fields":{"slug":"/webpack-plugin-main-template/","type":"blog","noteDate":null,"noteTitle":null,"wip":false},"frontmatter":{"title":"Webpack's TemplatePlugin"}}}}}