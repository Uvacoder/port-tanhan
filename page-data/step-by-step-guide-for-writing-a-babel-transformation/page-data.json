{"componentChunkName":"component---src-templates-blog-post-js","path":"/step-by-step-guide-for-writing-a-babel-transformation/","webpackCompilationHash":"d240442f94aec6f203b8","result":{"data":{"site":{"siteMetadata":{"title":"Tan Li Hau","author":"Tan Li Hau"}},"markdownRemark":{"id":"8f729c93-ad1b-5fa5-bcb2-d6199b2c797f","excerpt":"","html":"<p>Today, I will share a step-by-step guide for writing a custom <a href=\"https://babeljs.io/docs/en/babel-core\">babel</a> transformation. You can use this technique to write your own automated code modifications, refactoring and code generation.</p>\n<h2 id=\"what-is-babel\"><a href=\"#what-is-babel\" aria-label=\"what is babel permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is babel?</h2>\n<p><a href=\"https://babeljs.io/docs/en/\">Babel</a> is a JavaScript compiler that is mainly used to convert ECMAScript 2015+ code into backward compatible version of JavaScript in current and older browsers or environments. Babel uses a <a href=\"https://babeljs.io/docs/en/plugins\">plugin system</a> to do code transformation, so anyone can write their own transformation plugin for babel.</p>\n<p>Before you get started writing a transformation plugin for babel, you would need to know what is an <a href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\">Abstract Syntax Tree (AST)</a>.</p>\n<h3 id=\"what-is-abstract-syntax-tree-ast\"><a href=\"#what-is-abstract-syntax-tree-ast\" aria-label=\"what is abstract syntax tree ast permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is Abstract Syntax Tree (AST)?</h3>\n<p>I am not sure I can explain this better than the amazing articles out there on the web:</p>\n<ul>\n<li><a href=\"https://medium.com/basecs/leveling-up-ones-parsing-game-with-asts-d7a6fc2400ff\">Leveling Up One‚Äôs Parsing Game With ASTs</a> by <a href=\"https://twitter.com/vaidehijoshi\">Vaidehi Joshi\n</a> * <em>(Highly recommend this one! <span class=\"emoji\">üëç</span>)</em></li>\n<li>Wikipedia‚Äôs <a href=\"https://en.wikipedia.org/wiki/Abstract_syntax_tree\">Abstract syntax tree</a></li>\n<li><a href=\"https://blog.bitsrc.io/what-is-an-abstract-syntax-tree-7502b71bde27\">What is an Abstract Syntax Tree\n</a> by <a href=\"https://twitter.com/ngArchangel\">Chidume Nnamdi</a></li>\n</ul>\n<p>To summarize, AST is a tree representation of your code. In the case of JavaScript, the JavaScript AST follows the <a href=\"https://github.com/estree/estree\">estree specification</a>.</p>\n<p>AST represents your code, the structure and the meaning of your code. So it allows the compiler like <a href=\"https://babeljs.io\">babel</a> to understand the code and make specific meaningful transformation to it.</p>\n<p>So now you know what is AST, let‚Äôs write a custom babel transformation to modify your code using AST.</p>\n<h2 id=\"how-to-use-babel-to-transform-code\"><a href=\"#how-to-use-babel-to-transform-code\" aria-label=\"how to use babel to transform code permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How to use babel to transform code</h2>\n<p>The following is the general template of using babel to do code transformation:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> parse <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@babel/parser'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> traverse <span class=\"token keyword\">from</span> <span class=\"token string\">'@babel/traverse'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> generate <span class=\"token keyword\">from</span> <span class=\"token string\">'@babel/generator'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> <span class=\"token string\">'const n = 1'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// parse the code -> ast</span>\n<span class=\"token keyword\">const</span> ast <span class=\"token operator\">=</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// transform the ast</span>\n<span class=\"token function\">traverse</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">enter</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// in this example change all the variable `n` to `x`</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">isIdentifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">'n'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'x'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// generate code &lt;- ast</span>\n<span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> <span class=\"token function\">generate</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 'const x = 1;'</span></code></pre></div>\n<blockquote>\n<p>You would need to install <a href=\"https://www.npmjs.com/package/@babel/core\">@babel/core</a> to run this. <code class=\"language-text\">@babel/parser</code>, <code class=\"language-text\">@babel/traverse</code>, <code class=\"language-text\">@babel/generator</code> are all dependencies of <code class=\"language-text\">@babel/core</code>, so installing <code class=\"language-text\">@babel/core</code> would suffice.</p>\n</blockquote>\n<p>So the general idea is to parse your code to AST, transform the AST, and then generate code from the transformed AST.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">code -&gt; AST -&gt; transformed AST -&gt; transformed code</code></pre></div>\n<p>However, we can use another API from <code class=\"language-text\">babel</code> to do all the above:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> babel <span class=\"token keyword\">from</span> <span class=\"token string\">'@babel/core'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> <span class=\"token string\">'const n = 1'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> babel<span class=\"token punctuation\">.</span><span class=\"token function\">transformSync</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\">// your first babel plugin üòéüòé</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">myCustomPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        visitor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">Identifier</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// in this example change all the variable `n` to `x`</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">isIdentifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">'n'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'x'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 'const x = 1;'</span></code></pre></div>\n<p>Now, you have written your first <a href=\"https://babeljs.io/docs/en/plugins\">babel tranform plugin</a> that replace all variable named <code class=\"language-text\">n</code> to <code class=\"language-text\">x</code>, how cool is that?!</p>\n<blockquote>\n<p>Extract out the function <code class=\"language-text\">myCustomPlugin</code> to a new file and export it. <a href=\"https://medium.com/@bretcameron/how-to-publish-your-first-npm-package-b224296fc57b\">Package and publish your file as a npm package</a> and you can proudly say you have published a babel plugin! <span class=\"emoji\">üéâ</span><span class=\"emoji\">üéâ</span></p>\n</blockquote>\n<p>At this point, you must have thought: <em>‚ÄúYes I‚Äôve just written a babel plugin, but I have no idea how it works‚Ä¶‚Äù</em>, so fret not, let‚Äôs dive in on how you can write the babel transformation plugin yourself!</p>\n<p>So, here is the step-by-step guide to do it:</p>\n<h3 id=\"1-have-in-mind-what-you-want-to-transform-from-and-transform-into\"><a href=\"#1-have-in-mind-what-you-want-to-transform-from-and-transform-into\" aria-label=\"1 have in mind what you want to transform from and transform into permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Have in mind what you want to transform from and transform into</h3>\n<p>In this example, I want to prank my colleague by creating a babel plugin that will:</p>\n<ul>\n<li>reverse all the variables‚Äô and functions‚Äô names</li>\n<li>split out string into individual characters</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">greet</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token string\">'Hello '</span> <span class=\"token operator\">+</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">greet</span><span class=\"token punctuation\">(</span><span class=\"token string\">'tanhauhau'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Hello tanhauhau</span></code></pre></div>\n<p>into</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">teerg</span><span class=\"token punctuation\">(</span>eman<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token string\">'H'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'e'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'l'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'l'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'o'</span> <span class=\"token operator\">+</span> <span class=\"token string\">' '</span> <span class=\"token operator\">+</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">teerg</span><span class=\"token punctuation\">(</span><span class=\"token string\">'t'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'n'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'h'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'u'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'h'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'a'</span> <span class=\"token operator\">+</span> <span class=\"token string\">'u'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Hello tanhauhau</span></code></pre></div>\n<p>Well, we have to keep the <code class=\"language-text\">console.log</code>, so that even the code is hardly readable, it is still working fine. <em>(I wouldn‚Äôt want to break the production code!)</em></p>\n<h3 id=\"2-know-what-to-target-on-the-ast\"><a href=\"#2-know-what-to-target-on-the-ast\" aria-label=\"2 know what to target on the ast permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Know what to target on the AST</h3>\n<p>Head down to a <a href=\"https://lihautan.com/babel-ast-explorer/#?eyJiYWJlbFNldHRpbmdzIjp7InZlcnNpb24iOiI3LjQuNSJ9LCJ0cmVlU2V0dGluZ3MiOnsiaGlkZUVtcHR5Ijp0cnVlLCJoaWRlTG9jYXRpb24iOnRydWUsImhpZGVUeXBlIjp0cnVlfSwiY29kZSI6ImZ1bmN0aW9uIGdyZWV0KG5hbWUpIHtcbiAgcmV0dXJuICdIZWxsbyAnICsgbmFtZTtcbn1cblxuY29uc29sZS5sb2coZ3JlZXQoJ3RhbmhhdWhhdScpKTsgLy8gSGVsbG8gdGFuaGF1aGF1In0=\">babel AST explorer</a>, click on different parts of the code and see where / how it is represented on the AST:</p>\n<p>\n  <a class=\"gatsby-resp-image-link\" href=\"/static/0cf3ccd0d3c0a243103feadfdf5c1dd9/bb144/targeting.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <figure class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 15.703124999999998%; position: relative; bottom: 0; left: 0; background-image: url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAkklEQVQI11WOSwrCQBBEcxl14cJDe6as/UBEE53MJEaZXz87A0YseF10QxdVNZeG9nrDtB2vaSLnTEqpuIgsHn3GPJ50052QrN4GxRVydsCItQ2VMQavAcEH5O2JIWhgLEE/xTJ92NOPa3ze6rZBlOIy+wrndlTW2uVN+Nfc7Mus99DTm5okB91Oej8uwFkb1nwAho7jcU+LmikAAAAASUVORK5CYII=&#x27;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\" alt=\"targeting\" title=\"Selecting the code on the left and see the corresponding part of the AST light up on the right\" src=\"/static/0cf3ccd0d3c0a243103feadfdf5c1dd9/623ee/targeting.png\" srcset=\"/static/0cf3ccd0d3c0a243103feadfdf5c1dd9/816c5/targeting.png 148w, /static/0cf3ccd0d3c0a243103feadfdf5c1dd9/c766b/targeting.png 295w, /static/0cf3ccd0d3c0a243103feadfdf5c1dd9/623ee/targeting.png 590w, /static/0cf3ccd0d3c0a243103feadfdf5c1dd9/e5345/targeting.png 885w, /static/0cf3ccd0d3c0a243103feadfdf5c1dd9/7a439/targeting.png 1180w, /static/0cf3ccd0d3c0a243103feadfdf5c1dd9/84fe0/targeting.png 1770w, /static/0cf3ccd0d3c0a243103feadfdf5c1dd9/bb144/targeting.png 2560w\" sizes=\"(max-width: 590px) 100vw, 590px\">\n    </span>\n  <figcaption>Selecting the code on the left and see the corresponding part of the AST light up on the right</figcaption></figure>\n  \n  </a>\n    </p>\n<p>If this is your first time seeing the AST, play around with it for a little while and get the sense of how is it look like, and get to know the names of the node on the AST with respect to your code.</p>\n<p>So, now we know that we need to target:</p>\n<ul>\n<li><strong>Identifier</strong> for variable and function names</li>\n<li><strong>StringLiteral</strong> for the string.</li>\n</ul>\n<h3 id=\"3-know-how-the-transformed-ast-looks-like\"><a href=\"#3-know-how-the-transformed-ast-looks-like\" aria-label=\"3 know how the transformed ast looks like permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Know how the transformed AST looks like</h3>\n<p>Head down to the <a href=\"https://lihautan.com/babel-ast-explorer/#?eyJiYWJlbFNldHRpbmdzIjp7InZlcnNpb24iOiI3LjQuNSJ9LCJ0cmVlU2V0dGluZ3MiOnsiaGlkZUVtcHR5Ijp0cnVlLCJoaWRlTG9jYXRpb24iOnRydWUsImhpZGVUeXBlIjp0cnVlfSwiY29kZSI6ImZ1bmN0aW9uIHRlZXJnKGVtYW4pIHtcbiAgcmV0dXJuIFwiSFwiICsgXCJlXCIgKyBcImxcIiArIFwibFwiICsgXCJvXCIgKyBcIiBcIiArIG5hbWU7XG59XG5cbmNvbnNvbGUubG9nKHRlZXJnKFwidFwiICsgXCJhXCIgKyBcIm5cIiArIFwiaFwiICsgXCJhXCIgKyBcInVcIiArIFwiaFwiICsgXCJhXCIgKyBcInVcIikpOyAvLyBIZWxsbyB0YW5oYXVoYXVcbiJ9\">babel AST explorer</a> again, but this time around with the output code you want to generate.</p>\n<p>\n  <a class=\"gatsby-resp-image-link\" href=\"/static/088670a60cdd8a18da5d8ec1b1cfb316/bb144/output.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <figure class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 40.703125%; position: relative; bottom: 0; left: 0; background-image: url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABEklEQVQoz5VQwU6EMBTsn5l48uLJH9J4MPG3/AUTD4YlILSQVaGwu7S0r+ODosTVTfQlkwkzbwZ44uExR7pJkCQJiqKAlBJlWaJklkpBKYlCKjxnEnmW4ymVSJk3eYkk4z3OVHWNmjFlRFUpNE2LXdfDDwZkR4zMjhmeQM6BiDCNd0C/9xhcwG+jtYZo2xaT7TkUQkCgsDJr5P1cOGngzcPBo341UNpiZ/ysRQ8wxsbC4wkLvmlhDY6WoN4sXpoR+zEsftz7KvwMnMJaHH+fXI3t+xW23QW//JyVM/YufxaemtWn5WtSvrPAYAQXCl5gZvy58HiHvEav72Dpmp9uWb9h3P+vcL1VmLnnaNMt9w7R+wCsrWcHGmJ/agAAAABJRU5ErkJggg==&#x27;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\" alt=\"output\" title=\"You can see that what used to be a &#x60;StringLiteral&#x60; is now a nested &#x60;BinaryExpression&#x60;\" src=\"/static/088670a60cdd8a18da5d8ec1b1cfb316/623ee/output.png\" srcset=\"/static/088670a60cdd8a18da5d8ec1b1cfb316/816c5/output.png 148w, /static/088670a60cdd8a18da5d8ec1b1cfb316/c766b/output.png 295w, /static/088670a60cdd8a18da5d8ec1b1cfb316/623ee/output.png 590w, /static/088670a60cdd8a18da5d8ec1b1cfb316/e5345/output.png 885w, /static/088670a60cdd8a18da5d8ec1b1cfb316/7a439/output.png 1180w, /static/088670a60cdd8a18da5d8ec1b1cfb316/84fe0/output.png 1770w, /static/088670a60cdd8a18da5d8ec1b1cfb316/bb144/output.png 2560w\" sizes=\"(max-width: 590px) 100vw, 590px\">\n    </span>\n  <figcaption>You can see that what used to be a `StringLiteral` is now a nested `BinaryExpression`</figcaption></figure>\n  \n  </a>\n    </p>\n<p>Play around and think how you can transform from the previous AST to the current AST.</p>\n<p>For example, you can see that <code class=\"language-text\">&#39;H&#39; + &#39;e&#39; + &#39;l&#39; + &#39;l&#39; + &#39;o&#39; + &#39; &#39; + name</code> is formed by nested <code class=\"language-text\">BinaryExpression</code> with <code class=\"language-text\">StringLiteral</code>.</p>\n<h3 id=\"4-write-code\"><a href=\"#4-write-code\" aria-label=\"4 write code permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Write code</h3>\n<p>Now look at our code again:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">myCustomPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    visitor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">Identifier</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token comment\">// ...</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The transformation uses <a href=\"https://en.wikipedia.org/wiki/Visitor_pattern\">the visitor pattern</a>.</p>\n<p>During the traversal phase, babel will do a <a href=\"https://en.wikipedia.org/wiki/Depth-first_search\">depth-first search traversal</a> and visit each node in the AST. You can specify a callback method in the visitor, such that while visiting the node, babel will call the callback method with the node it is currently visiting.</p>\n<p>In the visitor object, you can specify the name of the node you want to be <code class=\"language-text\">callback</code>ed:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">myCustomPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    visitor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">Identifier</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'identifier'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">StringLiteral</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'string literal'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Run it and you will see that ‚Äústring literal‚Äù and ‚Äúidentifier‚Äù is being called whenever babel encounters it:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">identifier\nidentifier\nstring literal\nidentifier\nidentifier\nidentifier\nidentifier\nstring literal</code></pre></div>\n<hr>\n<p>Before we continue, let‚Äôs look at the parameter of <code class=\"language-text\">Identifer(path) {}</code>. It says <code class=\"language-text\">path</code> instead of <code class=\"language-text\">node</code>, what is the difference between <code class=\"language-text\">path</code> and <code class=\"language-text\">node</code>? <span class=\"emoji\">ü§∑</span>‚Äç</p>\n<p>In babel, <code class=\"language-text\">path</code> is an abstraction above <code class=\"language-text\">node</code>, it provides the link between nodes, ie the <code class=\"language-text\">parent</code> of the node, as well as information such as the <code class=\"language-text\">scope</code>, <code class=\"language-text\">context</code>, etc. Besides, the <code class=\"language-text\">path</code> provides method such as <code class=\"language-text\">replaceWith</code>, <code class=\"language-text\">insertBefore</code>, <code class=\"language-text\">remove</code>, etc that will update and reflect on the underlying AST node.</p>\n<blockquote>\n<p>You can read more detail about <code class=\"language-text\">path</code> in <a href=\"https://jamie.build\">Jamie Kyle</a>‚Äôs <a href=\"https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md#paths\">babel handbook</a></p>\n</blockquote>\n<hr>\n<p>So let‚Äôs continue writing our babel plugin.</p>\n<h4 id=\"transforming-variable-name\"><a href=\"#transforming-variable-name\" aria-label=\"transforming variable name permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Transforming variable name</h4>\n<p>As we can see from the <a href=\"https://lihautan.com/babel-ast-explorer/#?eyJiYWJlbFNldHRpbmdzIjp7InZlcnNpb24iOiI3LjQuNSJ9LCJ0cmVlU2V0dGluZ3MiOnsiaGlkZUVtcHR5Ijp0cnVlLCJoaWRlTG9jYXRpb24iOnRydWUsImhpZGVUeXBlIjp0cnVlfSwiY29kZSI6ImZ1bmN0aW9uIGdyZWV0KG5hbWUpIHtcbiAgcmV0dXJuICdIZWxsbyAnICsgbmFtZTtcbn1cblxuY29uc29sZS5sb2coZ3JlZXQoJ3RhbmhhdWhhdScpKTsgLy8gSGVsbG8gdGFuaGF1aGF1In0=\">AST explorer</a>, the name of the <code class=\"language-text\">Identifier</code> is stored in the property called <code class=\"language-text\">name</code>, so what we will do is to reverse the <code class=\"language-text\">name</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">Identifier</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name\n    <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Run it and you will see:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">teerg</span><span class=\"token punctuation\">(</span>eman<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token string\">'Hello '</span> <span class=\"token operator\">+</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nelosnoc<span class=\"token punctuation\">.</span><span class=\"token function\">gol</span><span class=\"token punctuation\">(</span><span class=\"token function\">teerg</span><span class=\"token punctuation\">(</span><span class=\"token string\">'tanhauhau'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Hello tanhauhau</span></code></pre></div>\n<p>We are almost there, except we‚Äôve accidentally reversed <code class=\"language-text\">console.log</code> as well. How can we prevent that?</p>\n<p>Take a look at the AST again:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/487252cc6b3641879b1a606c5f7e6263/28bc2/member-expression.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 18.57025472473295%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAkUlEQVQY03WQTQ7CIBCFOUTdejwv68p4ABcmKootjbZAB3g+SVjQ6CRfZh7zw2SUuWkYfUdwDiklEovPOTckYq3gcu1xHjSG6cG6J3Mtag4LxHnE2WERxiKIUdBaJqlE/rWDGTewfkvVMdMVX1H4Y+sNC9+B7xP6cY9JDlRHvrco1v1sXg+tOjiA1+EJ6sftIh+AnTNCuyHZ5QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"member expression\"\n        title=\"\"\n        src=\"/static/487252cc6b3641879b1a606c5f7e6263/623ee/member-expression.png\"\n        srcset=\"/static/487252cc6b3641879b1a606c5f7e6263/816c5/member-expression.png 148w,\n/static/487252cc6b3641879b1a606c5f7e6263/c766b/member-expression.png 295w,\n/static/487252cc6b3641879b1a606c5f7e6263/623ee/member-expression.png 590w,\n/static/487252cc6b3641879b1a606c5f7e6263/e5345/member-expression.png 885w,\n/static/487252cc6b3641879b1a606c5f7e6263/7a439/member-expression.png 1180w,\n/static/487252cc6b3641879b1a606c5f7e6263/84fe0/member-expression.png 1770w,\n/static/487252cc6b3641879b1a606c5f7e6263/28bc2/member-expression.png 2434w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p><code class=\"language-text\">console.log</code> is part of the <code class=\"language-text\">MemberExpression</code>, with the <code class=\"language-text\">object</code> as <code class=\"language-text\">&quot;console&quot;</code> and <code class=\"language-text\">property</code> as <code class=\"language-text\">&quot;log&quot;</code>.</p>\n<p>So let‚Äôs check that if our current <code class=\"language-text\">Identifier</code> is within this <code class=\"language-text\">MemberExpression</code> and we will not reverse the name:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">Identifier</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>\n      path<span class=\"token punctuation\">.</span>parentPath<span class=\"token punctuation\">.</span><span class=\"token function\">isMemberExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n      path<span class=\"token punctuation\">.</span>parentPath\n        <span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">isIdentifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">'console'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n      path<span class=\"token punctuation\">.</span>parentPath<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'property'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isIdentifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">'log'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name\n     <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n     <span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n     <span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And yes, now you get it right!</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">teerg</span><span class=\"token punctuation\">(</span>eman<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token string\">'Hello '</span> <span class=\"token operator\">+</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">teerg</span><span class=\"token punctuation\">(</span><span class=\"token string\">'tanhauhau'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Hello tanhauhau</span></code></pre></div>\n<p>So, why do we have to check whether the <code class=\"language-text\">Identifier</code>‚Äôs parent is not a <code class=\"language-text\">console.log</code> <code class=\"language-text\">MemberExpression</code>? Why don‚Äôt we just compare whether the current <code class=\"language-text\">Identifier.name === &#39;console&#39; || Identifier.name === &#39;log&#39;</code>?</p>\n<p>You can do that, except that it will not reverse the variable name if it is named <code class=\"language-text\">console</code> or <code class=\"language-text\">log</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> log <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>So, how do I know the method <code class=\"language-text\">isMemberExpression</code> and <code class=\"language-text\">isIdentifier</code>? Well, all the node types specified in the <a href=\"https://babeljs.io/docs/en/babel-types\">@babel/types</a> have the <code class=\"language-text\">isXxxx</code> validator function counterpart, eg: <code class=\"language-text\">anyTypeAnnotation</code> function will have a <code class=\"language-text\">isAnyTypeAnnotation</code> validator. If you want to know the exhaustive list of the validator functions, you can head over <a href=\"https://github.com/babel/babel/blob/master/packages/babel-types/src/validators/generated/index.js\">to the actual source code</a>.</p>\n</blockquote>\n<h4 id=\"transforming-strings\"><a href=\"#transforming-strings\" aria-label=\"transforming strings permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Transforming strings</h4>\n<p>The next step is to generate a nested <code class=\"language-text\">BinaryExpression</code> out of <code class=\"language-text\">StringLiteral</code>.</p>\n<p>To create an AST node, you can use the utility function from <a href=\"https://babeljs.io/docs/en/babel-types\"><code class=\"language-text\">@babel/types</code></a>. <code class=\"language-text\">@babel/types</code> is also available via <code class=\"language-text\">babel.types</code> from <code class=\"language-text\">@babel/core</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">StringLiteral</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> newNode <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>value\n    <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">=></span> babel<span class=\"token punctuation\">.</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">stringLiteral</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>prev<span class=\"token punctuation\">,</span> curr<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> babel<span class=\"token punctuation\">.</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">binaryExpression</span><span class=\"token punctuation\">(</span><span class=\"token string\">'+'</span><span class=\"token punctuation\">,</span> prev<span class=\"token punctuation\">,</span> curr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  path<span class=\"token punctuation\">.</span><span class=\"token function\">replaceWith</span><span class=\"token punctuation\">(</span>newNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So, we split the content of the <code class=\"language-text\">StringLiteral</code>, which is in <code class=\"language-text\">path.node.value</code>, make each character a <code class=\"language-text\">StringLiteral</code>, and combine them with <code class=\"language-text\">BinaryExpression</code>. Finally, we replace the <code class=\"language-text\">StringLiteral</code> with the newly created node.</p>\n<p>‚Ä¶And that‚Äôs it! Except, we ran into Stack Overflow <span class=\"emoji\">üòÖ</span>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">RangeError: Maximum call stack size exceeded</code></pre></div>\n<p>Why <span class=\"emoji\">ü§∑</span>‚Äç ?</p>\n<p>Well, that‚Äôs because for each <code class=\"language-text\">StringLiteral</code> we created more <code class=\"language-text\">StringLiteral</code>, and in each of those <code class=\"language-text\">StringLiteral</code>, we are ‚Äúcreating‚Äù more <code class=\"language-text\">StringLiteral</code>. Although we will replace a <code class=\"language-text\">StringLiteral</code> with another <code class=\"language-text\">StringLiteral</code>, babel will treat it as a new node and will visit the newly created <code class=\"language-text\">StringLiteral</code>, thus the infinite recursive and stack overflow.</p>\n<p>So, how do we tell babel that once we replaced the <code class=\"language-text\">StringLiteral</code> with the <code class=\"language-text\">newNode</code>, babel can stop and don‚Äôt have to go down and visit the newly created node anymore?</p>\n<p>We can use <code class=\"language-text\">path.skip()</code> to skip traversing the children of the current path:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">StringLiteral</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> newNode <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>value\n    <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">=></span> babel<span class=\"token punctuation\">.</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">stringLiteral</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>prev<span class=\"token punctuation\">,</span> curr<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> babel<span class=\"token punctuation\">.</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">binaryExpression</span><span class=\"token punctuation\">(</span><span class=\"token string\">'+'</span><span class=\"token punctuation\">,</span> prev<span class=\"token punctuation\">,</span> curr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  path<span class=\"token punctuation\">.</span><span class=\"token function\">replaceWith</span><span class=\"token punctuation\">(</span>newNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  path<span class=\"token punctuation\">.</span><span class=\"token function\">skip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>‚Ä¶And yes it works now with now stack overflow!</p>\n<h2 id=\"summary\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<p>So, here we have it, our first code transformation with babel:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> babel <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/core'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`\nfunction greet(name) {\n  return 'Hello ' + name;\n}\nconsole.log(greet('tanhauhau')); // Hello tanhauhau\n`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> babel<span class=\"token punctuation\">.</span><span class=\"token function\">transformSync</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">myCustomPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        visitor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">StringLiteral</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> concat <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>value\n              <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">=></span> babel<span class=\"token punctuation\">.</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">stringLiteral</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>prev<span class=\"token punctuation\">,</span> curr<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> babel<span class=\"token punctuation\">.</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">binaryExpression</span><span class=\"token punctuation\">(</span><span class=\"token string\">'+'</span><span class=\"token punctuation\">,</span> prev<span class=\"token punctuation\">,</span> curr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            path<span class=\"token punctuation\">.</span><span class=\"token function\">replaceWith</span><span class=\"token punctuation\">(</span>concat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            path<span class=\"token punctuation\">.</span><span class=\"token function\">skip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token function\">Identifier</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n              <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>\n                path<span class=\"token punctuation\">.</span>parentPath<span class=\"token punctuation\">.</span><span class=\"token function\">isMemberExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n                path<span class=\"token punctuation\">.</span>parentPath\n                  <span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span>\n                  <span class=\"token punctuation\">.</span><span class=\"token function\">isIdentifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">'console'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n                path<span class=\"token punctuation\">.</span>parentPath<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'property'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isIdentifier</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">'log'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>name\n                <span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>A summary of the steps on how we get here:</p>\n<ol>\n<li>Have in mind what you want to transform from and transform into</li>\n<li>Know what to target on the AST</li>\n<li>Know how the transformed AST looks like</li>\n<li>Write code</li>\n</ol>\n<h2 id=\"further-resources\"><a href=\"#further-resources\" aria-label=\"further resources permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Further resources</h2>\n<p>If you are interested to learn more, <a href=\"https://github.com/babel/babel/tree/master/packages\">babel‚Äôs Github repo</a> is always the best place to find out more code examples of writing a babel transformation.</p>\n<p>Head down to <a href=\"https://github.com/babel/babel/tree/master/packages\">https://github.com/babel/babel</a>, and look for <code class=\"language-text\">babel-plugin-transform-*</code> or <code class=\"language-text\">babel-plugin-proposal-*</code> folders, they are all babel transformation plugin, where you can find code on how babel <a href=\"https://github.com/babel/babel/tree/master/packages/babel-plugin-proposal-nullish-coalescing-operator\">transform the nullish coalescing operator</a>, <a href=\"https://github.com/babel/babel/tree/master/packages/babel-plugin-proposal-optional-chaining\">optional chaining</a> and many more.</p>\n<h2 id=\"reference\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://babeljs.io/docs/en/\">Babel docs</a> & <a href=\"https://github.com/babel/babel\">Github repo</a></li>\n<li><a href=\"https://github.com/jamiebuilds/babel-handbook\">Babel Handbook</a> by <a href=\"https://jamie.build/\">Jamie Kyle</a></li>\n<li><a href=\"https://medium.com/basecs/leveling-up-ones-parsing-game-with-asts-d7a6fc2400ff\">Leveling Up One‚Äôs Parsing Game With ASTs</a> by <a href=\"https://twitter.com/vaidehijoshi\">Vaidehi Joshi</a></li>\n</ul>","fields":{"slug":"/step-by-step-guide-for-writing-a-babel-transformation/","wip":false},"frontmatter":{"title":"Step-by-step guide for writing a custom babel transformation","date":"September 12, 2019","lastUpdated":null,"description":"Writing your first babel plugin","tags":"JavaScript,babel,ast,transform"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/step-by-step-guide-for-writing-a-babel-transformation/","type":"blog","noteDate":null,"noteTitle":null,"wip":false,"heroImageUrl":"/static/hero-96557dac50c875b18c8a4a1c82325049.jpg","heroTwitterImageUrl":"/static/hero-twitter-3e34f2796c358a78de3ddac4ae215de8.jpg","previous":{"id":"38afd123-bfde-5298-a12a-b87ff898d7ff","fields":{"slug":"/commit-went-missing-after-rebase/","type":"blog","noteDate":null,"noteTitle":null,"wip":false},"frontmatter":{"title":"Git commits went missing after a rebase"}},"next":{"id":"832609b0-3ee6-5aff-9316-295e3b7ba273","fields":{"slug":"/solving-nonogram-with-code/","type":"blog","noteDate":null,"noteTitle":null,"wip":false},"frontmatter":{"title":"Solving Nonogram with Code"}}}}}