{"componentChunkName":"component---src-templates-blog-post-js","path":"/writing-your-own-module-bundler/","webpackCompilationHash":"","result":{"data":{"site":{"siteMetadata":{"title":"Tan Li Hau","author":"Tan Li Hau"}},"markdownRemark":{"id":"061049a8-c42d-5419-ade6-1069aa9cde28","excerpt":"","html":"<p>In my <a href=\"/what-is-module-bundler-and-how-does-it-work/\">previous article</a>, I explained how module bundler works. I used <a href=\"https://webpack.js.org\">webpack</a> and <a href=\"https://rollupjs.org\">rollup</a> as example, how each of them gave us a different perspective on how we can bundle our JavaScript application.</p>\n<p>In this article, I am going to show you how I wrote my module bundler. The module bundler itself is not production-ready, yet I learned a ton through the exercise, and I am ever more appreciative of what modern module bundlers have provided.</p>\n<hr>\n<p><span class=\"emoji\">‚ö†Ô∏è</span> <strong>Warning: Tons of JavaScript code ahead. <span class=\"emoji\">üôà</span><span class=\"emoji\">üò±</span><span class=\"emoji\">üò®</span></strong> <span class=\"emoji\">‚ö†Ô∏è</span></p>\n<hr>\n<h1 id=\"getting-started\"><a href=\"#getting-started\" aria-label=\"getting started permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Getting Started</h1>\n<p>I talked about the input (the JavaScript modules) and the output (the bundled JavaScript file) of a module bundler in <a href=\"/what-is-module-bundler-and-how-does-it-work/\">my previous article</a>. Now it‚Äôs time to write a module bundler that takes in the input and produces the output.</p>\n<p>A <em>basic</em> module bundler can be broken down into 2 parts:</p>\n<ul>\n<li>Understands the code and constructs the dependency graph <strong>(Dependency Resolution)</strong></li>\n<li>Assembles the module into a single (or multiple) JavaScript file <strong>(Bundle)</strong></li>\n</ul>\n<blockquote>\n<p>A <strong>dependency graph</strong> is a graph representation of the dependency relationship between modules.</p>\n</blockquote>\n<h2 id=\"the-input\"><a href=\"#the-input\" aria-label=\"the input permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Input</h2>\n<p>In this article, I will be using following files as my input to the bundler:</p>\n<p class=\"filename\">index.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> squareArea <span class=\"token keyword\">from</span> <span class=\"token string\">'./square.js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> circleArea <span class=\"token keyword\">from</span> <span class=\"token string\">'./circle.js'</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of square: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">squareArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of circle'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">circleArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p class=\"filename\">square.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>side<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> side <span class=\"token operator\">*</span> side<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> area<span class=\"token punctuation\">;</span></code></pre></div>\n<p class=\"filename\">circle.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">=</span> <span class=\"token number\">3.141</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>radius<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> radius <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> area<span class=\"token punctuation\">;</span></code></pre></div>\n<p>I‚Äôve created the project on <a href=\"https://github.com/tanhauhau/byo-bundler/tree/master/fixture\">Github</a>, so if you are interested to try out yourself, you can clone it and checkout the <code class=\"language-text\">fixture-1</code> tag. The input files are in the <code class=\"language-text\">fixture/</code> folder.</p>\n<h1 id=\"writing\"><a href=\"#writing\" aria-label=\"writing permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Writing</h1>\n<p>I started with the main structure of the module bundler:</p>\n<!-- prettier-ignore -->\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> entryFile<span class=\"token punctuation\">,</span> outputFolder <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// build dependency graph</span>\n  <span class=\"token keyword\">const</span> graph <span class=\"token operator\">=</span> <span class=\"token function\">createDependencyGraph</span><span class=\"token punctuation\">(</span>entryFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// bundle the asset</span>\n  <span class=\"token keyword\">const</span> outputFiles <span class=\"token operator\">=</span> <span class=\"token function\">bundle</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// write to output folder</span>\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> outputFile <span class=\"token keyword\">of</span> outputFiles<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>\n      path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>outputFolder<span class=\"token punctuation\">,</span> outputFile<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      outputFile<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n      <span class=\"token string\">'utf-8'</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>The <strong>dependency graph</strong> is a <a href=\"https://en.wikipedia.org/wiki/Directed_graph\">directed graph</a>, where the vertex is the module, and the directed edge is the dependency relationship between the modules.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createDependencyGraph</span><span class=\"token punctuation\">(</span>entryFile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> rootModule <span class=\"token operator\">=</span> <span class=\"token function\">createModule</span><span class=\"token punctuation\">(</span>entryFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> rootModule<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So, the entry module is ‚Äúthe root‚Äù of the graph.</p>\n<p>In <code class=\"language-text\">createModule</code>, I instantiate a new <code class=\"language-text\">Module</code> instance:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createModule</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Module</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The class <code class=\"language-text\">Module</code> will be used to record module properties, such as the content, the dependencies, exported keys, etc.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Module</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath <span class=\"token operator\">=</span> filePath<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dependencies <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>While the <code class=\"language-text\">content</code> is the string content of the module, to understand what it actually means, I used <a href=\"http://babeljs.io\">babel</a> to <em>parse the content</em> into AST (Abstract Syntax Tree):</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> babel <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@babel/core'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Module</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath <span class=\"token operator\">=</span> filePath<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast <span class=\"token operator\">=</span> babel<span class=\"token punctuation\">.</span><span class=\"token function\">parseSync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Next, I need to find out the dependency of this module:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Module</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath <span class=\"token operator\">=</span> filePath<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast <span class=\"token operator\">=</span> babel<span class=\"token punctuation\">.</span><span class=\"token function\">parseSync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dependencies <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token comment\">//</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>So, how can I know what are the dependencies of this module?</p>\n<p>I can look for the <code class=\"language-text\">import</code> statement from the AST with the help of the\n<a href=\"https://lihautan.com/babel-ast-explorer/#?eyJiYWJlbFNldHRpbmdzIjp7InZlcnNpb24iOiI3LjQuNSJ9LCJ0cmVlU2V0dGluZ3MiOnsiaGlkZUVtcHR5Ijp0cnVlLCJoaWRlTG9jYXRpb24iOnRydWUsImhpZGVUeXBlIjp0cnVlfSwiY29kZSI6ImltcG9ydCBzcXVhcmVBcmVhIGZyb20gJy4vc3F1YXJlLmpzJztcbmltcG9ydCBjaXJjbGVBcmVhIGZyb20gJy4vY2lyY2xlLmpzJztcblxuY29uc29sZS5sb2coJ0FyZWEgb2Ygc3F1YXJlOiAnLCBzcXVhcmVBcmVhKDUpKTtcbmNvbnNvbGUubG9nKCdBcmVhIG9mIGNpcmNsZScsIGNpcmNsZUFyZWEoNSkpO1xuIn0=\">babel-ast-explorer</a>.</p>\n<p>\n  <a class=\"gatsby-resp-image-link\" href=\"/static/87b78a845870fcfa5bb6756e80815d95/bb144/ast-import.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n  \n  <figure class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 38.67187499999999%; position: relative; bottom: 0; left: 0; background-image: url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABNUlEQVQoz41Ry0rDQBSd0gqC4La49jtcVa0bEfwAv0hX+iP6MwWF9DFpO5OkaYtN2mQm93jzIE1RoQdOztzHnNybiNHQgTMaYjIaQ8spPM+DUqqm1gqfEw9SSozdORw5x2zq4ktqSNfluobv+wiCAIPBAGKmNJbaR+KHiMMVFsslsixDE8YQNivCeksw+B9KeRCpsaCU21iTNEUUxyAi8KNQIls0x9EH/PAe37sHfuEN53sNXnNHjyd9hMibqWITVBua3JvxjO1WwAvPoaMOLOVXBdea7FaG9eU99/lyScreYK3g6U4512G2OduuNI9brJeHhn+hNqRXROsOFqsu1unZgWF5brEeYcgft1r5BWYnEMYn2Njf65bxxTETlj8lMe/Y7K6Q2DuO+lzoc61fnEu9ZX3CD9ttQVhUpVN6AAAAAElFTkSuQmCC&#x27;); background-size: cover; display: block;\">\n      <img class=\"gatsby-resp-image-image\" style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\" alt=\"babel-ast-explorer\" title=\"Visualizing AST through babel-ast-explorer\" src=\"/static/87b78a845870fcfa5bb6756e80815d95/623ee/ast-import.png\" srcset=\"/static/87b78a845870fcfa5bb6756e80815d95/816c5/ast-import.png 148w, /static/87b78a845870fcfa5bb6756e80815d95/c766b/ast-import.png 295w, /static/87b78a845870fcfa5bb6756e80815d95/623ee/ast-import.png 590w, /static/87b78a845870fcfa5bb6756e80815d95/e5345/ast-import.png 885w, /static/87b78a845870fcfa5bb6756e80815d95/7a439/ast-import.png 1180w, /static/87b78a845870fcfa5bb6756e80815d95/84fe0/ast-import.png 1770w, /static/87b78a845870fcfa5bb6756e80815d95/bb144/ast-import.png 2560w\" sizes=\"(max-width: 590px) 100vw, 590px\">\n    </span>\n  <figcaption>Visualizing AST through babel-ast-explorer</figcaption></figure>\n  \n  </a>\n    </p>\n<p>I found out that the <code class=\"language-text\">import</code> statement in the AST is called the <code class=\"language-text\">ImportDeclaration</code>. It has <code class=\"language-text\">specifiers</code> and <code class=\"language-text\">source</code>, which the <code class=\"language-text\">source.value</code> tells us what this module is importing from:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast<span class=\"token punctuation\">.</span>program<span class=\"token punctuation\">.</span>body</span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'ImportDeclaration'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>So I had the path that the module is requesting, but it could be relative to the current file, eg <code class=\"language-text\">&quot;./foo/bar&quot;</code>, or from the <code class=\"language-text\">node_modules</code>, eg: <code class=\"language-text\">&quot;lodash&quot;</code>. How do I know what is the <strong>actual file path</strong> that the module is requesting?</p>\n<p>The step of figuring out the actual path based on the requested path, is called <strong>‚ÄúResolving‚Äù</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast<span class=\"token punctuation\">.</span>program<span class=\"token punctuation\">.</span>body\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'ImportDeclaration'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>relativePath <span class=\"token operator\">=></span> <span class=\"token function\">resolveRequest</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath<span class=\"token punctuation\">,</span> relativePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// resolving</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">resolveRequest</span><span class=\"token punctuation\">(</span>requester<span class=\"token punctuation\">,</span> requestedPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">//</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<div class=\"caption\">Resolving path to the actual file path</div>\n<h2 id=\"resolving\"><a href=\"#resolving\" aria-label=\"resolving permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resolving</h2>\n<p>Let‚Äôs talk about resolving. We know that ‚Äúimport‚Äùing <code class=\"language-text\">./b.js</code> in the following examples will result in getting a different file, because when we specify <code class=\"language-text\">./</code>, we are ‚Äúimport‚Äùing relative to the current file.</p>\n<p class=\"filename\">project/a.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token string\">'./b.js'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p class=\"filename\">project/foo/a.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token string\">'./b.js'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>So, what are the rules of resolving a module?</p>\n<p>The Node.js documentation has listed out the <a href=\"http://nodejs.org/api/modules.html#modules_all_together\">detailed step of the module resolving algorithm</a>:</p>\n<p>When we specify a relative path, <code class=\"language-text\">./b</code>, Node.js will first assume that <code class=\"language-text\">./b</code> is a file, and tries the following extension if it doesn‚Äôt exactly match the file name:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">b\nb.js\nb.json\nb.node</code></pre></div>\n<p>If the file does not exist, Node.js will then try to treat <code class=\"language-text\">./b</code> as a directory, and try the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&quot;main&quot; in b/package.json\nb/index.js\nb/index.json\nb/index.node</code></pre></div>\n<p>If we specify <code class=\"language-text\">import &#39;b&#39;</code> instead, Node.js will treat it as a package within <code class=\"language-text\">node_modules/</code>, and have a different resolving strategy.</p>\n<p>Through the above illustration, we can see that resolving <code class=\"language-text\">import &#39;./b&#39;</code> is not as simple as it seems. Besides the default Node.js resolving behaviour, <a href=\"https://webpack.js.org/configuration/resolve/\">webpack provides a lot more customisation options</a>, such as custom extensions, alias, modules folders, etc.</p>\n<p>Here, I am showing you the <em>‚Äúsimplest‚Äù</em> resolver, which is to resolve relative path only:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// resolving</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">resolveRequest</span><span class=\"token punctuation\">(</span>requester<span class=\"token punctuation\">,</span> requestedPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span>requester<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> requestedPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<blockquote>\n<p><small><strong>Note:</strong> You should try out writing a full node resolvers that resolve relatively as well as absolutely from <code class=\"language-text\">node_modules/</code></small></p>\n</blockquote>\n<p>Now I know the actual requested file paths, I then create modules out of them.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast<span class=\"token punctuation\">.</span>program<span class=\"token punctuation\">.</span>body\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'ImportDeclaration'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>node <span class=\"token operator\">=></span> node<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>relativePath <span class=\"token operator\">=></span> <span class=\"token function\">resolveRequest</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>filePath<span class=\"token punctuation\">,</span> relativePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>absolutePath <span class=\"token operator\">=></span> <span class=\"token function\">createModule</span><span class=\"token punctuation\">(</span>absolutePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>So, for each module, I find their dependencies, parse them, and find each dependency‚Äôs dependencies, parse them as well, and find their dependencies, and so forth recursively. At the end of the process, I get a module dependency graph that looks something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Module <span class=\"token punctuation\">{</span>\n  filePath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/Projects/byo-bundler/fixture/index.js'</span><span class=\"token punctuation\">,</span>\n  content<span class=\"token punctuation\">:</span>\n   <span class=\"token string\">'import squareArea from \\'./square.js\\';\\nimport circleArea from \\'./circle.js\\';\\n\\nconsole.log(\\'Area of square: \\', squareArea(5));\\nconsole.log(\\'Area of circle\\', circleArea(5));\\n'</span><span class=\"token punctuation\">,</span>\n  ast<span class=\"token punctuation\">:</span>\n   Node <span class=\"token punctuation\">{</span> <span class=\"token comment\">/*...*/</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  dependencies<span class=\"token punctuation\">:</span>\n   <span class=\"token punctuation\">[</span> Module <span class=\"token punctuation\">{</span>\n       filePath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/Projects/byo-bundler/fixture/square.js'</span><span class=\"token punctuation\">,</span>\n       content<span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'function area(side) {\\n  return side * side;\\n}\\nexport default area;\\n'</span><span class=\"token punctuation\">,</span>\n       ast<span class=\"token punctuation\">:</span> Node <span class=\"token punctuation\">{</span><span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n       dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n     Module <span class=\"token punctuation\">{</span>\n       filePath<span class=\"token punctuation\">:</span> <span class=\"token string\">'/Projects/byo-bundler/fixture/circle.js'</span><span class=\"token punctuation\">,</span>\n       content<span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'const PI = 3.141;\\nfunction area(radius) {\\n    return PI * radius * radius;\\n}\\nexport default area;\\n'</span><span class=\"token punctuation\">,</span>\n       ast<span class=\"token punctuation\">:</span> Node <span class=\"token punctuation\">{</span><span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n       dependencies<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The root of the graph is our entry module, and you can traverse the graph through the <code class=\"language-text\">dependencies</code> of the module. As you can see, the <code class=\"language-text\">index.js</code> has 2 dependencies, the <code class=\"language-text\">square.js</code> and the <code class=\"language-text\">circle.js</code>.</p>\n<blockquote>\n<p><small><strong>Note:</strong> If you are following along, you can checkout the tag <code class=\"language-text\">feat-1-module-dependency-graph</code>, to see the code that I had written up till this point.</small></p>\n</blockquote>\n<h2 id=\"bundling\"><a href=\"#bundling\" aria-label=\"bundling permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bundling</h2>\n<p>With the module dependency graph, it‚Äôs time to bundle them into a file!</p>\n<p>At this point in time, we can choose whether we want to bundle it in the <strong>‚Äúwebpack way‚Äù</strong> or the <strong>‚Äúrollup way‚Äù</strong>. In this article I am showing you how I did it the <strong>‚Äúwebpack way‚Äù</strong>. I‚Äôll write about bundling in the <strong>‚Äúrollup way‚Äù</strong> in the coming article.</p>\n<blockquote>\n<p>If you have no idea about what is the <strong>‚Äúwebpack way‚Äù</strong> or <strong>‚Äúrollup way‚Äù</strong>, I have ‚Äúcoined‚Äù the term in my <a href=\"/what-is-module-bundler-and-how-does-it-work/\">previous article</a> and have detailed explanation about them!</p>\n</blockquote>\n<p>Let‚Äôs take a look how the final bundled file would look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> modules <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'circle.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">=</span> <span class=\"token number\">3.141</span><span class=\"token punctuation\">;</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">default</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>radius<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> radius <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'square.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">default</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>side<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> side <span class=\"token operator\">*</span> side<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'app.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> squareArea <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'square.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> circleArea <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'circle.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of square: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">squareArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of circle'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">circleArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">webpackStart</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  modules<span class=\"token punctuation\">,</span>\n  entry<span class=\"token punctuation\">:</span> <span class=\"token string\">'app.js'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Let‚Äôs break it down to a few steps:</p>\n<ul>\n<li><strong>Group modules into files</strong></li>\n<li><strong>Create the module map</strong> and wrapping each module in a ‚Äúspecial‚Äù module factory function</li>\n<li><strong>Create the ‚Äúruntime‚Äù</strong>, the glue that links each module together.</li>\n</ul>\n<h3 id=\"grouping-modules-into-files\"><a href=\"#grouping-modules-into-files\" aria-label=\"grouping modules into files permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Grouping modules into files</h3>\n<p>This step is to decide which modules goes to which file. We can split modules into different files because of <a href=\"https://webpack.js.org/guides/code-splitting/\">code splitting</a> due to dynamic import as well as optimisation, such as the webpack‚Äôs <a href=\"https://webpack.js.org/plugins/split-chunks-plugin/\">Chunk Splitting</a>.</p>\n<p>I will support code splitting in the future. For now, I grouped all modules into 1 file.</p>\n<p>To collect all the modules from module graph into a list of modules, I did a graph traversal:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">bundle</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">collectModules</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">collectModules</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> modules <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> modules<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">function</span> <span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    modules<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    module<span class=\"token punctuation\">.</span>dependencies<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>dependency <span class=\"token operator\">=></span> <span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>dependency<span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>‚Ä¶and I used the list of modules to create a module map.</p>\n<h3 id=\"creating-module-map\"><a href=\"#creating-module-map\" aria-label=\"creating module map permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Creating module map</h3>\n<p>The module map I created is a string, that would be inlined into the final bundle file.</p>\n<p>I looped through each module, and used <code class=\"language-text\">module.filePath</code> as the key, and <code class=\"language-text\">module.content</code> as the value.</p>\n<p>The reason I dont use <code class=\"language-text\">JSON.stringify(moduleMap)</code> instead of manually concatenating to build up the module map, is because JSON can only takes in <a href=\"https://documentation.progress.com/output/ua/OpenEdge_latest/index.html#page/dvjsn/json-data-types.html\">JSON primitive data type</a> as value, but what I built here is a JavaScript map, with <code class=\"language-text\">function</code> as value, but in string.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">bundle</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> modules <span class=\"token operator\">=</span> <span class=\"token function\">collectModules</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> moduleMap <span class=\"token operator\">=</span> <span class=\"token function\">toModuleMap</span><span class=\"token punctuation\">(</span>modules<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">toModuleMap</span><span class=\"token punctuation\">(</span>modules<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">let</span> moduleMap <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  moduleMap <span class=\"token operator\">+=</span> <span class=\"token string\">'{'</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> module <span class=\"token keyword\">of</span> modules<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    moduleMap <span class=\"token operator\">+=</span> <span class=\"token template-string\"><span class=\"token string\">`\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>module<span class=\"token punctuation\">.</span>filePath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\": `</span></span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    moduleMap <span class=\"token operator\">+=</span> <span class=\"token template-string\"><span class=\"token string\">`function(exports, require) { </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>module<span class=\"token punctuation\">.</span>content<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> },`</span></span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">  moduleMap <span class=\"token operator\">+=</span> <span class=\"token string\">'}'</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> moduleMap<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>The function that wraps around the <code class=\"language-text\">module.content</code> is called the module factory function. It provides 2 parameter to the module:</p>\n<ul>\n<li><code class=\"language-text\">exports</code>, an object that the module can assign its exported value onto</li>\n<li><code class=\"language-text\">require</code>, a function that the module can invoke with module path to import exported value from another module</li>\n</ul>\n<p>The module map right now is not something that can be executed:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"index.js\"</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">import</span> squareArea <span class=\"token keyword\">from</span> <span class=\"token string\">'./square.js'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">import</span> circleArea <span class=\"token keyword\">from</span> <span class=\"token string\">'./circle.js'</span><span class=\"token punctuation\">;</span>\n\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of square: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">squareArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of circle'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">circleArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"square.js\"</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>side<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> side <span class=\"token operator\">*</span> side<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> area<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"circle.js\"</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">=</span> <span class=\"token number\">3.141</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>radius<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> radius <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> area<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>because it still uses <code class=\"language-text\">import</code> and <code class=\"language-text\">export</code>. I had to transform them to use the <code class=\"language-text\">exports</code> and <code class=\"language-text\">require</code> that we pass in.</p>\n<p>To transform the code, I used the AST of the module again: trasform the ast and generate the new code from the transformed ast.</p>\n<p>What I need is to trasform the ‚Äúfrom‚Äù to ‚Äúto‚Äù of the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// #1</span>\n<span class=\"token comment\">// from</span>\n<span class=\"token keyword\">import</span> a<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> b<span class=\"token punctuation\">,</span> c <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// to</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> c <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// #2</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> a<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> b <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> c <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// to</span>\nexports<span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span> <span class=\"token operator\">=</span> a<span class=\"token punctuation\">;</span>\nexports<span class=\"token punctuation\">.</span>b <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\nexports<span class=\"token punctuation\">.</span>c <span class=\"token operator\">=</span> c<span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>I wrote a <a href=\"/step-by-step-guide-for-writing-a-babel-transformation\">step by step guide</a> on how to write babel transformation, please do check it out.</p>\n</blockquote>\n<p>Knowing <strong>what to target on AST</strong> and <strong>how the transformed AST look like</strong>, I wrote my transformation code:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> module <span class=\"token keyword\">of</span> modules<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  module<span class=\"token punctuation\">.</span><span class=\"token function\">transformModuleInterface</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  moduleMap <span class=\"token operator\">+=</span> <span class=\"token template-string\"><span class=\"token string\">`\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>module<span class=\"token punctuation\">.</span>filePath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\": function(exports, require) { </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>module<span class=\"token punctuation\">.</span>content<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> },`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Module</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">transformModuleInterface</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> ast<span class=\"token punctuation\">,</span> code <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> babel<span class=\"token punctuation\">.</span><span class=\"token function\">transformFromAstSync</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>ast <span class=\"token operator\">=</span> ast<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>content <span class=\"token operator\">=</span> code<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>I omitted the actual babel transformation code, because it is lengthy. If you are interested to read about it, you can check out <a href=\"https://github.com/tanhauhau/byo-bundler/blob/feat-2-bundling/src/index.js#L46-L138\">from my Github repo</a></p>\n<p>So, now the module map looks ready:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"index.js\"</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> squareArea <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'square.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> circleArea <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'circle.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of square: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">squareArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of circle'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">circleArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"square.js\"</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>side<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> side <span class=\"token operator\">*</span> side<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span> <span class=\"token operator\">=</span> area<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"circle.js\"</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">=</span> <span class=\"token number\">3.141</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>radius<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> radius <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span> <span class=\"token operator\">=</span> area<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>One thing to take note is that, for the <code class=\"language-text\">require</code> statements, I replaced the requested path to the actual resolved path, because I used the actual resolved path as the key to the module map.</p>\n<h3 id=\"create-the-runtime\"><a href=\"#create-the-runtime\" aria-label=\"create the runtime permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><strong>Create the ‚Äúruntime‚Äù</strong></h3>\n<p>Now it‚Äôs time to create the runtime. The runtime is a piece of code that is part of the output bundle, that runs when the application code is running, therefore, the runtime.</p>\n<p>The runtime code can be from a template file, but for simplicity sake, I kept the runtime code as a string:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">bundle</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> modules <span class=\"token operator\">=</span> <span class=\"token function\">collectModules</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> moduleMap <span class=\"token operator\">=</span> <span class=\"token function\">toModuleMap</span><span class=\"token punctuation\">(</span>modules<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> moduleCode <span class=\"token operator\">=</span> <span class=\"token function\">addRuntime</span><span class=\"token punctuation\">(</span>moduleMap<span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">addRuntime</span><span class=\"token punctuation\">(</span>moduleMap<span class=\"token punctuation\">,</span> entryPoint<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"gatsby-highlight-code-line\">    const modules = </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>moduleMap<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">;</span><span class=\"gatsby-highlight-code-line\">    const entry = \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>entryPoint<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\";</span><span class=\"gatsby-highlight-code-line\">    function webpackStart({ modules, entry }) {</span><span class=\"gatsby-highlight-code-line\">      const moduleCache = {};</span><span class=\"gatsby-highlight-code-line\">      const require = moduleName => {</span><span class=\"gatsby-highlight-code-line\">        // if in cache, return the cached version</span><span class=\"gatsby-highlight-code-line\">        if (moduleCache[moduleName]) {</span><span class=\"gatsby-highlight-code-line\">          return moduleCache[moduleName];</span><span class=\"gatsby-highlight-code-line\">        }</span><span class=\"gatsby-highlight-code-line\">        const exports = {};</span><span class=\"gatsby-highlight-code-line\">        // this will prevent infinite \"require\" loop</span><span class=\"gatsby-highlight-code-line\">        // from circular dependencies</span><span class=\"gatsby-highlight-code-line\">        moduleCache[moduleName] = exports;</span><span class=\"gatsby-highlight-code-line\">    </span><span class=\"gatsby-highlight-code-line\">        // \"require\"-ing the module,</span><span class=\"gatsby-highlight-code-line\">        // exported stuff will assigned to \"exports\"</span><span class=\"gatsby-highlight-code-line\">        modules[moduleName](exports, require);</span><span class=\"gatsby-highlight-code-line\">        return moduleCache[moduleName];</span><span class=\"gatsby-highlight-code-line\">      };</span><span class=\"gatsby-highlight-code-line\">    </span><span class=\"gatsby-highlight-code-line\">      // start the program</span><span class=\"gatsby-highlight-code-line\">      require(entry);</span><span class=\"gatsby-highlight-code-line\">    }</span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\">    webpackStart({ modules, entry });`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// trim away spaces before the line</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> lines <span class=\"token operator\">=</span> str<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>Boolean<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> padLength <span class=\"token operator\">=</span> lines<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> lines<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">trimLeft</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> regex <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RegExp</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`^\\\\s{</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>padLength<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">}`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> lines<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>line <span class=\"token operator\">=></span> line<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>regex<span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>The code above is self explanatory, except if you have no idea what does the <code class=\"language-text\">webpackStart()</code> do, you can read more about it in <a href=\"/what-is-module-bundler-and-how-does-it-work/\">my previous post</a>.</p>\n<p>Finally, I returned the module code from the <code class=\"language-text\">bundle</code> function:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">bundle</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> modules <span class=\"token operator\">=</span> <span class=\"token function\">collectModules</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> moduleMap <span class=\"token operator\">=</span> <span class=\"token function\">toModuleMap</span><span class=\"token punctuation\">(</span>modules<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> moduleCode <span class=\"token operator\">=</span> <span class=\"token function\">addRuntime</span><span class=\"token punctuation\">(</span>moduleMap<span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">:</span> <span class=\"token string\">'bundle.js'</span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">:</span> moduleCode <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now I run my bundler, it generates a <code class=\"language-text\">output/bundle.js</code> file. I run the generated file with node and I see:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Area of square:  25\nArea of circle 78.525</code></pre></div>\n<p>That‚Äôs it! A working module bundler!</p>\n<p>Of course, the module bundler I‚Äôve shown here is <strong>nowhere near webpack</strong>. Webpack supports more module system, resolving strategies, loading strategies, plugin system, optimisation, and many many more.</p>\n<h1 id=\"optimisation\"><a href=\"#optimisation\" aria-label=\"optimisation permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Optimisation</h1>\n<p>I played around my module bundler, and I quickly noticed a bug: <strong>Circular Dependency</strong>.</p>\n<p>Here‚Äôs my input files that I‚Äôve tweaked:</p>\n<p class=\"filename\">index.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> squareArea <span class=\"token keyword\">from</span> <span class=\"token string\">'./square.js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> circleArea <span class=\"token keyword\">from</span> <span class=\"token string\">'./circle.js'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">=</span> <span class=\"token number\">3.141</span><span class=\"token punctuation\">;</span></span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of square: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">squareArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of circle'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">circleArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p class=\"filename\">circle.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token comment\">// const PI = 3.141;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">PI</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./index.js'</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>radius<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> radius <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> area<span class=\"token punctuation\">;</span></code></pre></div>\n<p>When I ran it through my module bunlder, immediately it ran into a stack overflow:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">RangeError: Maximum call stack size exceeded</code></pre></div>\n<h2 id=\"circular-dependency\"><a href=\"#circular-dependency\" aria-label=\"circular dependency permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Circular dependency</h2>\n<p>There were 2 junctures that the code did recursive traversal which have led to the endless loop:</p>\n<ul>\n<li>Generating dependency graphs</li>\n<li>Traversing module graph for bundling</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// fixing circular dependencies when generating module graph</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token constant\">MODULE_CACHE</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createModule</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\"> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token constant\">MODULE_CACHE</span><span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>   <span class=\"token keyword\">const</span> module <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Module</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">   <span class=\"token constant\">MODULE_CACHE</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">   module<span class=\"token punctuation\">.</span><span class=\"token function\">initDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span> <span class=\"token punctuation\">}</span>\n<span class=\"gatsby-highlight-code-line\"> <span class=\"token keyword\">return</span> <span class=\"token constant\">MODULE_CACHE</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Module</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">initDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dependencies <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">findDependencies</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// fixing circular dependencies when traversing module graph</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">collectModules</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> modules <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> Array<span class=\"token punctuation\">.</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span>modules<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">function</span> <span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>modules<span class=\"token punctuation\">.</span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      modules<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      module<span class=\"token punctuation\">.</span>dependencies<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>dependency <span class=\"token operator\">=></span> <span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>dependency<span class=\"token punctuation\">,</span> modules<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Bundle with the latest code, the stack overflow is gone. However when I executed the output bundle, I saw</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ node output/bundle.js\nArea of square:  25\nArea of circle NaN</code></pre></div>\n<p>So I took a look at the output bundle:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'index.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> squareArea <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'square.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 1. require circle.js</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">default</span><span class=\"token punctuation\">:</span> circleArea <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'circle.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 3. define PI on exports</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token constant\">PI</span> <span class=\"token operator\">=</span> <span class=\"token number\">3.141</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of square: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">squareArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 4. call `circleArea`</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of circle'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">circleArea</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'circle.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 2. at the point of executing this, PI is not yet defined</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">PI</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">PI</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'index.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>radius<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 5. PI is undefined</span>\n      <span class=\"token keyword\">return</span> <span class=\"token constant\">PI</span> <span class=\"token operator\">*</span> radius <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span> <span class=\"token operator\">=</span> area<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>So, the problem is that I destructed <code class=\"language-text\">PI</code> from the exports of <code class=\"language-text\">index.js</code> before it is defined, so naturally <code class=\"language-text\">PI</code> within <code class=\"language-text\">circle.js</code> would stay as <code class=\"language-text\">undefined</code> throughout the application. However before I called <code class=\"language-text\">circleArea</code>, we defined <code class=\"language-text\">PI</code> on the <code class=\"language-text\">index.js</code>‚Äôs export, I am expecting it to be available.</p>\n<p>So I built my application with webpack and took a look at how webpack solved this problem.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'index.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> square_import <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'square.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 1. require circle.js</span>\n    <span class=\"token keyword\">const</span> circle_import <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'circle.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 3. define PI on exports</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token constant\">PI</span> <span class=\"token operator\">=</span> <span class=\"token number\">3.141</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of square: '</span><span class=\"token punctuation\">,</span> square_import<span class=\"token punctuation\">[</span><span class=\"token string\">'default'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 4. call `circleArea`</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Area of circle'</span><span class=\"token punctuation\">,</span> circle_import<span class=\"token punctuation\">[</span><span class=\"token string\">'default'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'circle.js'</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>exports<span class=\"token punctuation\">,</span> require<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 2. we keep a reference of the `index.js`'s `exports` object</span>\n    <span class=\"token keyword\">const</span> index_import <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'index.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">area</span><span class=\"token punctuation\">(</span>radius<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 5. we get PI from the `exports`</span>\n      <span class=\"token keyword\">return</span> index_import<span class=\"token punctuation\">[</span><span class=\"token string\">'PI'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">*</span> radius <span class=\"token operator\">*</span> radius<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    exports<span class=\"token punctuation\">.</span><span class=\"token keyword\">default</span> <span class=\"token operator\">=</span> area<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Brilliant! The key is to lazily get the value of <code class=\"language-text\">PI</code> when needed!</p>\n<p>I changed my babel transformation code, which I am not showing it here. If you are curious enough, you can check out <a href=\"https://github.com/tanhauhau/byo-bundler/compare/feat-2-bundling...feat-3-circular-dependency\">the changes I made from Github</a>.</p>\n<h1 id=\"summary\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>There‚Äôs two phases in module bundling: <strong>Dependency Resolution</strong> and <strong>Bundling</strong>.</p>\n<p>I showed you how I constructed the dependency graph, by finding import statements and resolving modules. I shared how I created module maps and transformed the imports / exports syntax during <strong>bundling</strong>. Lastly, I fixed the circular dependency bug that was in the first version of my module bundler.</p>\n<h3 id=\"whats-next\"><a href=\"#whats-next\" aria-label=\"whats next permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Whats next?</h3>\n<p>I have a few ideas that I will add to my module bundler, such as:</p>\n<ul>\n<li>code spliting</li>\n<li>watch mode and reloading</li>\n</ul>\n<p>which I will cover them in my next article when they are ready.</p>\n<p>Till then. Cheers. <span class=\"emoji\">üòé</span></p>\n<h1 id=\"further-readings\"><a href=\"#further-readings\" aria-label=\"further readings permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Further Readings</h1>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=Gc9-7PBqOC8\">Ronen Amiel, Build Your Own Webpack - You Gotta Love Frontend 2018</a></li>\n<li><a href=\"https://slides.com/lucianomammino/unbundling-the-javascript-module-bundler-dublinjs\">Luciano Mammino, Unbundling the JavaScript module bundler - DublinJS July 2018</a></li>\n<li><a href=\"https://www.freecodecamp.org/news/lets-learn-how-module-bundlers-work-and-then-write-one-ourselves-b2e3fe6c88ae/\">Adam Kelly, Let‚Äôs learn how module bundlers work and then write one ourselves</a></li>\n</ul>","fields":{"slug":"/writing-your-own-module-bundler/","wip":false},"frontmatter":{"title":"I wrote my module bundler","date":"June 29, 2019","lastUpdated":null,"description":null,"tags":"JavaScript,module bundler,dev tool,webpack"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/writing-your-own-module-bundler/","type":"blog","noteDate":null,"noteTitle":null,"wip":true,"heroImageUrl":null,"heroTwitterImageUrl":null,"previous":null,"next":null}}}