function t(){}function n(t,n){for(const e in n)t[e]=n[e];return t}function e(t){return t()}function s(){return Object.create(null)}function a(t){t.forEach(e)}function o(t){return"function"==typeof t}function c(t,n){return t!=t?n==n:t!==n||t&&"object"==typeof t||"function"==typeof t}function l(t,e,s,a){return t[1]&&a?n(s.ctx.slice(),t[1](a(e))):s.ctx}function r(t,n,e,s,a,o,c){const r=function(t,n,e,s){if(t[2]&&s){const a=t[2](s(e));if(void 0===n.dirty)return a;if("object"==typeof a){const t=[],e=Math.max(n.dirty.length,a.length);for(let s=0;s<e;s+=1)t[s]=n.dirty[s]|a[s];return t}return n.dirty|a}return n.dirty}(n,s,a,o);if(r){const a=l(n,e,s,c);t.p(a,r)}}function i(t,n){t.appendChild(n)}function u(t,n,e){t.insertBefore(n,e||null)}function p(t){t.parentNode.removeChild(t)}function f(t,n){for(let e=0;e<t.length;e+=1)t[e]&&t[e].d(n)}function h(t){return document.createElement(t)}function d(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function m(t){return document.createTextNode(t)}function g(){return m(" ")}function v(t,n,e){null==e?t.removeAttribute(n):t.getAttribute(n)!==e&&t.setAttribute(n,e)}function y(t){return Array.from(t.childNodes)}function k(t,n,e,s){for(let s=0;s<t.length;s+=1){const a=t[s];if(a.nodeName===n){let n=0;const o=[];for(;n<a.attributes.length;){const t=a.attributes[n++];e[t.name]||o.push(t.name)}for(let t=0;t<o.length;t++)a.removeAttribute(o[t]);return t.splice(s,1)[0]}}return s?d(n):h(n)}function $(t,n){for(let e=0;e<t.length;e+=1){const s=t[e];if(3===s.nodeType)return s.data=""+n,t.splice(e,1)[0]}return m(n)}function b(t){return $(t," ")}function w(t,n){n=""+n,t.wholeText!==n&&(t.data=n)}let E;function A(t){E=t}const x=[],N=[],j=[],T=[],L=Promise.resolve();let I=!1;function _(t){j.push(t)}let z=!1;const S=new Set;function M(){if(!z){z=!0;do{for(let t=0;t<x.length;t+=1){const n=x[t];A(n),R(n.$$)}for(x.length=0;N.length;)N.pop()();for(let t=0;t<j.length;t+=1){const n=j[t];S.has(n)||(S.add(n),n())}j.length=0}while(x.length);for(;T.length;)T.pop()();I=!1,z=!1,S.clear()}}function R(t){if(null!==t.fragment){t.update(),a(t.before_update);const n=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,n),t.after_update.forEach(_)}}const C=new Set;function H(t,n){t&&t.i&&(C.delete(t),t.i(n))}function B(t,n,e,s){if(t&&t.o){if(C.has(t))return;C.add(t),(void 0).c.push(()=>{C.delete(t),s&&(e&&t.d(1),s())}),t.o(n)}}function q(t){t&&t.c()}function P(t,n){t&&t.l(n)}function F(t,n,s){const{fragment:c,on_mount:l,on_destroy:r,after_update:i}=t.$$;c&&c.m(n,s),_(()=>{const n=l.map(e).filter(o);r?r.push(...n):a(n),t.$$.on_mount=[]}),i.forEach(_)}function O(t,n){const e=t.$$;null!==e.fragment&&(a(e.on_destroy),e.fragment&&e.fragment.d(n),e.on_destroy=e.fragment=null,e.ctx=[])}function K(t,n){-1===t.$$.dirty[0]&&(x.push(t),I||(I=!0,L.then(M)),t.$$.dirty.fill(0)),t.$$.dirty[n/31|0]|=1<<n%31}function U(n,e,o,c,l,r,i=[-1]){const u=E;A(n);const f=e.props||{},h=n.$$={fragment:null,ctx:null,props:r,update:t,not_equal:l,bound:s(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(u?u.$$.context:[]),callbacks:s(),dirty:i};let d=!1;if(h.ctx=o?o(n,f,(t,e,...s)=>{const a=s.length?s[0]:e;return h.ctx&&l(h.ctx[t],h.ctx[t]=a)&&(h.bound[t]&&h.bound[t](a),d&&K(n,t)),e}):[],h.update(),d=!0,a(h.before_update),h.fragment=!!c&&c(h.ctx),e.target){if(e.hydrate){const t=y(e.target);h.fragment&&h.fragment.l(t),t.forEach(p)}else h.fragment&&h.fragment.c();e.intro&&H(n.$$.fragment),F(n,e.target,e.anchor),M()}A(u)}class V{$destroy(){O(this,1),this.$destroy=t}$on(t,n){const e=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return e.push(n),()=>{const t=e.indexOf(n);-1!==t&&e.splice(t,1)}}$set(){}}function W(n){let e,s,a,o,c,l,r,f,w,E,A,x,N,j,T,L,I,_,z,S,M,R,C,H,B,q,P,F,O,K,U,V,W,D,G;return{c(){e=h("header"),s=h("nav"),a=h("ul"),o=h("li"),c=h("a"),l=m("Tan Li Hau"),r=g(),f=h("li"),w=h("a"),E=m("About"),A=g(),x=h("li"),N=h("a"),j=m("Writings"),T=g(),L=h("li"),I=h("a"),_=m("Talks"),z=g(),S=h("li"),M=h("a"),R=m("Notes"),C=g(),H=h("li"),B=h("a"),q=m("Newsletter"),P=g(),F=h("li"),O=h("a"),K=d("svg"),U=d("path"),V=g(),W=h("a"),D=d("svg"),G=d("path"),this.h()},l(t){e=k(t,"HEADER",{class:!0});var n=y(e);s=k(n,"NAV",{});var i=y(s);a=k(i,"UL",{class:!0});var u=y(a);o=k(u,"LI",{class:!0});var h=y(o);c=k(h,"A",{href:!0,class:!0});var d=y(c);l=$(d,"Tan Li Hau"),d.forEach(p),h.forEach(p),r=b(u),f=k(u,"LI",{class:!0});var m=y(f);w=k(m,"A",{href:!0,class:!0});var g=y(w);E=$(g,"About"),g.forEach(p),m.forEach(p),A=b(u),x=k(u,"LI",{class:!0});var v=y(x);N=k(v,"A",{href:!0,class:!0});var Q=y(N);j=$(Q,"Writings"),Q.forEach(p),v.forEach(p),T=b(u),L=k(u,"LI",{class:!0});var J=y(L);I=k(J,"A",{href:!0,class:!0});var X=y(I);_=$(X,"Talks"),X.forEach(p),J.forEach(p),z=b(u),S=k(u,"LI",{class:!0});var Y=y(S);M=k(Y,"A",{href:!0,class:!0});var Z=y(M);R=$(Z,"Notes"),Z.forEach(p),Y.forEach(p),C=b(u),H=k(u,"LI",{class:!0});var tt=y(H);B=k(tt,"A",{href:!0,class:!0});var nt=y(B);q=$(nt,"Newsletter"),nt.forEach(p),tt.forEach(p),P=b(u),F=k(u,"LI",{class:!0});var et=y(F);O=k(et,"A",{"aria-label":!0,href:!0,class:!0});var st=y(O);K=k(st,"svg",{viewBox:!0,width:!0,height:!0,class:!0},1);var at=y(K);U=k(at,"path",{d:!0},1),y(U).forEach(p),at.forEach(p),st.forEach(p),V=b(et),W=k(et,"A",{"aria-label":!0,href:!0,class:!0});var ot=y(W);D=k(ot,"svg",{viewBox:!0,width:!0,height:!0,class:!0},1);var ct=y(D);G=k(ct,"path",{d:!0},1),y(G).forEach(p),ct.forEach(p),ot.forEach(p),et.forEach(p),u.forEach(p),i.forEach(p),n.forEach(p),this.h()},h(){v(c,"href","/"),v(c,"class","svelte-f3e4uo"),v(o,"class","svelte-f3e4uo"),v(w,"href","/about"),v(w,"class","svelte-f3e4uo"),v(f,"class","svelte-f3e4uo"),v(N,"href","/blogs"),v(N,"class","svelte-f3e4uo"),v(x,"class","svelte-f3e4uo"),v(I,"href","/talks"),v(I,"class","svelte-f3e4uo"),v(L,"class","svelte-f3e4uo"),v(M,"href","/notes"),v(M,"class","svelte-f3e4uo"),v(S,"class","svelte-f3e4uo"),v(B,"href","/newsletter"),v(B,"class","svelte-f3e4uo"),v(H,"class","svelte-f3e4uo"),v(U,"d","M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66\n    10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5\n    4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"),v(K,"viewBox","0 0 24 24"),v(K,"width","1em"),v(K,"height","1em"),v(K,"class","svelte-f3e4uo"),v(O,"aria-label","Twitter account"),v(O,"href","https://twitter.com/lihautan"),v(O,"class","svelte-f3e4uo"),v(G,"d","M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0\n    0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07\n    5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65\n    5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42\n    3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"),v(D,"viewBox","0 0 24 24"),v(D,"width","1em"),v(D,"height","1em"),v(D,"class","svelte-f3e4uo"),v(W,"aria-label","Github account"),v(W,"href","https://github.com/tanhauhau"),v(W,"class","svelte-f3e4uo"),v(F,"class","social svelte-f3e4uo"),v(a,"class","svelte-f3e4uo"),v(e,"class","svelte-f3e4uo")},m(t,n){u(t,e,n),i(e,s),i(s,a),i(a,o),i(o,c),i(c,l),i(a,r),i(a,f),i(f,w),i(w,E),i(a,A),i(a,x),i(x,N),i(N,j),i(a,T),i(a,L),i(L,I),i(I,_),i(a,z),i(a,S),i(S,M),i(M,R),i(a,C),i(a,H),i(H,B),i(B,q),i(a,P),i(a,F),i(F,O),i(O,K),i(K,U),i(F,V),i(F,W),i(W,D),i(D,G)},p:t,i:t,o:t,d(t){t&&p(e)}}}class D extends V{constructor(t){super(),U(this,t,null,W,c,{})}}function G(t,n,e){const s=t.slice();return s[6]=n[e],s}function Q(t,n,e){const s=t.slice();return s[6]=n[e],s}function J(t){let n,e;return{c(){n=h("meta"),this.h()},l(t){n=k(t,"META",{name:!0,content:!0}),this.h()},h(){v(n,"name","keywords"),v(n,"content",e=t[6])},m(t,e){u(t,n,e)},p(t,s){4&s&&e!==(e=t[6])&&v(n,"content",e)},d(t){t&&p(n)}}}function X(t){let n,e,s=t[6]+"";return{c(){n=h("span"),e=m(s),this.h()},l(t){n=k(t,"SPAN",{class:!0});var a=y(n);e=$(a,s),a.forEach(p),this.h()},h(){v(n,"class","svelte-186dllz")},m(t,s){u(t,n,s),i(n,e)},p(t,n){4&n&&s!==(s=t[6]+"")&&w(e,s)},d(t){t&&p(n)}}}function Y(t){let n,e,s,a,o,c,d,E,A,x,N,j,T,L,I,_,z,S;document.title=n="Note: "+t[1]+" | Tan Li Hau";let M=t[2],R=[];for(let n=0;n<M.length;n+=1)R[n]=J(Q(t,M,n));x=new D({});let C=t[2],K=[];for(let n=0;n<C.length;n+=1)K[n]=X(G(t,C,n));const U=t[4].default,V=function(t,n,e,s){if(t){const a=l(t,n,e,s);return t[0](a)}}(U,t,t[3],null);return{c(){e=h("link"),s=h("meta"),a=h("meta");for(let t=0;t<R.length;t+=1)R[t].c();o=h("meta"),c=g(),d=h("a"),E=m("Skip to content"),A=g(),q(x.$$.fragment),N=g(),j=h("main"),T=h("h1"),L=m(t[1]),I=g();for(let t=0;t<K.length;t+=1)K[t].c();_=g(),z=h("article"),V&&V.c(),this.h()},l(n){const l=function(t,n=document.body){return Array.from(n.querySelectorAll(t))}('[data-svelte="svelte-ywf7m8"]',document.head);e=k(l,"LINK",{href:!0,rel:!0}),s=k(l,"META",{name:!0,content:!0}),a=k(l,"META",{name:!0,content:!0});for(let t=0;t<R.length;t+=1)R[t].l(l);o=k(l,"META",{itemprop:!0,content:!0}),l.forEach(p),c=b(n),d=k(n,"A",{href:!0,class:!0});var r=y(d);E=$(r,"Skip to content"),r.forEach(p),A=b(n),P(x.$$.fragment,n),N=b(n),j=k(n,"MAIN",{id:!0,class:!0});var i=y(j);T=k(i,"H1",{});var u=y(T);L=$(u,t[1]),u.forEach(p),I=b(i);for(let t=0;t<K.length;t+=1)K[t].l(i);_=b(i),z=k(i,"ARTICLE",{class:!0});var f=y(z);V&&V.l(f),f.forEach(p),i.forEach(p),this.h()},h(){v(e,"href","https://lihautan.com/notes/async-initialisation-nodejs-lib/assets/blog-base-3554d53c.css"),v(e,"rel","stylesheet"),v(s,"name","og:title"),v(s,"content",t[0]),v(a,"name","og:type"),v(a,"content","website"),v(o,"itemprop","url"),v(o,"content","https%3A%2F%2Flihautan.com%2Fnotes%2Fasync-initialisation-nodejs-lib"),v(d,"href","#content"),v(d,"class","skip svelte-186dllz"),v(z,"class","svelte-186dllz"),v(j,"id","content"),v(j,"class","blog svelte-186dllz")},m(t,n){i(document.head,e),i(document.head,s),i(document.head,a);for(let t=0;t<R.length;t+=1)R[t].m(document.head,null);i(document.head,o),u(t,c,n),u(t,d,n),i(d,E),u(t,A,n),F(x,t,n),u(t,N,n),u(t,j,n),i(j,T),i(T,L),i(j,I);for(let t=0;t<K.length;t+=1)K[t].m(j,null);i(j,_),i(j,z),V&&V.m(z,null),S=!0},p(t,[e]){if((!S||2&e)&&n!==(n="Note: "+t[1]+" | Tan Li Hau")&&(document.title=n),(!S||1&e)&&v(s,"content",t[0]),4&e){let n;for(M=t[2],n=0;n<M.length;n+=1){const s=Q(t,M,n);R[n]?R[n].p(s,e):(R[n]=J(s),R[n].c(),R[n].m(o.parentNode,o))}for(;n<R.length;n+=1)R[n].d(1);R.length=M.length}if((!S||2&e)&&w(L,t[1]),4&e){let n;for(C=t[2],n=0;n<C.length;n+=1){const s=G(t,C,n);K[n]?K[n].p(s,e):(K[n]=X(s),K[n].c(),K[n].m(j,_))}for(;n<K.length;n+=1)K[n].d(1);K.length=C.length}V&&V.p&&8&e&&r(V,U,t,t[3],e,null,null)},i(t){S||(H(x.$$.fragment,t),H(V,t),S=!0)},o(t){B(x.$$.fragment,t),B(V,t),S=!1},d(t){p(e),p(s),p(a),f(R,t),p(o),t&&p(c),t&&p(d),t&&p(A),O(x,t),t&&p(N),t&&p(j),f(K,t),V&&V.d(t)}}}function Z(t,n,e){let{name:s}=n,{title:a}=n,{tags:o=[]}=n,{$$slots:c={},$$scope:l}=n;return t.$set=t=>{"name"in t&&e(0,s=t.name),"title"in t&&e(1,a=t.title),"tags"in t&&e(2,o=t.tags),"$$scope"in t&&e(3,l=t.$$scope)},[s,a,o,l,c]}class tt extends V{constructor(t){super(),U(this,t,Z,Y,c,{name:0,title:1,tags:2})}}function nt(n){let e,s,a,o,c,l,r,f,d,w,E,A,x;return{c(){e=h("blockquote"),s=h("p"),a=m("I have a library that needs to be called synchronously but has an async initialization step."),o=h("br"),c=h("br"),l=m("Can I use pkg.exports or something else to use top-level await when supported, and fallback to export the initialization promise so that Node.js 12-13 users can await it themselves?"),r=m("— Nicolò Ribaudo 🏳️‍🌈 (@NicoloRibaudo) "),f=h("a"),d=m("September 12, 2020"),w=g(),E=h("pre"),A=g(),x=h("pre"),this.h()},l(t){e=k(t,"BLOCKQUOTE",{class:!0});var n=y(e);s=k(n,"P",{lang:!0,dir:!0});var i=y(s);a=$(i,"I have a library that needs to be called synchronously but has an async initialization step."),o=k(i,"BR",{}),c=k(i,"BR",{}),l=$(i,"Can I use pkg.exports or something else to use top-level await when supported, and fallback to export the initialization promise so that Node.js 12-13 users can await it themselves?"),i.forEach(p),r=$(n,"— Nicolò Ribaudo 🏳️‍🌈 (@NicoloRibaudo) "),f=k(n,"A",{href:!0});var u=y(f);d=$(u,"September 12, 2020"),u.forEach(p),n.forEach(p),w=b(t),E=k(t,"PRE",{class:!0}),y(E).forEach(p),A=b(t),x=k(t,"PRE",{class:!0}),y(x).forEach(p),this.h()},h(){v(s,"lang","en"),v(s,"dir","ltr"),v(f,"href","https://twitter.com/NicoloRibaudo/status/1304710001982877697?ref_src=twsrc%5Etfw"),v(e,"class","twitter-tweet"),v(E,"class","language-json"),v(x,"class","language-js")},m(t,n){u(t,e,n),i(e,s),i(s,a),i(s,o),i(s,c),i(s,l),i(e,r),i(e,f),i(f,d),u(t,w,n),u(t,E,n),E.innerHTML='<code class="language-json"><span class="token comment">// package.json</span>\n<span class="token punctuation">&#123;</span>\n  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"your-pkg"</span><span class="token punctuation">,</span>\n  <span class="token property">"exports"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>\n    <span class="token property">"."</span><span class="token operator">:</span> <span class="token string">"./with-top-level-await.js"</span><span class="token punctuation">,</span>\n    <span class="token property">"./init"</span><span class="token operator">:</span> <span class="token string">"./without-top-level-await.js"</span>\n  <span class="token punctuation">&#125;</span>\n<span class="token punctuation">&#125;</span></code>',u(t,A,n),u(t,x,n),x.innerHTML='<code class="language-js"><span class="token comment">// >= node 14 (with top-level await support)</span>\n<span class="token keyword">import</span> api <span class="token keyword">from</span> <span class="token string">\'your-pkg\'</span><span class="token punctuation">;</span>\n\n<span class="token comment">// &lt; node 14</span>\n<span class="token keyword">import</span> init <span class="token keyword">from</span> <span class="token string">\'your-pkg/init\'</span><span class="token punctuation">;</span>\n\n<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>\n  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code>'},p:t,d(t){t&&p(e),t&&p(w),t&&p(E),t&&p(A),t&&p(x)}}}function et(t){let e,s;const a=[st];let o={$$slots:{default:[nt]},$$scope:{ctx:t}};for(let t=0;t<a.length;t+=1)o=n(o,a[t]);return e=new tt({props:o}),{c(){q(e.$$.fragment)},l(t){P(e.$$.fragment,t)},m(t,n){F(e,t,n),s=!0},p(t,[n]){const s=0&n?function(t,n){const e={},s={},a={$$scope:1};let o=t.length;for(;o--;){const c=t[o],l=n[o];if(l){for(const t in c)t in l||(s[t]=1);for(const t in l)a[t]||(e[t]=l[t],a[t]=1);t[o]=l}else for(const t in c)a[t]=1}for(const t in s)t in e||(e[t]=void 0);return e}(a,[(o=st,"object"==typeof o&&null!==o?o:{})]):{};var o;1&n&&(s.$$scope={dirty:n,ctx:t}),e.$set(s)},i(t){s||(H(e.$$.fragment,t),s=!0)},o(t){B(e.$$.fragment,t),s=!1},d(t){O(e,t)}}}const st={title:"Async initialisation of node lib",tags:["nodejs"],slug:"notes/async-initialisation-nodejs-lib",type:"notes",name:"async-initialisation-nodejs-lib",layout:"note"};class at extends V{constructor(t){super(),U(this,t,null,et,c,{})}}setTimeout(()=>{new at({target:document.querySelector("#app"),hydrate:!0});if(document.querySelector(".twitter-tweet")){const t=document.createElement("script");t.async=!0,t.src="https://platform.twitter.com/widgets.js",t.charset="utf-8",document.body.appendChild(t)}if("loading"in HTMLImageElement.prototype){document.querySelectorAll('img[loading="lazy"]').forEach(t=>{t.src=t.dataset.src})}else{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js",document.body.appendChild(t)}},3e3);
