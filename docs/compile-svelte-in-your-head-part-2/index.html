<!DOCTYPE html>
<html lang="en">

<head>
  <meta charSet="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="preconnect dns-prefetch" href="https://www.google-analytics.com" />
  <link rel="preconnect dns-prefetch" href="https://fonts.googleapis.com" />
  <link href="https://twitter.com/lihautan" rel="me" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#bd93f9" />
  <link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=8d2ab22a78631a892833a1e109f6aba0" />
  <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=8d2ab22a78631a892833a1e109f6aba0" />
  <link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=8d2ab22a78631a892833a1e109f6aba0" />
  <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=8d2ab22a78631a892833a1e109f6aba0" />
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=8d2ab22a78631a892833a1e109f6aba0" />
  <link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=8d2ab22a78631a892833a1e109f6aba0" />
  <link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=8d2ab22a78631a892833a1e109f6aba0" />
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=8d2ab22a78631a892833a1e109f6aba0" />
  <link rel="icon" href="/icons/icon-48x48.png?v=8d2ab22a78631a892833a1e109f6aba0" />
  <link rel="preload"
    href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300&display=swap" as="style"
    onload="this.rel='stylesheet'">
  <style>
    html {
      font-family: 'Lato', sans-serif;
      font-weight: 300;
      font-size: 19px;
      background: linear-gradient(0deg, transparent, #bd93f917, transparent);
    }

    html,
    body {
      margin: 0;
      padding: 0;
    }

    :root {
      --prism-padding: 20px;
      --margin: 1.62em;
      --box-shadow-size: 6px;
      --box-shadow: var(--box-shadow-size) var(--box-shadow-size) var(--primary-color);
      --box-shadow-hover: 10px 10px var(--primary-color);
      --easing: 200ms ease-in-out;
      --primary-color: #bd93f9;
      --secondary-color: #9547b7;
      --dark-color: #282936;
    }
  </style>

  
  <title>Compile Svelte in your head (Part 2) | Tan Li Hau</title><meta name="description" data-svelte="svelte-n0q11s"><meta name="image" content="https://lihautan.com/compile-svelte-in-your-head-part-2/assets/hero-twitter-2914f5b9.jpg" data-svelte="svelte-n0q11s"><meta name="og:image" content="https://lihautan.com/compile-svelte-in-your-head-part-2/assets/hero-twitter-2914f5b9.jpg" data-svelte="svelte-n0q11s"><meta name="og:title" content="Compile Svelte in your head (Part 2)" data-svelte="svelte-n0q11s"><meta name="og:description" data-svelte="svelte-n0q11s"><meta name="og:type" content="website" data-svelte="svelte-n0q11s"><meta name="twitter:card" content="summary_large_image" data-svelte="svelte-n0q11s"><meta name="twitter:creator" content="@lihautan" data-svelte="svelte-n0q11s"><meta name="twitter:title" content="Compile Svelte in your head (Part 2)" data-svelte="svelte-n0q11s"><meta name="twitter:description" data-svelte="svelte-n0q11s"><meta name="twitter:image" content="https://lihautan.com/compile-svelte-in-your-head-part-2/assets/hero-twitter-2914f5b9.jpg" data-svelte="svelte-n0q11s"><meta name="keywords" content="Svelte" data-svelte="svelte-n0q11s"><meta name="keywords" content="JavaScript" data-svelte="svelte-n0q11s"><meta itemprop="url" content="https%3A%2F%2Flihautan.com%2Fcompile-svelte-in-your-head-part-2" data-svelte="svelte-n0q11s"><meta itemprop="image" content="https://lihautan.com/compile-svelte-in-your-head-part-2/assets/hero-twitter-2914f5b9.jpg" data-svelte="svelte-n0q11s"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Tan Li Hau"},"copyrightHolder":{"@type":"Person","name":"Tan Li Hau"},"copyrightYear":"2020","creator":{"@type":"Person","name":"Tan Li Hau"},"publisher":{"@type":"Person","name":"Tan Li Hau"},"headline":"Compile Svelte in your head (Part 2)","name":"Compile Svelte in your head (Part 2)","inLanguage":"en"}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","description":"Breadcrumbs list","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","item":{"@id":"https://lihautan.com","name":"Homepage"},"position":1},{"@type":"ListItem","item":{"@id":"https%3A%2F%2Flihautan.com%2Fcompile-svelte-in-your-head-part-2","name":"Compile Svelte in your head (Part 2)"},"position":2}]}</script><link as="script" rel="preload" href="./5e77110b.js"><link as="style" rel="preload" href="./assets/blog-base-ed21726f.css"><link as="style" rel="preload" href="./5e77110b.css"><link href="./assets/blog-base-ed21726f.css" rel="stylesheet"><link href="./5e77110b.css" rel="stylesheet">
</head>

<body>
  <div id="app">

<a href="#content" class="skip svelte-2w4dum">Skip to content</a>
<header class="svelte-f3e4uo"><nav><ul class="svelte-f3e4uo"><li class="svelte-f3e4uo"><a href="/" class="svelte-f3e4uo">Tan Li Hau</a></li>
    <li class="svelte-f3e4uo"><a href="/about" class="svelte-f3e4uo">About</a></li>
    <li class="svelte-f3e4uo"><a href="/blogs" class="svelte-f3e4uo">Writings</a></li>
    <li class="svelte-f3e4uo"><a href="/talks" class="svelte-f3e4uo">Talks</a></li>
    <li class="svelte-f3e4uo"><a href="/notes" class="svelte-f3e4uo">Notes</a></li>
    <li class="svelte-f3e4uo"><a href="/newsletter" class="svelte-f3e4uo">Newsletter</a></li>
    <li class="social svelte-f3e4uo"><a aria-label="Twitter account" href="https://twitter.com/lihautan" class="svelte-f3e4uo"><svg viewBox="0 0 24 24" class="svelte-f3e4uo"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66
    10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5
    4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
      <a aria-label="Github account" href="https://github.com/tanhauhau" class="svelte-f3e4uo"><svg viewBox="0 0 24 24" class="svelte-f3e4uo"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0
    0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07
    5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65
    5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42
    3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li></ul></nav>
</header>

<main id="content" class="blog svelte-2w4dum"><h1>Compile Svelte in your head (Part 2)</h1>
  
  <span class="svelte-2w4dum">Svelte</span><span class="svelte-2w4dum">JavaScript</span>

  <article><section><ul class="sitemap" id="sitemap" role="navigation" aria-label="Table of Contents"><li><a href="#pre-v">Pre v3.16.0</a></li><ul><li><a href="#ctx">\$\$.ctx</a></li><li><a href="#dirty">\$\$.dirty</a></li><li><a href="#invalidate">\$\$invalidate</a></li><li><a href="#schedule-update">schedule_update</a></li><ul><li><a href="#tl-dr">tl/dr:</a></li></ul></ul><li><a href="#v">v3.16.0</a></li><ul><li><a href="#bitmask">Bitmask</a></li><li><a href="#bitmask-in-svelte">Bitmask in Svelte</a></li><ul><li><a href="#destructuring">Destructuring  </a></li><li><a href="#tl-dr">tl/dr:</a></li></ul></ul><li><a href="#reactive-declaration">Reactive Declaration</a></li><ul><ul><li><a href="#execution-of-all-reactive-declarations-and-statements-are-batched">1. Execution of all reactive declarations and statements are batched</a></li><li><a href="#the-value-of-reactive-variable-outside-of-reactive-declarations-and-statements-may-not-be-up-to-date">2. The value of reactive variable outside of reactive declarations and statements may not be up to date</a></li></ul><li><a href="#sorting-of-reactive-declarations-and-statements">Sorting of reactive declarations and statements</a></li><li><a href="#reactive-variable-that-is-not-reactive">Reactive variable that is not reactive</a></li></ul><li><a href="#summary">Summary</a></li><ul><ul><li><a href="#svelte-keeps-track-of-which-variables-are-dirty-and-batched-the-dom-updates">1. Svelte keeps track of which variables are dirty and batched the DOM updates.</a></li><li><a href="#using-bitmask-svelte-able-to-generate-a-more-compact-compiled-code">2. Using bitmask, Svelte able to generate a more compact compiled code.</a></li><li><a href="#reactive-declarations-and-statements-are-executed-in-batch-just-like-dom-updates">3. Reactive declarations and statements are executed in batch, just like DOM updates</a></li></ul></ul><li><a href="#closing-note">Closing Note</a></li><li><a href="#further-resources">Further Resources</a></li></ul></section>
<p><strong>⬅ ⬅  Previously in <a href="/compile-svelte-in-your-head-part-1/">Part 1</a>.</strong></p>
<p><a href="/compile-svelte-in-your-head-part-1/">Previously</a>, when I mentioned the <code>$$invalidate</code> function, I explained that the <code>$$invalidate</code> function works conceptually like the following:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// conceptually...</span>
<span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token comment">/*...*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fragment <span class="token operator">=</span> <span class="token function">create_fragment</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// to track which variable has changed</span>
<span class="token keyword">const</span> dirty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">$$invalidate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">variable<span class="token punctuation">,</span> newValue</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// update ctx</span>
  ctx<span class="token punctuation">[</span>variable<span class="token punctuation">]</span> <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
  <span class="token comment">// mark variable as dirty</span>
  dirty<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>variable<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// schedules update for the component</span>
  <span class="token function">scheduleUpdate</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// gets called when update is scheduled</span>
<span class="token keyword">function</span> <span class="token function">flushUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// update the fragment</span>
  fragment<span class="token punctuation">.</span><span class="token function">p</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// clear the dirty</span>
  dirty<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>but that&#39;s not the exact implementation of the <code>$$invaldiate</code> function. So in this article, we are going to look at how <code>$$invalidate</code> is implemented in Svelte.</p>
<p>At the point of writing, Svelte is at <a href="https://github.com/sveltejs/svelte/blob/v3.20.1/CHANGELOG.md#3201" rel="nofollow">v3.20.1</a>.</p>
<section><h2><a href="#pre-v" id="pre-v">Pre v3.16.0</a></h2>
<p>There&#39;s a big optimisation that changes the underlying implementation of the <code>$$invalidate</code> function in <a href="https://github.com/sveltejs/svelte/blob/master/CHANGELOG.md#3160" rel="nofollow">v3.16.0</a>, namely in <a href="https://github.com/sveltejs/svelte/pull/3945" rel="nofollow">#3945</a>. The underlying concept doesn&#39;t change, but it&#39;ll be much easier to understand about <code>$$invalidate</code> prior the change and learn about the optimisation change separately.</p>
<p>Let&#39;s explain some of the variables that you are going to see, some of which was introduced in <a href="/compile-svelte-in-your-head-part-1">Part 1</a>:</p></section>
<section><h3><a href="#ctx" id="ctx">\$\$.ctx</a></h3>
<p>There&#39;s no official name for it. You can call it <strong>context</strong> as it is the context which the template is based on to render onto the DOM.</p>
<p>I called it <a href="/compile-svelte-in-your-head-part-1#instance-variable">instance variables</a>. As it is a JavaScript Object that contains all the variables that you:</p>
<ul><li>declared in the <code>&lt;script&gt;</code> tag</li>
<li>mutated or reassigned</li>
<li>referenced in the template</li></ul>
<p>that belongs to a component instance.</p>
<p>The instance variables themselves can be of a primitive value, object, array or function.</p>
<p>The <code>instance</code> function creates and returns the <code>ctx</code> object.</p>
<p>Functions declared in the <code>&lt;script&gt;</code> tag will refer to the instance variable that is scoped withn the <code>instance</code> function closure:</p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
  let name = &#39;world&#39;;
  function update() &#123;
    name = &#39;Svelte&#39;;
  &#125;
&lt;/script&gt;
&lt;button on:click=&#123;update&#125;&gt;&#123;name&#125;&lt;/button&gt;</code></pre>
<p><a href="https://svelte.dev/repl/5b12ff52c2874f4dbb6405d9133b34da?version=3.20.1" rel="nofollow">Svelte REPL</a></p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// ...</span>
<span class="token keyword">function</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token parameter">$$self<span class="token punctuation">,</span> $$props<span class="token punctuation">,</span> $$invalidate</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'world'</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'Svelte'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> name<span class="token punctuation">,</span> update <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// ...some where in &#96;create_fragment&#96;</span>
ctx<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// logs &#96;world&#96; scoped in the &#96;instance&#96; closure</span></code></pre>
<p>Whenever a new instance of a component is created, the <code>instance</code> function is called and the <code>ctx</code> object is created and captured within a new closure scope.</p></section>
<section><h3><a href="#dirty" id="dirty">\$\$.dirty</a></h3>
<p><code>$$.dirty</code> is a object that is used to track which instance variable had just changed and needs to be updated onto the DOM.</p>
<p>For example, in the following Svelte component:</p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
  let agility = 0;
  let power = 0;
  function incrementAgility() &#123;
    agility ++;
  &#125;
  function incrementPower() &#123;
    power ++;
  &#125;
  function levelUp() &#123;
    agility += 5;
    power += 7;
  &#125;
&lt;/script&gt;

Agility: &#123;agility&#125;
Power: &#123;power&#125;
Stats: &#123;agility * power&#125;

&lt;button on:click=&#123;incrementAgility&#125;&gt;+ Agility&lt;/button&gt;
&lt;button on:click=&#123;incrementPower&#125;&gt;+ Power&lt;/button&gt;
&lt;button on:click=&#123;levelUp&#125;&gt;Level Up&lt;/button&gt;</code></pre>
<p><a href="https://svelte.dev/repl/da579d0113b44f01b2b94893dce21487?version=3.20.1" rel="nofollow">Svelte REPL</a></p>
<p>The initial <code>$$.dirty</code> is <code>null</code> (<a href="https://github.com/sveltejs/svelte/blob/v3.15.0/src/runtime/internal/Component.ts#L124" rel="nofollow">source code</a>).</p>
<p>If you clicked on the <strong>&quot;+ Agility&quot;</strong> button, <code>$$.dirty</code> will turn into:</p>
<pre class="language-js">
<code class="language-js"><span class="token punctuation">&#123;</span> agility<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span></code></pre>
<p>If you clicked on the <strong>&quot;Level Up&quot;</strong> button, <code>$$.dirty</code> will turn into:</p>
<pre class="language-js">
<code class="language-js"><span class="token punctuation">&#123;</span> agility<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> power<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span></code></pre>
<p><code>$$.dirty</code> is useful for Svelte, so that it doesn&#39;t update the DOM unnecessarily.</p>
<p>If you looked at the <strong>p (u_p_date)</strong> function of the compiled code, you will see Svelte checks whether a variable is marked in <code>$$.dirty</code>, before updating the DOM.</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// NOTE: $$.dirty is passed into the &#96;p&#96; function as &#96;changed&#96;</span>
<span class="token function">p</span><span class="token punctuation">(</span><span class="token parameter">changed<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// checked if agility has changed before update the agility text</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">.</span>agility<span class="token punctuation">)</span> <span class="token function">set_data</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>agility<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">.</span>power<span class="token punctuation">)</span> <span class="token function">set_data</span><span class="token punctuation">(</span>t3<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>power<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// if either agility or power has changed, update the stats text</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>changed<span class="token punctuation">.</span>agility <span class="token operator">||</span> changed<span class="token punctuation">.</span>power<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> t5_value <span class="token operator">!==</span> <span class="token punctuation">(</span>t5_value <span class="token operator">=</span> ctx<span class="token punctuation">.</span>agility <span class="token operator">*</span> ctx<span class="token punctuation">.</span>power <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">set_data</span><span class="token punctuation">(</span>t5<span class="token punctuation">,</span> t5_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>After Svelte updates the DOM, the <code>$$.dirty</code> is set back to <code>null</code> to indicate all changes has been applied onto the DOM.</p></section>
<section><h3><a href="#invalidate" id="invalidate">\$\$invalidate</a></h3>
<p><code>$$invalidate</code> is the secret behind reactivity in Svelte.</p>
<p>Whenever a variable is</p>
<ul><li>reassigned <code>(foo = 1)</code></li>
<li>mutated <code>(foo.bar = 1)</code></li></ul>
<p>Svelte will wrap the assignment or update around with the <code>$$invalidate</code> function:</p>
<pre class="language-js">
<code class="language-js">name <span class="token operator">=</span> <span class="token string">'Svelte'</span><span class="token punctuation">;</span>
count<span class="token operator">++</span><span class="token punctuation">;</span>
foo<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
bar <span class="token operator">=</span> baz <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">// compiled into</span>
<span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">'Svelte'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> count<span class="token operator">++</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>foo<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>bar <span class="token operator">=</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>baz <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>the <code>$$invalidate</code> function will:</p>
<ol><li>update the variable in <code>$$.ctx</code></li>
<li>mark the variable in <code>$$.dirty</code></li>
<li>schedule an update</li>
<li>return the value of the assignment or update expression</li></ol>
<pre class="language-js">
<code class="language-js"><span class="token comment">// src/runtime/internal/Component.ts</span>
<span class="token keyword">const</span> <span class="token function-variable function">$$invalidate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> value <span class="token operator">=</span> ret</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">.</span>ctx <span class="token operator">&amp;&amp;</span> <span class="token function">not_equal</span><span class="token punctuation">(</span>$$<span class="token punctuation">.</span>ctx<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1. update the variable in $$.ctx</span>
    $$<span class="token punctuation">.</span>ctx<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 2a. mark the variable in $$.dirty</span>
    <span class="token function">make_dirty</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 4. return the value of the assignment or update expression</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// src/runtime/internal/Component.ts</span>
<span class="token keyword">function</span> <span class="token function">make_dirty</span><span class="token punctuation">(</span><span class="token parameter">component<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    dirty_components<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. schedule an update</span>
    <span class="token function">schedule_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// initialise $$.dirty</span>
    component<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token function">blank_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 2b. mark the variable in $$.dirty</span>
  component<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p><a href="https://github.com/sveltejs/svelte/blob/v3.15.0/src/runtime/internal/Component.ts#L130-L136" rel="nofollow">Source code</a></p>
<p>One interesting note about the function <code>$$invalidate</code> is that, it wraps around the assignment or update expression and returns what the expression evaluates to.</p>
<p>This makes <code>$$invalidate</code> chainable:</p>
<pre class="language-js">
<code class="language-js">obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  b<span class="token punctuation">:</span> <span class="token punctuation">(</span>foo <span class="token operator">=</span> bar<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

obj<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>

<span class="token punctuation">(</span><span class="token punctuation">&#123;</span> a<span class="token punctuation">:</span> c <span class="token operator">=</span> d<span class="token operator">++</span><span class="token punctuation">,</span> b <span class="token punctuation">&#125;</span> <span class="token operator">=</span> baz <span class="token operator">=</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// assuming all variables are referenced in the template</span>
<span class="token comment">// the above compiles into</span>

<span class="token function">$$invalidate</span><span class="token punctuation">(</span>
  <span class="token string">'obj'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>obj <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    b<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>foo <span class="token operator">=</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> bar<span class="token operator">++</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'obj'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">$$invalidate</span><span class="token punctuation">(</span>
  <span class="token string">'c'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">&#123;</span> a<span class="token punctuation">:</span> c <span class="token operator">=</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">,</span> d<span class="token operator">++</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">,</span> b <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'baz'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>baz <span class="token operator">=</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  c<span class="token punctuation">,</span>
  <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>It seemed complex when there&#39;s a lot of assignment or update expressions in 1 statement! 🙈</p>
<p>The 2nd argument of <code>$$invalidate</code> is the assignment or update expressions verbatim. But if it contains any assignment or update sub-expressions, we recursively wrap it with <code>$$invalidate</code>.</p>
<p>In case where the assignment expression changes a property of an object, we pass the object in as a 3rd argument of the <code>$$invalidate</code> function, eg:</p>
<pre class="language-js">
<code class="language-js">obj<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>

<span class="token comment">// compiles into</span>
<span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'obj'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// - it invalidates &#96;obj&#96;</span>
<span class="token comment">// - it returns the evaluated value of the expression &#96;obj.c = 'hello'&#96;, which is 'hello'</span></code></pre>
<p>So that, we update the <code>&quot;obj&quot;</code> variable to <code>obj</code> instead of the value of the 2nd argument, <code>&quot;hello&quot;</code>.</p></section>
<section><h3><a href="#schedule-update" id="schedule-update">schedule_update</a></h3>
<p><code>schedule_update</code> schedules Svelte to update the DOM with the changes made thus far.</p>
<p>Svelte, at the point of writing (<a href="https://github.com/sveltejs/svelte/blob/v3.20.1/CHANGELOG.md#3201" rel="nofollow">v3.20.1</a>), uses <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" rel="nofollow">microtask queue</a> to batch change updates. The actual DOM update happens in the next microtask, so that any synchronous <code>$$invalidate</code> operations that happen within the same task get batched into the next DOM update.</p>
<p>To schedule a next microtask, Svelte uses the Promise callback.</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// src/runtime/internal/scheduler.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">schedule_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>update_scheduled<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    update_scheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// NOTE: &#96;flush&#96; will do the DOM update</span>
    <span class="token comment">// we push it into the microtask queue</span>
    <span class="token comment">// highlight-next-line</span>
    resolved_promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>In <code>flush</code>, we call update for each component marked dirty:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// src/runtime/internal/scheduler.ts</span>
<span class="token keyword">function</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// for each componnet in &#96;dirty_components&#96;</span>
  <span class="token comment">// highlight-start</span>
  <span class="token function">update</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>$$<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// highlight-end</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// src/runtime/internal/scheduler.ts</span>
<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">$$</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">.</span>fragment <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// NOTE: this will be important later</span>
    $$<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>$$<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">run_all</span><span class="token punctuation">(</span>$$<span class="token punctuation">.</span>before_update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// calls the &#96;p&#96; function</span>
    <span class="token comment">// highlight-next-line</span>
    $$<span class="token punctuation">.</span>fragment <span class="token operator">&amp;&amp;</span> $$<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span><span class="token function">p</span><span class="token punctuation">(</span>$$<span class="token punctuation">.</span>dirty<span class="token punctuation">,</span> $$<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// resets &#96;$$.dirty&#96;</span>
    $$<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    $$<span class="token punctuation">.</span>after_update<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>add_render_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p><a href="https://github.com/sveltejs/svelte/blob/v3.15.0/src/runtime/internal/scheduler.ts#L14" rel="nofollow">Source code</a></p>
<p>So, if you write a Svelte component like this:</p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
  let givenName, familyName;
  function update() &#123;
    givenName = &#39;Li Hau&#39;;
    familyName = &#39;Tan&#39;;
  &#125;
&lt;/script&gt;
Name: &#123;familyName&#125; &#123;givenName&#125;

&lt;button on:click=&#123;update&#125;&gt;Update&lt;/button&gt;</code></pre>
<p><a href="https://svelte.dev/repl/761a0a6cc2834afb842942e1d23875b1?version=3.20.1" rel="nofollow">Svelte REPL</a></p>
<p>The DOM update for the <code>givenName</code> and <code>familyName</code> happens in the same microtask:</p>
<ol><li>Click on the <strong>&quot;Update&quot;</strong> to call the <code>update</code> function</li>
<li><code>$$invalidate(&#39;givenName&#39;, givenName = &#39;Li Hau&#39;)</code></li>
<li>Mark the variable <code>givenName</code> dirty, <code>$$.dirty[&#39;givenName&#39;] = true</code></li>
<li>Schedule an update, <code>schedule_update()</code></li>
<li>Since it&#39;s the first update in the call stack, push the <code>flush</code> function into the microtask queue</li>
<li><code>$$invalidate(&#39;familyName&#39;, familyName = &#39;Tan&#39;)</code></li>
<li>Mark the variable <code>familyName</code> dirty, <code>$$.dirty[&#39;familyName&#39;] = true</code></li>
<li>Schedule an update, <code>schedule_update()</code></li>
<li>Since <code>update_scheduled = true</code>, do nothing.</li>
<li><strong>-- End of task --</strong></li>
<li><strong>-- Start of microtask--</strong></li>
<li><code>flush()</code> calls <code>update()</code> for each component marked dirty</li>
<li>Calls <code>$$.fragment.p($$.dirty, $$.ctx)</code>.<ul><li><code>$$.dirty</code> is now <code>{ givenName: true, familyName: true }</code></li>
<li><code>$$.ctx</code> is now <code>{ givenName: &#39;Li Hau&#39;, familyName: &#39;Tan&#39; }</code></li></ul></li>
<li>In <code>function p(dirty, ctx)</code>,<ul><li>Update the 1st text node to <code>$$.ctx[&#39;givenName&#39;]</code> if <code>$$.dirty[&#39;givenName&#39;] === true</code></li>
<li>Update the 2nd text node to <code>$$.ctx[&#39;familyName&#39;]</code> if <code>$$.dirty[&#39;familyName&#39;] === true</code></li></ul></li>
<li>Resets the <code>$$.dirty</code> to <code>null</code></li>
<li>...</li>
<li><strong>-- End of microtask--</strong></li></ol></section>
<section><h4><a href="#tl-dr" id="tl-dr">tl/dr:</a></h4>
<ul><li>For each assignment or update, Svelte calls <code>$$invalidate</code> to update the variable in <code>$$.ctx</code> and mark the variable dirty in <code>$$.dirty</code>.</li>
<li>The acutal DOM update is batched into the next microtask queue.</li>
<li>To update the DOM for each component, the component <code>$$.fragment.p($$.diry, $$.ctx)</code> is called.</li>
<li>After the DOM update, the <code>$$.dirty</code> is reset to <code>null</code>.</li></ul></section>
<section><h2><a href="#v" id="v">v3.16.0</a></h2>
<p>One big change in v3.16.0 is the PR <a href="https://github.com/sveltejs/svelte/pull/3945" rel="nofollow">#3945</a>, namely <strong>bitmask-based change tracking</strong>.</p>
<p>Instead of marking the variable dirty using an object:</p>
<pre class="language-js">
<code class="language-js">$$<span class="token punctuation">.</span>diry <span class="token operator">=</span> <span class="token punctuation">&#123;</span> givenName<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> familyName<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code></pre>
<p>Svelte assign each variable an index:</p>
<pre class="language-js">
<code class="language-js">givenName <span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span>
familyName <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span></code></pre>
<p>and uses <a href="https://en.wikipedia.org/wiki/Mask_(computing)" rel="nofollow">bitmask</a> to store the dirty information:</p>
<pre class="language-js">
<code class="language-js">$$<span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0b0000_0011</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// the 0th and 1st bit marked true</span></code></pre>
<p>which is far more compact than the previous compiled code.</p></section>
<section><h3><a href="#bitmask" id="bitmask">Bitmask</a></h3>
<p>For those who don&#39;t understand, allow me to quickly explain what it is.</p>
<p>Of course, if you want to learn more about it, feel free to read a more detailed explanation, like <a href="https://blog.bitsrc.io/the-art-of-bitmasking-ec58ab1b4c03" rel="nofollow">this</a> and <a href="https://dev.to/somedood/bitmasks-a-very-esoteric-and-impractical-way-of-managing-booleans-1hlf" rel="nofollow">this</a>.</p>
<p>The most compact way of representing a group of <code>true</code> or <code>false</code> is to use bits. If the bit is <code>1</code> it is <code>true</code> and if it is <code>0</code> it is <code>false</code>.</p>
<p>A number can be represented in binary, <strong>5</strong> is <code>0b0101</code> in binary.</p>
<p>If <strong>5</strong> is represented in a 4-bit binary, then it can store 4 boolean values, with the 0th and 2nd bit as <code>true</code> and 1st and 3rd bit as <code>false</code>, (reading from the right to left, from <a href="https://en.wikipedia.org/wiki/Bit_numbering#Least_significant_bit" rel="nofollow">least significant bit</a> to the <a href="https://en.wikipedia.org/wiki/Bit_numbering#Most_significant_bit" rel="nofollow">most significant bit</a>).</p>
<p><strong>How many boolean values can a number store?</strong></p>
<p>That depends on the language, a 16-bit integer in Java can store 16 boolean values.</p>
<p>In JavaScript, numbers can are <a href="https://2ality.com/2012/04/number-encoding.html" rel="nofollow">represented in 64 bits</a>. However, when using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators" rel="nofollow">bitwise operations</a> on the number, JavaScript will treat the number as 32 bits.</p>
<p>To inspect or modify the boolean value stored in a number, we use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators" rel="nofollow">bitwise operations</a>.</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// set 1st boolean to true</span>
<span class="token number">0b0101</span> <span class="token operator">|</span> <span class="token number">0b0010</span> <span class="token operator">=</span> <span class="token number">0b0111</span><span class="token punctuation">;</span>

<span class="token comment">// set 2nd boolean to false</span>
<span class="token number">0b0101</span> <span class="token operator">&amp;</span> <span class="token number">0b1011</span> <span class="token operator">=</span> <span class="token number">0b0001</span><span class="token punctuation">;</span>

<span class="token comment">// is 2nd boolean true?</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0b0101</span> <span class="token operator">&amp;</span> <span class="token number">0b0100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// NOTE: You can test multiple boolean values at once</span>
<span class="token comment">// is 2nd and 3rd boolean true?</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0b0101</span> <span class="token operator">&amp;</span> <span class="token number">0b1100</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span></code></pre>
<p>The 2nd operand we use in the bitwise operation, is like a <a href="https://en.wikipedia.org/wiki/Mask_(computing)" rel="nofollow">mask</a> that allow us to target a specific bit in the 1st number, that stores our boolean values.</p>
<p>We call the mask, <strong>bitmask</strong>.</p></section>
<section><h3><a href="#bitmask-in-svelte" id="bitmask-in-svelte">Bitmask in Svelte</a></h3>
<p>As mentioned earlier, we assign each variable an index:</p>
<pre class="language-js">
<code class="language-js">givenName <span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span>
firstName <span class="token operator">-</span><span class="token operator">></span> <span class="token number">1</span></code></pre>
<p>So instead of returning the instance variable as an JavaScript Object, we now return it as an JavaScript Array:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// Previous</span>
<span class="token keyword">function</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token parameter">$$self<span class="token punctuation">,</span> $$props<span class="token punctuation">,</span> $$invalidate</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> givenName<span class="token punctuation">,</span> familyName <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Now</span>
<span class="token keyword">function</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token parameter">$$self<span class="token punctuation">,</span> $$props<span class="token punctuation">,</span> $$invalidate</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>givenName<span class="token punctuation">,</span> familyName<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>The variable is accessed via <strong>index</strong>, <code>$$.ctx[index]</code>, instead of <strong>variable name</strong>:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// Previous</span>
$$<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>givenName <span class="token operator">+</span> $$<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>familyName<span class="token punctuation">;</span>
<span class="token comment">// Now</span>
$$<span class="token punctuation">.</span>ctx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> $$<span class="token punctuation">.</span>ctx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p>The <code>$$invalidate</code> function works the same, except it takes in <strong>index</strong> instead of <strong>variable name</strong>:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// Previous</span>
<span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token string">'givenName'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>givenName <span class="token operator">=</span> <span class="token string">'Li Hau'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Now</span>
<span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>givenName <span class="token operator">=</span> <span class="token string">'Li Hau'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><code>$$.dirty</code> now stores a list of numbers. Each number carries 31 boolean values, each boolean value indicates whether the variable of that index is dirty or not.</p>
<p>To set a variable as dirty, we use bitwise operation:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// Previous</span>
$$<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span><span class="token string">'givenName'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token comment">// Now</span>
$$<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span></code></pre>
<p>And to verify whether a variable is dirty, we use bitwise operation too!</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// Previous</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>$dirty<span class="token punctuation">.</span>givenName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>$dirty<span class="token punctuation">.</span>givenName <span class="token operator">&amp;&amp;</span> $dirty<span class="token punctuation">.</span>familyName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>

<span class="token comment">// Now</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>$dirty<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>$dirty<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span></code></pre>
<p>With using bitmask, <code>$$.dirty</code> is now reset to <code>[-1]</code> instead of <code>null</code>.</p>
<p><strong>Trivia:</strong> <code>-1</code> is <code>0b1111_1111</code> in binary, where all the bits are <code>1</code>.</p></section>
<section><h4><a href="#destructuring" id="destructuring">Destructuring <strong>$$.dirty</strong></a></h4>
<p>One code-size optimisation that Svelte does is to always destructure the <code>dirty</code> array in the <strong>u_p_date function</strong> if there&#39;s less than 32 variables, since we will always access <code>dirty[0]</code> anyway:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// If less than 32 variables,</span>
<span class="token comment">// Instead of having &#96;dirty[0]&#96; all the time,</span>
p<span class="token punctuation">:</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> dirty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// Svelte optimises the compiled code by </span>
<span class="token comment">// destruct the array in the arguments</span>
p<span class="token punctuation">:</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token punctuation">[</span>dirty<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// If more than or equal to 32 variables</span>
p<span class="token punctuation">:</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> dirty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre></section>
<section><h4><a href="#tl-dr" id="tl-dr">tl/dr:</a></h4>
<ul><li>The underlying mechanism for <code>$$invalidate</code> and <code>schedule_update</code> does not change</li>
<li>Using bitmask, the compiled code is much compact</li></ul></section>
<section><h2><a href="#reactive-declaration" id="reactive-declaration">Reactive Declaration</a></h2>
<p>Svelte allow us to declare reactive values via the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/label" rel="nofollow">labeled statement</a>, <code>$: </code></p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
  export let count = 0;
  // &#96;doubled&#96;, &#96;tripled&#96;, &#96;quadrupled&#96; are reactive
  // highlight-start
  $: doubled = count * 2;
  $: tripled = count * 3;
  $: quadrupled = doubled * 2;
  // highlight-end
&lt;/script&gt;

&#123;doubled&#125; &#123;tripled&#125; &#123;quadrupled&#125;</code></pre>
<p><a href="https://svelte.dev/repl/e37329dd126448b2aa0679c08993f9a8?version=3.20.1" rel="nofollow">Svelte REPL</a></p>
<p>If you look at the compiled output, you would find out that the declarative statements appeared in the <a href="/compile-svelte-in-your-head-part-1/#instanceself-props-invalidate"><code>instance</code> function</a>:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">function</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token parameter">$$self<span class="token punctuation">,</span> $$props<span class="token punctuation">,</span> $$invalidate</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>

  <span class="token comment">// highlight-start</span>
	$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty <span class="token operator">&amp;</span> <span class="token comment">/*count*/</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			$<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> doubled <span class="token operator">=</span> count <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty <span class="token operator">&amp;</span> <span class="token comment">/*count*/</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			$<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> tripled <span class="token operator">=</span> count <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty <span class="token operator">&amp;</span> <span class="token comment">/*doubled*/</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			$<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> quadrupled <span class="token operator">=</span> doubled <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token comment">// highlight-end</span>

	<span class="token keyword">return</span> <span class="token punctuation">[</span>doubled<span class="token punctuation">,</span> tripled<span class="token punctuation">,</span> quadrupled<span class="token punctuation">,</span> count<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>Try reorder the reactive declarations and observe the change in the compiled output:</p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
  export let count = 0;
  // NOTE: move &#96;quadrupled&#96; before &#96;doubled&#96;
  // highlight-start
  $: quadrupled = doubled * 2;
  $: doubled = count * 2;
  // highlight-end
  $: tripled = count * 3;
&lt;/script&gt;</code></pre>
<p><a href="https://svelte.dev/repl/fc6995856489402d90291c4c30952939?version=3.20.1" rel="nofollow">Svelte REPL</a></p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">function</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token parameter">$$self<span class="token punctuation">,</span> $$props<span class="token punctuation">,</span> $$invalidate</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// ...</span>

	$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// NOTE: &#96;quadrupled&#96; invalidates after &#96;doubled&#96;</span>
		<span class="token comment">// highlight-start</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty <span class="token operator">&amp;</span> <span class="token comment">/*count*/</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			$<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>doubled <span class="token operator">=</span> count <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty <span class="token operator">&amp;</span> <span class="token comment">/*doubled*/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			$<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>quadrupled <span class="token operator">=</span> doubled <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token comment">// highlight-end</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty <span class="token operator">&amp;</span> <span class="token comment">/*count*/</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			$<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tripled <span class="token operator">=</span> count <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token punctuation">[</span>doubled<span class="token punctuation">,</span> tripled<span class="token punctuation">,</span> quadrupled<span class="token punctuation">,</span> count<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>Some observations:</p>
<ul><li>When there are reactive declarations, Svelte defines a custom <code>$$.update</code> method.<ul><li><code>$$.update</code> is a <a href="https://en.wikipedia.org/wiki/NOP_(code)" rel="nofollow">no-op function</a> by default. (See <a href="https://github.com/sveltejs/svelte/blob/v3.20.1/src/runtime/internal/Component.ts#L111" rel="nofollow">src/runtime/internal/Component.ts</a>)</li></ul></li>
<li>Svelte uses <code>$$invalidate</code> to update the value of a reactive variable too.</li>
<li>Svelte sorts the reactive declarations and statements, based on the dependency relationship between the declarations and statements<ul><li><code>quadrupled</code> depends on <code>doubled</code>, so <code>quadrupled</code> is evaluated and <code>$$invalidate</code>d after <code>doubled</code>.</li></ul></li></ul>
<p>Since all reactive declarations and statements are grouped into the <code>$$.update</code> method, and also the fact that Svelte will sort the declarations and statements according to their dependency relationship, it is irrelevant of the location or the order you declared them.</p>
<p>The following component still works:</p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
// NOTE: use &#96;count&#96; in a reactive declaration before &#96;count&#96; is declared
$: doubled = count * 2;
let count = 1;
&lt;/script&gt;

&#123;count&#125; * 2 = &#123;doubled&#125;</code></pre>
<p><a href="https://svelte.dev/repl/fc6995856489402d90291c4c30952939?version=3.20.1" rel="nofollow">Svelte REPL</a></p>
<p><strong>The next thing you may ask, when is <code>$$.update</code> being called?</strong></p>
<p>Remember the <code>update</code> function that gets called in the <code>flush</code> function?</p>
<p>I put a <code>NOTE:</code> comment saying that it will be important later. Well, it is important now.</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// src/runtime/internal/scheduler.ts</span>
<span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">$$</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">.</span>fragment <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// NOTE: this is important now!</span>
    <span class="token comment">// highlight-next-line</span>
    $$<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>$$<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">run_all</span><span class="token punctuation">(</span>$$<span class="token punctuation">.</span>before_update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// calls the &#96;p&#96; function</span>
    $$<span class="token punctuation">.</span>fragment <span class="token operator">&amp;&amp;</span> $$<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span><span class="token function">p</span><span class="token punctuation">(</span>$$<span class="token punctuation">.</span>dirty<span class="token punctuation">,</span> $$<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>The <code>$$.update</code> function gets called <strong>in the same microtask</strong> with the DOM update, right before we called the <code>$$.fragment.p()</code> to update the DOM.</p>
<p>The implication of the above fact is</p></section>
<section><h4><a href="#execution-of-all-reactive-declarations-and-statements-are-batched" id="execution-of-all-reactive-declarations-and-statements-are-batched">1. Execution of all reactive declarations and statements are batched</a></h4>
<p>Just as how DOM updates are batched, reactive declarations and statements are batched too!</p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
  let givenName = &#39;&#39;, familyName = &#39;&#39;;
  function update() &#123;
    givenName = &#39;Li Hau&#39;;
    familyName = &#39;Tan&#39;;
  &#125;
  $: name = givenName + &quot; &quot; + familyName;
  $: console.log(&#39;name&#39;, name);
&lt;/script&gt;</code></pre>
<p><a href="https://svelte.dev/repl/941195f1cd5248e9bd14613f9513ad1d?version=3.20.1" rel="nofollow">Svelte REPL</a></p>
<p>When <code>update()</code> get called,</p>
<ol><li>Similar to the <a href="#schedule_update">flow described above</a>, <code>$$invalidate</code> both <strong>&quot;givenName&quot;</strong> and <strong>&quot;familyName&quot;</strong>, and schedules an update</li>
<li><strong>-- End of task --</strong></li>
<li><strong>-- Start of microtask--</strong></li>
<li><code>flush()</code> calls <code>update()</code> for each component marked dirty</li>
<li>Runs <code>$$.update()</code><ul><li>As <strong>&quot;givenName&quot;</strong> and <strong>&quot;familyName&quot;</strong> has changed, evaluates and <code>$$invalidate</code> <strong>&quot;name&quot;</strong></li>
<li>As <strong>&quot;name&quot;</strong> has changed, executes <code>console.log(&#39;name&#39;, name);</code></li></ul></li>
<li>Calls <code>$$.fragment.p(...)</code> to update the DOM.</li></ol>
<p>As you can see, even though we&#39;ve updated <code>givenName</code> and <code>familyName</code>, we only evaluate <code>name</code> and executes <code>console.log(&#39;name&#39;, name)</code> <strong>once</strong> instead of twice:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// Instead of</span>
<span class="token comment">// #1 &#96;givenName = 'Li Hau'</span>
name <span class="token operator">=</span> <span class="token string">'Li Hau'</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Li Hau '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// #2 &#96;familyName = 'Tan'</span>
name <span class="token operator">=</span> <span class="token string">'Li Hau'</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'Tan'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Li Hau Tan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Reactive declarations and statements are batched</span>
<span class="token comment">// #1 &#96;givenName = 'Li Hau'</span>
<span class="token comment">// #2 &#96;familyName = 'Tan'</span>
name <span class="token operator">=</span> <span class="token string">'Li Hau'</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> <span class="token string">'Tan'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Li Hau Tan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section>
<section><h4><a href="#the-value-of-reactive-variable-outside-of-reactive-declarations-and-statements-may-not-be-up-to-date" id="the-value-of-reactive-variable-outside-of-reactive-declarations-and-statements-may-not-be-up-to-date">2. The value of reactive variable outside of reactive declarations and statements may not be up to date</a></h4>
<p>Because the reactive declarations and statements are batched and executed in the next microtask, you can&#39;t expect the value to be updated synchronously.</p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
  let givenName = &#39;&#39;, familyName = &#39;&#39;;
  function update() &#123;
    givenName = &#39;Li Hau&#39;;
    familyName = &#39;Tan&#39;;
    // highlight-next-line
    console.log(&#39;name&#39;, name); // Logs &#39;&#39;
  &#125;
  $: name = givenName + &quot; &quot; + familyName;
&lt;/script&gt;</code></pre>
<p><a href="https://svelte.dev/repl/437548d5c7044cb59bfd0c8a0f4c725d?version=3.20.1" rel="nofollow">Svelte REPL</a></p>
<p>Instead, you <strong>have to</strong> refer the reactive variable in another reactive declaration or statement:</p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
  let givenName = &#39;&#39;, familyName = &#39;&#39;;
  function update() &#123;
    givenName = &#39;Li Hau&#39;;
    familyName = &#39;Tan&#39;;
  &#125;
  $: name = givenName + &quot; &quot; + familyName;
  // highlight-next-line
  $: console.log(&#39;name&#39;, name); // Logs &#39;Li Hau Tan&#39;
&lt;/script&gt;</code></pre></section>
<section><h3><a href="#sorting-of-reactive-declarations-and-statements" id="sorting-of-reactive-declarations-and-statements">Sorting of reactive declarations and statements</a></h3>
<p>Svelte tries to preserve the order of reactive declarations and statements as they are declared as much as possible.</p>
<p>However, if one reactive declaration or statement refers to a variable that was defined by another reactive declaration, then, <strong>it will be inserted after the latter reactive declaration</strong>:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// NOTE: refers to &#96;doubled&#96;</span>
$<span class="token punctuation">:</span> quadrupled <span class="token operator">=</span> doubled <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment">// NOTE: defined &#96;doubled&#96;</span>
$<span class="token punctuation">:</span> doubled <span class="token operator">=</span> count <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">// compiles into:</span>

$$self<span class="token punctuation">.</span>$$<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  $<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token comment">/* doubled */</span><span class="token punctuation">,</span> doubled <span class="token operator">=</span> count <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  $<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token comment">/* quadrupled */</span><span class="token punctuation">,</span> quadrupled <span class="token operator">=</span> doubled <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span></code></pre></section>
<section><h3><a href="#reactive-variable-that-is-not-reactive" id="reactive-variable-that-is-not-reactive">Reactive variable that is not reactive</a></h3>
<p>The Svelte compiler tracks all the variables declared in the <code>&lt;script&gt;</code> tag.</p>
<p>If all the variables of a reactive declaration or statement refers to, never gets mutated or reassigned, then the reactive declaration or statement will not be added into <code>$$.update</code>.</p>
<p>For example:</p>
<pre class="language-svelte">
<code class="language-svelte">&lt;script&gt;
  let count = 0;
  $: doubled = count * 2;
&lt;/script&gt;
&#123; count &#125; x 2 = &#123;doubled&#125;</code></pre>
<p><a href="https://svelte.dev/repl/af86472e1f494cfea2efa494f63fff08?version=3.20.1" rel="nofollow">Svelte REPL</a></p>
<p>Since, <code>count</code> never gets mutated or reassigned, Svelte optimises the compiled output by not defining <code>$$self.$$.update</code>.</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// ...</span>
<span class="token keyword">function</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token parameter">$$self<span class="token punctuation">,</span> $$props<span class="token punctuation">,</span> $$invalidate</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> doubled<span class="token punctuation">;</span>
  $<span class="token punctuation">:</span> <span class="token function">$$invalidate</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>doubled <span class="token operator">=</span> count <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>doubled<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre></section>
<section><h2><a href="#summary" id="summary">Summary</a></h2></section>
<section><h4><a href="#svelte-keeps-track-of-which-variables-are-dirty-and-batched-the-dom-updates" id="svelte-keeps-track-of-which-variables-are-dirty-and-batched-the-dom-updates">1. Svelte keeps track of which variables are dirty and batched the DOM updates.</a></h4></section>
<section><h4><a href="#using-bitmask-svelte-able-to-generate-a-more-compact-compiled-code" id="using-bitmask-svelte-able-to-generate-a-more-compact-compiled-code">2. Using bitmask, Svelte able to generate a more compact compiled code.</a></h4></section>
<section><h4><a href="#reactive-declarations-and-statements-are-executed-in-batch-just-like-dom-updates" id="reactive-declarations-and-statements-are-executed-in-batch-just-like-dom-updates">3. Reactive declarations and statements are executed in batch, just like DOM updates</a></h4></section>
<section><h2><a href="#closing-note" id="closing-note">Closing Note</a></h2>
<p>If you wish to know more, <a href="https://twitter.com/lihautan" rel="nofollow">follow me on Twitter</a>.</p>
<p>I&#39;ll post it on Twitter when the next part is ready, where I&#39;ll be covering <a href="https://svelte.dev/tutorial/if-blocks" rel="nofollow">logic blocks</a>, <a href="https://svelte.dev/tutorial/slots" rel="nofollow">slots</a>, <a href="https://svelte.dev/tutorial/context-api" rel="nofollow">context</a>, and many others.</p>
<p><strong>⬅ ⬅  Previously in <a href="/compile-svelte-in-your-head-part-1/">Part 1</a>.</strong></p>
<p><strong>➡ ➡  Continue reading on <a href="/compile-svelte-in-your-head-part-3/">Part 3</a>.</strong></p></section>
<section><h2><a href="#further-resources" id="further-resources">Further Resources</a></h2>
<ul><li>Rich Harris shares about <a href="https://www.youtube.com/watch?v=zq6PpM5t3z0&t=2530s" rel="nofollow">Bitmask Tracking at Svelte Society NYC</a>.</li>
<li>Svelte Tutorial - <a href="https://svelte.dev/tutorial/reactive-assignments" rel="nofollow">Reactivity</a>
<a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/" rel="nofollow">https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/</a></li>
<li><a href="https://blog.bitsrc.io/the-art-of-bitmasking-ec58ab1b4c03" rel="nofollow">The Art of Bitmasking</a> by Shakib Ahmed</li>
<li><a href="https://dev.to/somedood/bitmasks-a-very-esoteric-and-impractical-way-of-managing-booleans-1hlf" rel="nofollow">Bitmasks: A very esoteric (and impractical) way of managing booleans</a> by Basti Ortiz</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators" rel="nofollow">MDN: Bitwise Operators</a></li></ul></section></article></main>

<footer class="svelte-2w4dum"><div class="form svelte-1k1s1co"><h1>Subscribe to my newsletter</h1>
  <h2 class="svelte-1k1s1co">Get the latest blog posts and project updates delivered right to your inbox</h2>
  <form action="https://buttondown.email/api/emails/embed-subscribe/lihautan" method="post" target="popupwindow" onsubmit="window.open('https://buttondown.email/lihautan', 'popupwindow')" class="embeddable-buttondown-form"><div class="form-item svelte-1k1s1co"><input type="email" name="email" id="bd-email" aria-label="email address" placeholder="youremail@example.com" class="svelte-1k1s1co">
      <input type="submit" value="Subscribe" disabled class="svelte-1k1s1co"></div>
    <input type="hidden" value="1" name="embed" class="svelte-1k1s1co">
    <p class="svelte-1k1s1co">Powered by Buttondown.</p></form>
</div></footer>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><script src="./5e77110b.js" async></script></div>
  

  <script>if ('serviceWorker' in navigator) { window.addEventListener('load', function () { navigator.serviceWorker.register('/sw.js'); }); }</script>
  <script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments) }, i[r].l = 1 * new Date(); a = s.createElement(o), m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m) })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga'); if (typeof ga === "function") { ga('create', 'UA-135921142-1', 'auto', {}); }</script>
</body>

</html>