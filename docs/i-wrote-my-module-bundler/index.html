<!DOCTYPE html>
<html lang="en">

<head>
  <meta charSet="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link href="https://lihautan.com" rel="me">
  <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300&display=swap"
    rel="stylesheet">
  <style>
    html {
      font-family: 'Lato', sans-serif;
      font-weight: 300;
      font-size: 19px;
      background: linear-gradient(0deg, transparent, #bd93f917, transparent);
    }

    html,
    body {
      margin: 0;
      padding: 0;
    }

    :root {
      --prism-padding: 20px;
      --margin: 1.62em;
      --box-shadow-size: 6px;
      --box-shadow: var(--box-shadow-size) var(--box-shadow-size) var(--primary-color);
      --box-shadow-hover: 10px 10px var(--primary-color);
      --easing: 200ms ease-in-out;
      --primary-color: #bd93f9;
      --secondary-color: #9547b7;
      --dark-color: #282936;
    }
  </style>

  
  <title>I wrote my module bundler | Tan Li Hau</title><meta name="description" content="In my previous article, I explained how module bundler works. In this article, I am going to show you how I wrote my module bundler..." data-svelte="svelte-n0q11s"><meta name="image" content="https://lihautan.com/i-wrote-my-module-bundler/assets/hero-twitter-01456022.jpg" data-svelte="svelte-n0q11s"><meta name="og:image" content="https://lihautan.com/i-wrote-my-module-bundler/assets/hero-twitter-01456022.jpg" data-svelte="svelte-n0q11s"><meta name="og:title" content="I wrote my module bundler" data-svelte="svelte-n0q11s"><meta name="og:description" content="In my previous article, I explained how module bundler works. In this article, I am going to show you how I wrote my module bundler..." data-svelte="svelte-n0q11s"><meta name="og:type" content="website" data-svelte="svelte-n0q11s"><meta name="twitter:card" content="summary_large_image" data-svelte="svelte-n0q11s"><meta name="twitter:creator" content="@lihautan" data-svelte="svelte-n0q11s"><meta name="twitter:title" content="I wrote my module bundler" data-svelte="svelte-n0q11s"><meta name="twitter:description" content="In my previous article, I explained how module bundler works. In this article, I am going to show you how I wrote my module bundler..." data-svelte="svelte-n0q11s"><meta name="twitter:image" content="https://lihautan.com/i-wrote-my-module-bundler/assets/hero-twitter-01456022.jpg" data-svelte="svelte-n0q11s"><meta name="keywords" content="JavaScript" data-svelte="svelte-n0q11s"><meta name="keywords" content="module bundler" data-svelte="svelte-n0q11s"><meta name="keywords" content="dev tool" data-svelte="svelte-n0q11s"><meta name="keywords" content="webpack" data-svelte="svelte-n0q11s"><meta itemprop="url" content="https%3A%2F%2Flihautan.com%2Fi-wrote-my-module-bundler" data-svelte="svelte-n0q11s"><meta itemprop="image" content="https://lihautan.com/i-wrote-my-module-bundler/assets/hero-twitter-01456022.jpg" data-svelte="svelte-n0q11s"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","author":{"@type":"Person","name":"Tan Li Hau"},"copyrightHolder":{"@type":"Person","name":"Tan Li Hau"},"copyrightYear":"2020","creator":{"@type":"Person","name":"Tan Li Hau"},"publisher":{"@type":"Person","name":"Tan Li Hau"},"description":"In my previous article, I explained how module bundler works. In this article, I am going to show you how I wrote my module bundler...","headline":"I wrote my module bundler","name":"I wrote my module bundler","inLanguage":"en"}</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","description":"Breadcrumbs list","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","item":{"@id":"https://lihautan.com","name":"Homepage"},"position":1},{"@type":"ListItem","item":{"@id":"https%3A%2F%2Flihautan.com%2Fi-wrote-my-module-bundler","name":"I wrote my module bundler"},"position":2}]}</script><link as="script" rel="preload" href="./5289afe6.js"><link as="style" rel="preload" href="./assets/_blog-299aa480.css"><link as="style" rel="preload" href="./5289afe6.css"><link href="./assets/_blog-299aa480.css" rel="stylesheet"><link href="./5289afe6.css" rel="stylesheet">
</head>

<body>
  <div id="app">

<a href="#content" class="skip svelte-2w4dum">Skip to content</a>
<header class="svelte-f3e4uo"><nav><ul class="svelte-f3e4uo"><li class="svelte-f3e4uo"><a href="/" class="svelte-f3e4uo">Tan Li Hau</a></li>
    <li class="svelte-f3e4uo"><a href="/about" class="svelte-f3e4uo">About</a></li>
    <li class="svelte-f3e4uo"><a href="/blogs" class="svelte-f3e4uo">Writings</a></li>
    <li class="svelte-f3e4uo"><a href="/talks" class="svelte-f3e4uo">Talks</a></li>
    <li class="svelte-f3e4uo"><a href="/notes" class="svelte-f3e4uo">Notes</a></li>
    <li class="svelte-f3e4uo"><a href="/newsletter" class="svelte-f3e4uo">Newsletter</a></li>
    <li class="social svelte-f3e4uo"><a href="https://twitter.com/lihautan" class="svelte-f3e4uo"><svg viewBox="0 0 24 24" class="svelte-f3e4uo"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66
    10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5
    4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
      <a href="https://github.com/tanhauhau" class="svelte-f3e4uo"><svg viewBox="0 0 24 24" class="svelte-f3e4uo"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0
    0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07
    5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65
    5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42
    3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li></ul></nav>
</header>

<main id="content" class="blog svelte-2w4dum"><h1>I wrote my module bundler</h1>
  
  <span class="svelte-2w4dum">JavaScript</span><span class="svelte-2w4dum">module bundler</span><span class="svelte-2w4dum">dev tool</span><span class="svelte-2w4dum">webpack</span>

  <article><section><ul class="sitemap" id="sitemap" role="navigation" aria-label="Table of Contents"><li><a href="#getting-started">Getting Started</a></li><ul><li><a href="#the-input">The Input</a></li></ul><li><a href="#writing">Writing</a></li><li><a href="#resolving">Resolving</a></li><li><a href="#bundling">Bundling</a></li><ul><li><a href="#grouping-modules-into-files">Grouping modules into files</a></li><li><a href="#creating-module-map">Creating module map</a></li><li><a href="#"></a></li></ul><li><a href="#optimisation">Optimisation</a></li><ul><li><a href="#circular-dependency">Circular dependency</a></li></ul><li><a href="#summary">Summary</a></li><ul><li><a href="#whats-next">Whats next?</a></li></ul><li><a href="#further-readings">Further Readings</a></li></ul></section>
<p>In my <a href="/what-is-module-bundler-and-how-does-it-work/">previous article</a>, I explained how module bundler works. I used <a href="https://webpack.js.org" rel="nofollow">webpack</a> and <a href="https://rollupjs.org" rel="nofollow">rollup</a> as example, how each of them gave us a different perspective on how we can bundle our JavaScript application.</p>
<p>In this article, I am going to show you how I wrote my module bundler. The module bundler itself is not production-ready, yet I learned a ton through the exercise, and I am ever more appreciative of what modern module bundlers have provided.</p>
<hr>
<p>‚ö†Ô∏è <strong>Warning: Tons of JavaScript code ahead. üôàüò±üò®</strong> ‚ö†Ô∏è</p>
<hr>
<section><h2><a href="#getting-started" id="getting-started">Getting Started</a></h2>
<p>I talked about the input (the JavaScript modules) and the output (the bundled JavaScript file) of a module bundler in <a href="/what-is-module-bundler-and-how-does-it-work/">my previous article</a>. Now it&#39;s time to write a module bundler that takes in the input and produces the output.</p>
<p>A <em>basic</em> module bundler can be broken down into 2 parts:</p>
<ul><li>Understands the code and constructs the dependency graph <strong>(Dependency Resolution)</strong></li>
<li>Assembles the module into a single (or multiple) JavaScript file <strong>(Bundle)</strong></li></ul>
<blockquote><p>A <strong>dependency graph</strong> is a graph representation of the dependency relationship between modules.</p></blockquote></section>
<section><h3><a href="#the-input" id="the-input">The Input</a></h3>
<p>In this article, I will be using following files as my input to the bundler:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// filename: index.js</span>
<span class="token keyword module">import</span> squareArea <span class="token keyword module">from</span> <span class="token string">'./square.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> circleArea <span class="token keyword module">from</span> <span class="token string">'./circle.js'</span><span class="token punctuation">;</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="language-js">
<code class="language-js"><span class="token comment">// filename: square.js</span>
<span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">side</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> side <span class="token operator">*</span> side<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> area<span class="token punctuation">;</span></code></pre>
<pre class="language-js">
<code class="language-js"><span class="token comment">// filename: circle.js</span>
<span class="token keyword">const</span> <span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> area<span class="token punctuation">;</span></code></pre>
<p>I&#39;ve created the project on <a href="https://github.com/tanhauhau/byo-bundler/tree/master/fixture" rel="nofollow">Github</a>, so if you are interested to try out yourself, you can clone it and checkout the <code>fixture-1</code> tag. The input files are in the <code>fixture/</code> folder.</p></section>
<section><h2><a href="#writing" id="writing">Writing</a></h2>
<p>I started with the main structure of the module bundler:</p>

<pre class="language-js">
<code class="language-js"><span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> entryFile<span class="token punctuation">,</span> outputFolder <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// build dependency graph</span>
  <span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token function">createDependencyGraph</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// bundle the asset</span>
  <span class="token keyword">const</span> outputFiles <span class="token operator">=</span> <span class="token function">bundle</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// write to output folder</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> outputFile <span class="token keyword">of</span> outputFiles<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    fs<span class="token punctuation">.</span><span class="token method function property-access">writeFileSync</span><span class="token punctuation">(</span>
      path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>outputFolder<span class="token punctuation">,</span> outputFile<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      outputFile<span class="token punctuation">.</span><span class="token property-access">content</span><span class="token punctuation">,</span>
      <span class="token string">'utf-8'</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<blockquote><p>The <strong>dependency graph</strong> is a <a href="https://en.wikipedia.org/wiki/Directed_graph" rel="nofollow">directed graph</a>, where the vertex is the module, and the directed edge is the dependency relationship between the modules.</p></blockquote>
<pre class="language-js">
<code class="language-js"><span class="token keyword">function</span> <span class="token function">createDependencyGraph</span><span class="token punctuation">(</span><span class="token parameter">entryFile</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> rootModule <span class="token operator">=</span> <span class="token function">createModule</span><span class="token punctuation">(</span>entryFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> rootModule<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>So, the entry module is &quot;the root&quot; of the graph.</p>
<p>In <code>createModule</code>, I instantiate a new <code>Module</code> instance:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">function</span> <span class="token function">createModule</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>The class <code>Module</code> will be used to record module properties, such as the content, the dependencies, exported keys, etc.</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">filePath</span> <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">content</span> <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dependencies</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>While the <code>content</code> is the string content of the module, to understand what it actually means, I used <a href="http://babeljs.io" rel="nofollow">babel</a> to <em>parse the content</em> into AST (Abstract Syntax Tree):</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// highlight-next-line</span>
<span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">filePath</span> <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">content</span> <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// highlight-next-line</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ast</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token method function property-access">parseSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>Next, I need to find out the dependency of this module:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">filePath</span> <span class="token operator">=</span> filePath<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">content</span> <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ast</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token method function property-access">parseSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// highlight-start</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dependencies</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// highlight-end</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>So, how can I know what are the dependencies of this module?</p>
<p>I can look for the <code>import</code> statement from the AST with the help of the
<a href="https://lihautan.com/babel-ast-explorer/#?eyJiYWJlbFNldHRpbmdzIjp7InZlcnNpb24iOiI3LjQuNSJ9LCJ0cmVlU2V0dGluZ3MiOnsiaGlkZUVtcHR5Ijp0cnVlLCJoaWRlTG9jYXRpb24iOnRydWUsImhpZGVUeXBlIjp0cnVlfSwiY29kZSI6ImltcG9ydCBzcXVhcmVBcmVhIGZyb20gJy4vc3F1YXJlLmpzJztcbmltcG9ydCBjaXJjbGVBcmVhIGZyb20gJy4vY2lyY2xlLmpzJztcblxuY29uc29sZS5sb2coJ0FyZWEgb2Ygc3F1YXJlOiAnLCBzcXVhcmVBcmVhKDUpKTtcbmNvbnNvbGUubG9nKCdBcmVhIG9mIGNpcmNsZScsIGNpcmNsZUFyZWEoNSkpO1xuIn0=" rel="nofollow">babel-ast-explorer</a>.</p>
<p><img src="f635154d6a84f142.png" alt="babel-ast-explorer" title="Visualizing AST through babel-ast-explorer"></p>
<p>I found out that the <code>import</code> statement in the AST is called the <code>ImportDeclaration</code>. It has <code>specifiers</code> and <code>source</code>, which the <code>source.value</code> tells us what this module is importing from:</p>
<pre class="language-js">
<code class="language-js"><span class="token function">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// highlight-start</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ast</span><span class="token punctuation">.</span><span class="token property-access">program</span><span class="token punctuation">.</span><span class="token property-access">body</span>
    <span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token arrow operator">=></span> node<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token arrow operator">=></span> node<span class="token punctuation">.</span><span class="token property-access">source</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span>
  <span class="token comment">// highlight-end</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>So I had the path that the module is requesting, but it could be relative to the current file, eg <code>&quot;./foo/bar&quot;</code>, or from the <code>node_modules</code>, eg: <code>&quot;lodash&quot;</code>. How do I know what is the <strong>actual file path</strong> that the module is requesting?</p>
<p>The step of figuring out the actual path based on the requested path, is called <strong>&quot;Resolving&quot;</strong>:</p>
<pre class="language-js">
<code class="language-js"><span class="token function">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ast</span><span class="token punctuation">.</span><span class="token property-access">program</span><span class="token punctuation">.</span><span class="token property-access">body</span>
    <span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token arrow operator">=></span> node<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token arrow operator">=></span> node<span class="token punctuation">.</span><span class="token property-access">source</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span>
  <span class="token comment">// highlight-next-line</span>
    <span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">relativePath</span> <span class="token arrow operator">=></span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">filePath</span><span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// highlight-start</span>
<span class="token comment">// resolving</span>
<span class="token keyword">function</span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span><span class="token parameter">requester<span class="token punctuation">,</span> requestedPath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//</span>
<span class="token punctuation">&#125;</span></code></pre>
<p><em>Resolving path to the actual file path</em></p></section>
<section><h2><a href="#resolving" id="resolving">Resolving</a></h2>
<p>Let&#39;s talk about resolving. We know that &quot;import&quot;ing <code>./b.js</code> in the following examples will result in getting a different file, because when we specify <code>./</code>, we are &quot;import&quot;ing relative to the current file.</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// filename: project/a.js</span>
<span class="token keyword module">import</span> <span class="token string">'./b.js'</span><span class="token punctuation">;</span></code></pre>
<pre class="language-js">
<code class="language-js"><span class="token comment">// filename: project/foo/a.js</span>
<span class="token keyword module">import</span> <span class="token string">'./b.js'</span><span class="token punctuation">;</span></code></pre>
<p>So, what are the rules of resolving a module?</p>
<p>The Node.js documentation has listed out the <a href="http://nodejs.org/api/modules.html#modules_all_together" rel="nofollow">detailed step of the module resolving algorithm</a>:</p>
<p>When we specify a relative path, <code>./b</code>, Node.js will first assume that <code>./b</code> is a file, and tries the following extension if it doesn&#39;t exactly match the file name:</p>
<pre class="language-null">
<code class="language-">b
b.js
b.json
b.node</code></pre>
<p>If the file does not exist, Node.js will then try to treat <code>./b</code> as a directory, and try the following:</p>
<pre class="language-null">
<code class="language-">&quot;main&quot; in b/package.json
b/index.js
b/index.json
b/index.node</code></pre>
<p>If we specify <code>import &#39;b&#39;</code> instead, Node.js will treat it as a package within <code>node_modules/</code>, and have a different resolving strategy.</p>
<p>Through the above illustration, we can see that resolving <code>import &#39;./b&#39;</code> is not as simple as it seems. Besides the default Node.js resolving behaviour, <a href="https://webpack.js.org/configuration/resolve/" rel="nofollow">webpack provides a lot more customisation options</a>, such as custom extensions, alias, modules folders, etc.</p>
<p>Here, I am showing you the <em>&quot;simplest&quot;</em> resolver, which is to resolve relative path only:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// highlight-start</span>
<span class="token comment">// resolving</span>
<span class="token keyword">function</span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span><span class="token parameter">requester<span class="token punctuation">,</span> requestedPath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">dirname</span><span class="token punctuation">(</span>requester<span class="token punctuation">)</span><span class="token punctuation">,</span> requestedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<blockquote><small>**Note:** You should try out writing a full node resolvers that resolve relatively as well as absolutely from `node_modules/`</small></blockquote>
<p>Now I know the actual requested file paths, I then create modules out of them.</p>
<pre class="language-js">
<code class="language-js"><span class="token function">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ast</span><span class="token punctuation">.</span><span class="token property-access">program</span><span class="token punctuation">.</span><span class="token property-access">body</span>
    <span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token arrow operator">=></span> node<span class="token punctuation">.</span><span class="token property-access">type</span> <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token arrow operator">=></span> node<span class="token punctuation">.</span><span class="token property-access">source</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">relativePath</span> <span class="token arrow operator">=></span> <span class="token function">resolveRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">filePath</span><span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// highlight-next-line</span>
    <span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">absolutePath</span> <span class="token arrow operator">=></span> <span class="token function">createModule</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>So, for each module, I find their dependencies, parse them, and find each dependency&#39;s dependencies, parse them as well, and find their dependencies, and so forth recursively. At the end of the process, I get a module dependency graph that looks something like this:</p>
<pre class="language-js">
<code class="language-js"><span class="token maybe-class-name">Module</span> <span class="token punctuation">&#123;</span>
  filePath<span class="token punctuation">:</span> <span class="token string">'/Projects/byo-bundler/fixture/index.js'</span><span class="token punctuation">,</span>
  content<span class="token punctuation">:</span>
   <span class="token string">'import squareArea from './square.js';&#92;nimport circleArea from './circle.js';&#92;n&#92;nconsole.log('Area of square: ', squareArea(5));&#92;nconsole.log('Area of circle', circleArea(5));&#92;n'</span><span class="token punctuation">,</span>
  ast<span class="token punctuation">:</span>
   <span class="token maybe-class-name">Node</span> <span class="token punctuation">&#123;</span> <span class="token comment">/*...*/</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  dependencies<span class="token punctuation">:</span>
   <span class="token punctuation">[</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">&#123;</span>
       filePath<span class="token punctuation">:</span> <span class="token string">'/Projects/byo-bundler/fixture/square.js'</span><span class="token punctuation">,</span>
       content<span class="token punctuation">:</span>
        <span class="token string">'function area(side) &#123;&#92;n  return side * side;&#92;n&#125;&#92;nexport default area;&#92;n'</span><span class="token punctuation">,</span>
       ast<span class="token punctuation">:</span> <span class="token maybe-class-name">Node</span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
       dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
     <span class="token maybe-class-name">Module</span> <span class="token punctuation">&#123;</span>
       filePath<span class="token punctuation">:</span> <span class="token string">'/Projects/byo-bundler/fixture/circle.js'</span><span class="token punctuation">,</span>
       content<span class="token punctuation">:</span>
        <span class="token string">'const PI = 3.141;&#92;nfunction area(radius) &#123;&#92;n    return PI * radius * radius;&#92;n&#125;&#92;nexport default area;&#92;n'</span><span class="token punctuation">,</span>
       ast<span class="token punctuation">:</span> <span class="token maybe-class-name">Node</span> <span class="token punctuation">&#123;</span><span class="token comment">/* ... */</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
       dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>The root of the graph is our entry module, and you can traverse the graph through the <code>dependencies</code> of the module. As you can see, the <code>index.js</code> has 2 dependencies, the <code>square.js</code> and the <code>circle.js</code>.</p>
<blockquote><small>**Note:** If you are following along, you can checkout the tag `feat-1-module-dependency-graph`, to see the code that I had written up till this point.</small></blockquote></section>
<section><h2><a href="#bundling" id="bundling">Bundling</a></h2>
<p>With the module dependency graph, it&#39;s time to bundle them into a file!</p>
<p>At this point in time, we can choose whether we want to bundle it in the <strong>&quot;webpack way&quot;</strong> or the <strong>&quot;rollup way&quot;</strong>. In this article I am showing you how I did it the <strong>&quot;webpack way&quot;</strong>. I&#39;ll write about bundling in the <strong>&quot;rollup way&quot;</strong> in the coming article.</p>
<blockquote><p>If you have no idea about what is the <strong>&quot;webpack way&quot;</strong> or <strong>&quot;rollup way&quot;</strong>, I have &quot;coined&quot; the term in my <a href="/what-is-module-bundler-and-how-does-it-work/">previous article</a> and have detailed explanation about them!</p></blockquote>
<p>Let&#39;s take a look how the final bundled file would look like:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token string">'circle.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">default</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">'square.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    exports<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">default</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">side</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> side <span class="token operator">*</span> side<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">'app.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> squareArea <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'square.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> circleArea <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'circle.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword module">default</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token function">webpackStart</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  modules<span class="token punctuation">,</span>
  entry<span class="token punctuation">:</span> <span class="token string">'app.js'</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Let&#39;s break it down to a few steps:</p>
<ul><li><strong>Group modules into files</strong></li>
<li><strong>Create the module map</strong> and wrapping each module in a &quot;special&quot; module factory function</li>
<li><strong>Create the &quot;runtime&quot;</strong>, the glue that links each module together.</li></ul></section>
<section><h3><a href="#grouping-modules-into-files" id="grouping-modules-into-files">Grouping modules into files</a></h3>
<p>This step is to decide which modules goes to which file. We can split modules into different files because of <a href="https://webpack.js.org/guides/code-splitting/" rel="nofollow">code splitting</a> due to dynamic import as well as optimisation, such as the webpack&#39;s <a href="https://webpack.js.org/plugins/split-chunks-plugin/" rel="nofollow">Chunk Splitting</a>.</p>
<p>I will support code splitting in the future. For now, I grouped all modules into 1 file.</p>
<p>To collect all the modules from module graph into a list of modules, I did a graph traversal:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token function">collectModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// highlight-start</span>
<span class="token keyword">function</span> <span class="token function">collectModules</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">collect</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> modules<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> modules</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    modules<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    module<span class="token punctuation">.</span><span class="token property-access">dependencies</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">dependency</span> <span class="token arrow operator">=></span> <span class="token function">collect</span><span class="token punctuation">(</span>dependency<span class="token punctuation">,</span> modules<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>...and I used the list of modules to create a module map.</p></section>
<section><h3><a href="#creating-module-map" id="creating-module-map">Creating module map</a></h3>
<p>The module map I created is a string, that would be inlined into the final bundle file.</p>
<p>I looped through each module, and used <code>module.filePath</code> as the key, and <code>module.content</code> as the value.</p>
<p>The reason I dont use <code>JSON.stringify(moduleMap)</code> instead of manually concatenating to build up the module map, is because JSON can only takes in <a href="https://documentation.progress.com/output/ua/OpenEdge_latest/index.html#page/dvjsn/json-data-types.html" rel="nofollow">JSON primitive data type</a> as value, but what I built here is a JavaScript map, with <code>function</code> as value, but in string.</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">collectModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token keyword">const</span> moduleMap <span class="token operator">=</span> <span class="token function">toModuleMap</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// highlight-start</span>
<span class="token keyword">function</span> <span class="token function">toModuleMap</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> moduleMap <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  moduleMap <span class="token operator">+=</span> <span class="token string">'&#123;'</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    moduleMap <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>module<span class="token punctuation">.</span><span class="token property-access">filePath</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">": </span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">;</span>
    moduleMap <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">function(exports, require) &#123; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>module<span class="token punctuation">.</span><span class="token property-access">content</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> &#125;,</span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  moduleMap <span class="token operator">+=</span> <span class="token string">'&#125;'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> moduleMap<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>The function that wraps around the <code>module.content</code> is called the module factory function. It provides 2 parameter to the module:</p>
<ul><li><code>exports</code>, an object that the module can assign its exported value onto</li>
<li><code>require</code>, a function that the module can invoke with module path to import exported value from another module</li></ul>
<p>The module map right now is not something that can be executed:</p>
<pre class="language-js">
<code class="language-js"><span class="token punctuation">&#123;</span>
  <span class="token string">"index.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword module">import</span> squareArea <span class="token keyword module">from</span> <span class="token string">'./square.js'</span><span class="token punctuation">;</span>
    <span class="token keyword module">import</span> circleArea <span class="token keyword module">from</span> <span class="token string">'./circle.js'</span><span class="token punctuation">;</span>

    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">"square.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">side</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> side <span class="token operator">*</span> side<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword module">export</span> <span class="token keyword module">default</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">"circle.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword module">export</span> <span class="token keyword module">default</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>because it still uses <code>import</code> and <code>export</code>. I had to transform them to use the <code>exports</code> and <code>require</code> that we pass in.</p>
<p>To transform the code, I used the AST of the module again: trasform the ast and generate the new code from the transformed ast.</p>
<p>What I need is to trasform the &quot;from&quot; to &quot;to&quot; of the following:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// #1</span>
<span class="token comment">// from</span>
<span class="token keyword module">import</span> a<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> b<span class="token punctuation">,</span> c <span class="token punctuation">&#125;</span> <span class="token keyword module">from</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
<span class="token comment">// to</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword module">default</span><span class="token punctuation">:</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// #2</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> a<span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token punctuation">&#123;</span> c <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token comment">// to</span>
exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> a<span class="token punctuation">;</span>
exports<span class="token punctuation">.</span><span class="token property-access">b</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span><span class="token property-access">c</span> <span class="token operator">=</span> c<span class="token punctuation">;</span></code></pre>
<blockquote><p>I wrote a <a href="/step-by-step-guide-for-writing-a-babel-transformation">step by step guide</a> on how to write babel transformation, please do check it out.</p></blockquote>
<p>Knowing <strong>what to target on AST</strong> and <strong>how the transformed AST look like</strong>, I wrote my transformation code:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// highlight-next-line</span>
  module<span class="token punctuation">.</span><span class="token method function property-access">transformModuleInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  moduleMap <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>module<span class="token punctuation">.</span><span class="token property-access">filePath</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">": function(exports, require) &#123; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>module<span class="token punctuation">.</span><span class="token property-access">content</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> &#125;,</span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// ...</span>
<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// highlight-start</span>
  <span class="token function">transformModuleInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ast<span class="token punctuation">,</span> code <span class="token punctuation">&#125;</span> <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token method function property-access">transformFromAstSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ast</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">content</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token spread operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ast</span> <span class="token operator">=</span> ast<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">content</span> <span class="token operator">=</span> code<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// highlight-end</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>I omitted the actual babel transformation code, because it is lengthy. If you are interested to read about it, you can check out <a href="https://github.com/tanhauhau/byo-bundler/blob/feat-2-bundling/src/index.js#L46-L138" rel="nofollow">from my Github repo</a></p>
<p>So, now the module map looks ready:</p>
<pre class="language-js">
<code class="language-js"><span class="token punctuation">&#123;</span>
  <span class="token string">"index.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword module">default</span><span class="token punctuation">:</span> squareArea <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'square.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword module">default</span><span class="token punctuation">:</span> circleArea <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'circle.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">"square.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">side</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> side <span class="token operator">*</span> side<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">"circle.js"</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>One thing to take note is that, for the <code>require</code> statements, I replaced the requested path to the actual resolved path, because I used the actual resolved path as the key to the module map.</p></section>
<section><h3><a href="#" id=""><strong>Create the &quot;runtime&quot;</strong></a></h3>
<p>Now it&#39;s time to create the runtime. The runtime is a piece of code that is part of the output bundle, that runs when the application code is running, therefore, the runtime.</p>
<p>The runtime code can be from a template file, but for simplicity sake, I kept the runtime code as a string:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">collectModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleMap <span class="token operator">=</span> <span class="token function">toModuleMap</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token keyword">const</span> moduleCode <span class="token operator">=</span> <span class="token function">addRuntime</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">,</span> modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// highlight-start</span>
<span class="token keyword">function</span> <span class="token function">addRuntime</span><span class="token punctuation">(</span><span class="token parameter">moduleMap<span class="token punctuation">,</span> entryPoint</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">
    const modules = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>moduleMap<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">;
    const entry = "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>entryPoint<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">";
    function webpackStart(&#123; modules, entry &#125;) &#123;
      const moduleCache = &#123;&#125;;
      const require = moduleName => &#123;
        // if in cache, return the cached version
        if (moduleCache[moduleName]) &#123;
          return moduleCache[moduleName];
        &#125;
        const exports = &#123;&#125;;
        // this will prevent infinite "require" loop
        // from circular dependencies
        moduleCache[moduleName] = exports;
    
        // "require"-ing the module,
        // exported stuff will assigned to "exports"
        modules[moduleName](exports, require);
        return moduleCache[moduleName];
      &#125;;
    
      // start the program
      require(entry);
    &#125;

    webpackStart(&#123; modules, entry &#125;);</span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// trim away spaces before the line</span>
<span class="token keyword">function</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> lines <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">'&#92;n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Boolean</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> padLength <span class="token operator">=</span> lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> lines<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">trimLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">&#96;</span><span class="token string">^\s&#123;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>padLength<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&#125;</span><span class="token template-punctuation string">&#96;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> lines<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">line</span> <span class="token arrow operator">=></span> line<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'&#92;n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>The code above is self explanatory, except if you have no idea what does the <code>webpackStart()</code> do, you can read more about it in <a href="/what-is-module-bundler-and-how-does-it-work/">my previous post</a>.</p>
<p>Finally, I returned the module code from the <code>bundle</code> function:</p>
<pre class="language-js">
<code class="language-js"><span class="token keyword">function</span> <span class="token function">bundle</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token function">collectModules</span><span class="token punctuation">(</span>graph<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleMap <span class="token operator">=</span> <span class="token function">toModuleMap</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleCode <span class="token operator">=</span> <span class="token function">addRuntime</span><span class="token punctuation">(</span>moduleMap<span class="token punctuation">,</span> modules<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">filePath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span> name<span class="token punctuation">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> moduleCode <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>Now I run my bundler, it generates a <code>output/bundle.js</code> file. I run the generated file with node and I see:</p>
<pre class="language-null">
<code class="language-">Area of square:  25
Area of circle 78.525</code></pre>
<p>That&#39;s it! A working module bundler!</p>
<p>Of course, the module bundler I&#39;ve shown here is <strong>nowhere near webpack</strong>. Webpack supports more module system, resolving strategies, loading strategies, plugin system, optimisation, and many many more.</p></section>
<section><h2><a href="#optimisation" id="optimisation">Optimisation</a></h2>
<p>I played around my module bundler, and I quickly noticed a bug: <strong>Circular Dependency</strong>.</p>
<p>Here&#39;s my input files that I&#39;ve tweaked:</p>
<pre class="language-js">
<code class="language-js"><span class="token comment">// filename: index.js</span>
<span class="token keyword module">import</span> squareArea <span class="token keyword module">from</span> <span class="token string">'./square.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> circleArea <span class="token keyword module">from</span> <span class="token string">'./circle.js'</span><span class="token punctuation">;</span>

<span class="token comment">// highlight-next-line</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class="language-js">
<code class="language-js"><span class="token comment">// filename: circle.js</span>
<span class="token comment">// highlight-start</span>
<span class="token comment">// const PI = 3.141;</span>
<span class="token keyword module">import</span> <span class="token punctuation">&#123;</span> <span class="token constant">PI</span> <span class="token punctuation">&#125;</span> <span class="token keyword module">from</span> <span class="token string">'./index.js'</span><span class="token punctuation">;</span>
<span class="token comment">// highlight-end</span>

<span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> area<span class="token punctuation">;</span></code></pre>
<p>When I ran it through my module bunlder, immediately it ran into a stack overflow:</p>
<pre class="language-null">
<code class="language-">RangeError: Maximum call stack size exceeded</code></pre></section>
<section><h3><a href="#circular-dependency" id="circular-dependency">Circular dependency</a></h3>
<p>There were 2 junctures that the code did recursive traversal which have led to the endless loop:</p>
<ul><li>Generating dependency graphs</li>
<li>Traversing module graph for bundling</li></ul>
<pre class="language-js">
<code class="language-js"><span class="token comment">// fixing circular dependencies when generating module graph</span>
<span class="token comment">// highlight-next-line</span>
<span class="token keyword">const</span> <span class="token constant">MODULE_CACHE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">createModule</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token comment">// highlight-next-line</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">MODULE_CACHE</span><span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// highlight-next-line</span>
   <span class="token constant">MODULE_CACHE</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// highlight-next-line</span>
   module<span class="token punctuation">.</span><span class="token method function property-access">initDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>
 <span class="token comment">// highlight-next-line</span>
 <span class="token keyword">return</span> <span class="token constant">MODULE_CACHE</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">&#123;</span>
  <span class="token spread operator">...</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token function">initDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// highlight-next-line</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dependencies</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">findDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// fixing circular dependencies when traversing module graph</span>
<span class="token keyword">function</span> <span class="token function">collectModules</span><span class="token punctuation">(</span><span class="token parameter">graph</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">collect</span><span class="token punctuation">(</span>graph<span class="token punctuation">,</span> modules<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// highlight-next-line</span>
  <span class="token keyword">return</span> <span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token keyword module">from</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// highlight-start</span>
  <span class="token keyword">function</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> modules</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modules<span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      modules<span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
      module<span class="token punctuation">.</span><span class="token property-access">dependencies</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">dependency</span> <span class="token arrow operator">=></span> <span class="token function">collect</span><span class="token punctuation">(</span>dependency<span class="token punctuation">,</span> modules<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>Bundle with the latest code, the stack overflow is gone. However when I executed the output bundle, I saw</p>
<pre class="language-sh">
<code class="language-sh">$ node output/bundle.js
Area of square:  25
Area of circle NaN</code></pre>
<p>So I took a look at the output bundle:</p>
<pre class="language-js">
<code class="language-js"><span class="token punctuation">&#123;</span>
  <span class="token string">'index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword module">default</span><span class="token punctuation">:</span> squareArea <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'square.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. require circle.js</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token keyword module">default</span><span class="token punctuation">:</span> circleArea <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'circle.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. define PI on exports</span>
    exports<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> <span class="token function">squareArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. call &#96;circleArea&#96;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> <span class="token function">circleArea</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">'circle.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 2. at the point of executing this, PI is not yet defined</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> <span class="token constant">PI</span><span class="token punctuation">:</span> <span class="token constant">PI</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 5. PI is undefined</span>
      <span class="token keyword">return</span> <span class="token constant">PI</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>So, the problem is that I destructed <code>PI</code> from the exports of <code>index.js</code> before it is defined, so naturally <code>PI</code> within <code>circle.js</code> would stay as <code>undefined</code> throughout the application. However before I called <code>circleArea</code>, we defined <code>PI</code> on the <code>index.js</code>&#39;s export, I am expecting it to be available.</p>
<p>So I built my application with webpack and took a look at how webpack solved this problem.</p>
<pre class="language-js">
<code class="language-js"><span class="token punctuation">&#123;</span>
  <span class="token string">'index.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> square_import <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'square.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1. require circle.js</span>
    <span class="token keyword">const</span> circle_import <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'circle.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. define PI on exports</span>
    exports<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">=</span> <span class="token number">3.141</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of square: '</span><span class="token punctuation">,</span> square_import<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. call &#96;circleArea&#96;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Area of circle'</span><span class="token punctuation">,</span> circle_import<span class="token punctuation">[</span><span class="token string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">'circle.js'</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 2. we keep a reference of the &#96;index.js&#96;'s &#96;exports&#96; object</span>
    <span class="token keyword">const</span> index_import <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token parameter">radius</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 5. we get PI from the &#96;exports&#96;</span>
      <span class="token keyword">return</span> index_import<span class="token punctuation">[</span><span class="token string">'PI'</span><span class="token punctuation">]</span> <span class="token operator">*</span> radius <span class="token operator">*</span> radius<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    exports<span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> area<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>Brilliant! The key is to lazily get the value of <code>PI</code> when needed!</p>
<p>I changed my babel transformation code, which I am not showing it here. If you are curious enough, you can check out <a href="https://github.com/tanhauhau/byo-bundler/compare/feat-2-bundling...feat-3-circular-dependency" rel="nofollow">the changes I made from Github</a>.</p></section>
<section><h2><a href="#summary" id="summary">Summary</a></h2>
<p>There&#39;s two phases in module bundling: <strong>Dependency Resolution</strong> and <strong>Bundling</strong>.</p>
<p>I showed you how I constructed the dependency graph, by finding import statements and resolving modules. I shared how I created module maps and transformed the imports / exports syntax during <strong>bundling</strong>. Lastly, I fixed the circular dependency bug that was in the first version of my module bundler.</p></section>
<section><h3><a href="#whats-next" id="whats-next">Whats next?</a></h3>
<p>I have a few ideas that I will add to my module bundler, such as:</p>
<ul><li>code spliting</li>
<li>watch mode and reloading</li></ul>
<p>which I will cover them in my next article when they are ready.</p>
<p>Till then. Cheers. üòé</p></section>
<section><h2><a href="#further-readings" id="further-readings">Further Readings</a></h2>
<ul><li><a href="https://www.youtube.com/watch?v=Gc9-7PBqOC8" rel="nofollow">Ronen Amiel, Build Your Own Webpack - You Gotta Love Frontend 2018</a></li>
<li><a href="https://slides.com/lucianomammino/unbundling-the-javascript-module-bundler-dublinjs" rel="nofollow">Luciano Mammino, Unbundling the JavaScript module bundler - DublinJS July 2018</a></li>
<li><a href="https://www.freecodecamp.org/news/lets-learn-how-module-bundlers-work-and-then-write-one-ourselves-b2e3fe6c88ae/" rel="nofollow">Adam Kelly, Let‚Äôs learn how module bundlers work and then write one ourselves</a></li>
<li><a href="https://www.youtube.com/watch?v=UNMkLHzofQI" rel="nofollow">Webpack founder Tobias Koppers demos bundling live by hand</a></li></ul></section></article></main>

<footer class="svelte-2w4dum"><div class="form svelte-1k1s1co"><h1>Subscribe to my newsletter</h1>
  <h2 class="svelte-1k1s1co">Get the latest blog posts and project updates delivered right to your inbox</h2>
  <form action="https://buttondown.email/api/emails/embed-subscribe/lihautan" method="post" target="popupwindow" onsubmit="window.open('https://buttondown.email/lihautan', 'popupwindow')" class="embeddable-buttondown-form"><div class="form-item svelte-1k1s1co"><input type="email" name="email" id="bd-email" placeholder="youremail@example.com" class="svelte-1k1s1co">
      <input type="submit" value="Subscribe" disabled class="svelte-1k1s1co"></div>
    <input type="hidden" value="1" name="embed" class="svelte-1k1s1co">
    <p class="svelte-1k1s1co">Powered by Buttondown.</p></form>
</div></footer>

<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><script src="./5289afe6.js" async></script></div>
  
</body>

</html>