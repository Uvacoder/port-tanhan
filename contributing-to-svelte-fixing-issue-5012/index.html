<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:118.75%/1.58 'Lora',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.73);font-family:'Lora',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}ul{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.85rem;line-height:1.58rem;overflow:scroll;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1rem;line-height:1.58rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0.9875rem;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1.1487rem;line-height:1.58rem;border-left:0.5925rem solid #134896;color:hsla(0,0%,0%,0.65);font-style:italic;border-left-color:#612e77;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.58rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:0;}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}li > ul{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:0;}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:0;}code{font-size:0.85rem;line-height:1.58rem;}kbd{font-size:0.85rem;line-height:1.58rem;}samp{font-size:0.85rem;line-height:1.58rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.05333rem;padding-right:1.05333rem;padding-top:0.79rem;padding-bottom:calc(0.79rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#612e77;text-decoration:underline;text-shadow:initial;background-image:initial;font-weight:600;}a:hover,a:active{text-shadow:none;background-image:none;}h1,h2,h3,h4,h5,h6{margin-top:2.37rem;margin-bottom:0.79rem;}li>ol,li>ul{margin-left:20px;margin-bottom:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.58rem;color:hsla(0,0%,0%,0.73);font-style:normal;font-weight:400;}blockquote cite:before{content:"— ";}@media only screen and (max-width:480px){html{font-size:106.25%;line-height:28px;}blockquote{border-left:0.29625rem solid #134896;color:hsla(0,0%,0%,0.59);padding-left:0.88875rem;font-style:italic;margin-left:-1.185rem;margin-right:0;}}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.d32f1e7c7d8d283256bd.css">@font-face{font-family:Varela Round;font-style:normal;font-display:swap;font-weight:400;src:local("Varela Round Regular "),local("Varela Round-Regular"),url(/static/varela-round-latin-400-579fc6ff502e1f1e998dacea2e83bf37.woff2) format("woff2"),url(/static/varela-round-latin-400-ed1cf004373cd51bd0fd4c0e3dca9fae.woff) format("woff")}@font-face{font-family:Lora;font-style:normal;font-display:swap;font-weight:400;src:local("Lora Regular "),local("Lora-Regular"),url(/static/lora-latin-400-e4cdb14bf148f2846997a6be7ba648bd.woff2) format("woff2"),url(/static/lora-latin-400-0d78d370987954fb6b9f0efec3065e83.woff) format("woff")}@font-face{font-family:Lora;font-style:italic;font-display:swap;font-weight:400;src:local("Lora Regular italic"),local("Lora-Regularitalic"),url(/static/lora-latin-400italic-2c4801fad2634e6dac678d8826cf417c.woff2) format("woff2"),url(/static/lora-latin-400italic-7beffbacbbde86423a7ee771f31c1626.woff) format("woff")}@font-face{font-family:Lora;font-style:normal;font-display:swap;font-weight:700;src:local("Lora Bold "),local("Lora-Bold"),url(/static/lora-latin-700-ce18d17335e3ef2119d76f5dff177c66.woff2) format("woff2"),url(/static/lora-latin-700-1617380e0dea667b61cf44e86f3d0f10.woff) format("woff")}@font-face{font-family:Lora;font-style:italic;font-display:swap;font-weight:700;src:local("Lora Bold italic"),local("Lora-Bolditalic"),url(/static/lora-latin-700italic-b4bb1fa2335d49d4bc7e7ddd944cee44.woff2) format("woff2"),url(/static/lora-latin-700italic-6ec37b950cf9829a2cad7d02b11810c9.woff) format("woff")}body,div#___gatsby{background:#faf0fd}:root{--bg:#fff;--bg-secondary:#f9fafb;--textLink:#8c1fad;--textNormal:#444;--textTitle:#222;--hr:rgba(0,0,0,0.2);--inlineCode-bg:rgba(140,31,173,0.2);--inlineCode-text:rgba(0,0,0,0.73)}#carbonads{box-sizing:content-box;display:block;overflow:hidden;position:fixed;bottom:16px;left:16px;padding:1em;width:130px;background:#fff;text-align:center;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif;line-height:1.5}@media (max-width:1080px){#carbonads{display:none}}#carbonads a{text-decoration:none}#carbonads a,#carbonads a:hover{color:inherit}#carbonads span{display:block;overflow:hidden}.carbon-img{display:block;margin:0 auto 8px;line-height:1}.carbon-text{display:block;margin-bottom:8px}.carbon-poweredby{display:block;text-transform:uppercase;letter-spacing:1px;font-size:10px;line-height:1}.BioImage-module--container--1PFVh{position:relative}.BioImage-module--image1--14nWk{opacity:0;color:green}.BioImage-module--image2--1Blhq{position:absolute!important;left:0;opacity:1}.BioImage-module--image1--14nWk,.BioImage-module--image2--1Blhq{-webkit-transition:opacity .5s ease-in-out;transition:opacity .5s ease-in-out}.BioImage-module--showImage--2hBbU .BioImage-module--image1--14nWk{opacity:1}.BioImage-module--showImage--2hBbU .BioImage-module--image2--1Blhq{opacity:0}.ScrollIndicator-module--container--324ST{top:0;left:0;right:0;height:3px;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.ScrollIndicator-module--indicator--2-U_m{width:100%;height:100%;background:#bd93f9;-webkit-transform-origin:left;transform-origin:left;-webkit-transform:scaleX(0);transform:scaleX(0);-webkit-transition:all 0s ease-in 0s;transition:all 0s ease-in 0s}.Header-module--header--2skx2{position:fixed;width:100%;background:#faf0fd;z-index:10}.Header-module--nav--2MDt5{border-bottom:1px solid rgba(0,0,0,.2)}.Header-module--list--3FHwz{list-style:none;margin:0;padding:0 1em;width:100%;display:flex;overflow-x:scroll;white-space:nowrap;-ms-overflow-style:none;scrollbar-width:none}.Header-module--list--3FHwz::-webkit-scrollbar{display:none}.Header-module--list--3FHwz li{display:content}.Header-module--link--2Oeqp{text-decoration:none;padding:.5em;display:inline-block}.Header-module--link--2Oeqp.Header-module--active--SWH_Q{border-bottom:2px solid #612e77;padding-bottom:calc(.5em - 2px)}li.Header-module--spacer--fYffy{padding:0;width:100%}.Header-module--icon--2L7Gm{height:1em;width:1em;position:relative;top:2px;fill:#612e77}:root{--prism-padding:20px}pre::-webkit-scrollbar{width:14px}pre::-webkit-scrollbar-track{background-color:#6272a4;border-radius:0}pre::-webkit-scrollbar-thumb{background-color:#bd93f9;border-radius:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:#282936;text-shadow:none;font-family:PT Mono,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background-color:#cacaca}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{background:#282936!important;border-radius:.5em;padding:var(--prism-padding,1em);margin:.5em 0;overflow:auto;height:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#282936}:not(pre)>code[class*=language-]{padding:4px 8px;white-space:normal}.limit-300{height:300px!important}.limit-400{height:400px!important}.limit-500{height:500px!important}.limit-600{height:600px!important}.limit-700{height:700px!important}.limit-800{height:800px!important}.token.comment{color:#6272a4}.token.prolog{color:#cfcfc2}.token.tag{color:#dc68aa}.token.entity{color:#8be9fd}.token.atrule{color:#62ef75}.token.url{color:#66d9ef}.token.selector{color:#cfcfc2}.token.string{color:#f1fa8c}.token.property{color:#ffb86c}.token.important{color:#ff79c6;font-weight:700}.token.punctuation{color:#e6db74}.token.number{color:#bd93f9}.token.function{color:#50fa7b}.token.class-name{color:#ffb86c}.token.keyword{color:#ff79c6}.token.boolean{color:#ffb86c}.token.operator{color:#8be9fd}.token.char{color:#ff879d}.token.regex,.token.variable{color:#50fa7b}.token.constant,.token.symbol{color:#ffb86c}.token.builtin{color:#ff79c6}.token.attr-value{color:#7ec699}.token.deleted,.token.namespace{color:#e2777a}.token.bold{font-weight:700}.token.italic{font-style:italic}.token.inserted{color:#1fd44b}.token.deleted{color:#ff0013}.token{color:#ff79c6}.langague-c .token.string,.langague-cpp .token.string{color:#8be9fd}.language-css .token.selector{color:#50fa7b}.language-css .token.property{color:#ffb86c}.language-java .token.class-name,.language-java span.token.class-name{color:#8be9fd}.language-markup .token.attr-value{color:#66d9ef}.language-markup .token.tag{color:#50fa7b}.language-objectivec .token.property{color:#66d9ef}.language-objectivec .token.string{color:#50fa7b}.language-php .token.boolean{color:#8be9fd}.language-php .token.function{color:#ff79c6}.language-php .token.keyword{color:#66d9ef}.language-ruby .token.symbol{color:#8be9fd}.language-ruby .token.class-name{color:#cfcfc2}pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre.line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}div.code-toolbar{position:relative}div.code-toolbar>.toolbar{position:absolute;top:.3em;right:.2em;-webkit-transition:opacity .3s ease-in-out;transition:opacity .3s ease-in-out;opacity:0}div.code-toolbar:hover>.toolbar{opacity:1}div.code-toolbar>.toolbar .toolbar-item{display:inline-block;padding-right:20px}div.code-toolbar>.toolbar a{cursor:pointer}div.code-toolbar>.toolbar button{background:none;border:0;color:inherit;font:inherit;line-height:normal;overflow:visible;padding:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}div.code-toolbar>.toolbar a,div.code-toolbar>.toolbar button,div.code-toolbar>.toolbar span{color:#ccc;font-size:.8em;padding:.5em;background:#6272a4;border-radius:.5em}div.code-toolbar>.toolbar a:focus,div.code-toolbar>.toolbar a:hover,div.code-toolbar>.toolbar button:focus,div.code-toolbar>.toolbar button:hover,div.code-toolbar>.toolbar span:focus,div.code-toolbar>.toolbar span:hover{color:inherit;text-decoration:none;background-color:var(--verde)}.gatsby-highlight-code-line{background-color:#38394d;display:block;margin-right:-1em;margin-left:-1.25em;padding-right:1em;padding-left:.75em;border-left:.5em solid #ff79c6}:not(pre)>code.language-text{background-color:rgba(227,154,249,.2);color:#612e77;border-radius:10px;font-size:.8em}:not(pre)>code.language-text::selection{background-color:#cc23ff;color:#fff}.gatsby-highlight,p.filename{margin-left:calc(-1*var(--prism-padding));margin-right:calc(-1*var(--prism-padding))}.gatsby-highlight+blockquote,.gatsby-highlight+p:not(.filename){margin-top:1.58em}.index-module--list--3C1Zu{margin-bottom:0;margin-top:0}.index-module--p--4EDuH{margin-bottom:.4rem;margin-top:.4rem}.gatsby-highlight+.caption,figcaption{font-size:.8rem;font-style:italic;font-weight:lighter;color:rgba(0,0,0,.65);text-decoration:underline;margin-bottom:1em}.gatsby-highlight+.caption{margin-top:-.5em}.gatsby-highlight+.caption>code[class*=language-],figcaption>code[class*=language-]{padding:2px 4px;font-size:.8em;background-color:rgba(0,0,0,.65);color:#faf0fd}.filename{font-size:.85em;font-style:italic;margin-bottom:0;padding:8px var(--prism-padding);padding-bottom:0;background:#282936;color:#faf0fd;border-top-left-radius:.5em;border-top-right-radius:.5em;text-decoration:underline}.filename+.gatsby-highlight pre{border-top-left-radius:0;border-top-right-radius:0;margin-top:0;padding-top:2px}</style><meta name="generator" content="Gatsby 2.18.7"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 70)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" title="Tan Li Hau&#x27;s RSS Feed" href="/rss.xml"/><link rel="icon" href="/icons/icon-48x48.png?v=8d2ab22a78631a892833a1e109f6aba0"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#612e77"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=8d2ab22a78631a892833a1e109f6aba0"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=8d2ab22a78631a892833a1e109f6aba0"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=8d2ab22a78631a892833a1e109f6aba0"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=8d2ab22a78631a892833a1e109f6aba0"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=8d2ab22a78631a892833a1e109f6aba0"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=8d2ab22a78631a892833a1e109f6aba0"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=8d2ab22a78631a892833a1e109f6aba0"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=8d2ab22a78631a892833a1e109f6aba0"/><title data-react-helmet="true">Contributing to Svelte - Fixing issue #5012 | Tan Li Hau</title><meta data-react-helmet="true" name="description" content="Svelte issue #5012 - Slot containing only {@html value} renders in wrong place on update"/><meta data-react-helmet="true" name="image" content="https://lihautan.com/static/hero-twitter-4bb068c8ece0b09801f2534e8f55f7c5.jpg"/><meta data-react-helmet="true" property="og:image" content="https://lihautan.com/static/hero-twitter-4bb068c8ece0b09801f2534e8f55f7c5.jpg"/><meta data-react-helmet="true" property="og:title" content="Contributing to Svelte - Fixing issue #5012"/><meta data-react-helmet="true" property="og:description" content="Svelte issue #5012 - Slot containing only {@html value} renders in wrong place on update"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:site" content="@lihautan"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="Tan Li Hau"/><meta data-react-helmet="true" name="twitter:title" content="Contributing to Svelte - Fixing issue #5012"/><meta data-react-helmet="true" name="twitter:description" content="Svelte issue #5012 - Slot containing only {@html value} renders in wrong place on update"/><meta data-react-helmet="true" name="twitter:image" content="https://lihautan.com/static/hero-twitter-4bb068c8ece0b09801f2534e8f55f7c5.jpg"/><link href="//fonts.googleapis.com/css?family=Varela+Round:400|Lora:400,400i,700" rel="stylesheet" type="text/css"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-e01135db4acd799ac6d1.js"/><link as="script" rel="preload" href="/app-8bd1cc8010cedd8acda1.js"/><link as="script" rel="preload" href="/styles-3b48cb4932382e2c1b1c.js"/><link as="script" rel="preload" href="/commons-3e93bd210d644ed6685c.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-f06013fc6459663c30aa.js"/><link as="fetch" rel="preload" href="/page-data/contributing-to-svelte-fixing-issue-5012/page-data.json" crossorigin="anonymous"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><header class="Header-module--header--2skx2"><nav class="Header-module--nav--2MDt5"><ul class="Header-module--list--3FHwz"><li><a class="Header-module--link--2Oeqp" href="/">Tan Li Hau</a></li><li><a class="Header-module--link--2Oeqp" href="/blogs/">Writings</a></li><li><a class="Header-module--link--2Oeqp" href="/talks/">Talks</a></li><li><a class="Header-module--link--2Oeqp" href="/projects/">Projects</a></li><li><a class="Header-module--link--2Oeqp" href="/notes/">Notes</a></li><li class="Header-module--spacer--fYffy"></li><li><a class="Header-module--link--2Oeqp" href="https://twitter.com/lihautan"><svg viewBox="0 0 24 24" class="Header-module--icon--2L7Gm"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a></li><li><a class="Header-module--link--2Oeqp" href="https://github.com/tanhauhau"><svg viewBox="0 0 24 24" class="Header-module--icon--2L7Gm"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li></ul></nav><div class="ScrollIndicator-module--container--324ST"><div class="ScrollIndicator-module--indicator--2-U_m"></div></div></header><div style="margin-left:auto;margin-right:auto;max-width:37.92rem;padding:2.37rem 1.185rem"><main><article itemtype="http://schema.org/Article" itemprop="mainEntity"><script type="application/ld+json">{&quot;@context&quot;:&quot;http://schema.org&quot;,&quot;@type&quot;:&quot;Article&quot;,&quot;author&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;},&quot;copyrightHolder&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;},&quot;copyrightYear&quot;:&quot;2019&quot;,&quot;creator&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;},&quot;publisher&quot;:{&quot;@type&quot;:&quot;Organization&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;,&quot;logo&quot;:{&quot;@type&quot;:&quot;ImageObject&quot;,&quot;url&quot;:&quot;/static/profile-pic-65797d16af424cddbffebd0e19ab2f56.png&quot;}},&quot;datePublished&quot;:&quot;June 25, 2020&quot;,&quot;dateModified&quot;:&quot;June 25, 2020&quot;,&quot;description&quot;:&quot;Svelte issue #5012 - Slot containing only {@html value} renders in wrong place on update&quot;,&quot;headline&quot;:&quot;Contributing to Svelte - Fixing issue #5012&quot;,&quot;inLanguage&quot;:&quot;en&quot;,&quot;url&quot;:&quot;https://lihautan.com/contributing-to-svelte-fixing-issue-5012/&quot;,&quot;name&quot;:&quot;Contributing to Svelte - Fixing issue #5012&quot;,&quot;image&quot;:{&quot;@type&quot;:&quot;ImageObject&quot;,&quot;url&quot;:&quot;https://lihautan.com/static/hero-twitter-4bb068c8ece0b09801f2534e8f55f7c5.jpg&quot;},&quot;mainEntityOfPage&quot;:&quot;https://lihautan.com/contributing-to-svelte-fixing-issue-5012/&quot;}</script><script type="application/ld+json">{&quot;@context&quot;:&quot;http://schema.org&quot;,&quot;@type&quot;:&quot;BreadcrumbList&quot;,&quot;description&quot;:&quot;Breadcrumbs list&quot;,&quot;name&quot;:&quot;Breadcrumbs&quot;,&quot;itemListElement&quot;:[{&quot;@type&quot;:&quot;ListItem&quot;,&quot;item&quot;:{&quot;@id&quot;:&quot;https://lihautan.com&quot;,&quot;name&quot;:&quot;Homepage&quot;},&quot;position&quot;:1},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;item&quot;:{&quot;@id&quot;:&quot;https://lihautan.com/contributing-to-svelte-fixing-issue-5012/&quot;,&quot;name&quot;:&quot;Contributing to Svelte - Fixing issue #5012&quot;},&quot;position&quot;:2}]}</script><meta itemprop="url" content="https://lihautan.com/contributing-to-svelte-fixing-issue-5012/"/><meta itemprop="image" content="https://lihautan.com/static/hero-twitter-4bb068c8ece0b09801f2534e8f55f7c5.jpg"/><h1 itemprop="name headline">WIP: <!-- -->Contributing to Svelte - Fixing issue #5012</h1><p style="font-size:0.87055rem;line-height:1.58rem;display:block;margin-bottom:1.58rem;margin-top:-0.79rem"><time itemprop="datePublished" dateTime="2020-06-25T08:00:00UTC">June 25, 2020</time></p><div itemprop="articleBody"><h2 id="background"><a href="#background" aria-label="background permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Background</h2>
<p>Following <a href="/contributing-to-svelte-fixing-issue-4392">Contributing to Svelte - Fixing issue #4392</a>, I find it interesting to write my thought process down on fixing a Svelte issue.</p>
<p>So today, I’m going to walk through a new issue, <a href="https://github.com/sveltejs/svelte/issues/5012">#5012</a>.</p>
<h2 id="the-bug"><a href="#the-bug" aria-label="the bug permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The bug</h2>
<p><strong>Slot containing only {@html value} renders in wrong place on update <a href="https://github.com/sveltejs/svelte/issues/5012">#5012</a></strong></p>
<p>When a slotted component is instantiated and the only contents of the slot is {@html value}, changing value will cause the HTML-ized value to render at the end of the slot’s parent element (i.e. after all sibling elements) instead of in the correct place.</p>
<p><strong>To Reproduce</strong></p>
<p><a href="https://svelte.dev/repl/1f9da40bca4b44a089041e826648de2f">https://svelte.dev/repl/1f9da40bca4b44a089041e826648de2f</a></p>
<p>Click the Switch button and see that the contents of the slot moves to the end.</p>
<p><strong>Expected behavior</strong></p>
<p>Slot continues to render in the correct place.</p>
<p><strong>Information about your Svelte project:</strong></p>
<p>Looks like this appeared in version 3.7 and is still present in 3.23.2. If I run the REPL on 3.6.11 it behaves properly.</p>
<p><strong>Severity</strong></p>
<p>Potentially serious, but not serious for me.</p>
<p>Can be worked around by changing the slot contents to <code class="language-text">&lt;div&gt;{@html value}&lt;/div&gt;</code> or changing the child component to use <code class="language-text">&lt;div&gt;&lt;slot /&gt;&lt;div&gt;</code>, which works fine for me.</p>
<hr>
<h2 id="verifying-the-bug"><a href="#verifying-the-bug" aria-label="verifying the bug permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Verifying the bug</h2>
<p>I clicked into the REPL and tried to understand about the bug.</p>
<p>Initially, you see 2 lines of text, “Another first line”, “This line should be last.”.</p>
<p>But as soon as I updated the <code class="language-text">{@html content}</code>, the <code class="language-text">{@html content}</code> moved to be after the “This line should be last.” and stayed there.</p>
<p><img src="/276e3e3883337f8323c8182dd7feab9f/bug.gif" alt="screen recording of the bug behavior"></p>
<p>Yup. This is indeed a bug! <span class="emoji">🐛</span></p>
<h2 id="investigating-the-bug"><a href="#investigating-the-bug" aria-label="investigating the bug permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Investigating the bug</h2>
<p>It’s amazing that the issue author tracked down the regression behavior of this issue, stating that it started happening since 3.7. Probably because the author just upgraded Svelte from < 3.7, or maybe he tried every versions to figure out whether it is regression bug or a undiscovered bug. Anyway, kudos to the issue author! <span class="emoji">💪</span> <span class="emoji">💪</span></p>
<p>Most open source projects maintain a change log file, usually named <code class="language-text">CHANGELOG.md</code> located at the root of the project folder, so that you can figured out what’s added / removed / updated in each version.</p>
<p>You can find Svelte’s <a href="https://github.com/sveltejs/svelte/blob/master/CHANGELOG.md"><code class="language-text">CHANGELOG.md</code> here</a>.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;"
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/696715302c8f0da26939c3f074c4a815/38777/changelog.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 33.379694019471486%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAA6klEQVQoz5WRUW+DIACE/f//bm9Lpy2rgkAFU4ciAl6BLcuWzCa75JLj5eMOKq1HDIOClDcMSqU8lHPOSmsIISDUBH73sM4ja993HKmqmwb/UWZl4JGrafqAMQbLYjHPM+y6wlpbvK6uOGezOGjjEWN8DuRpUt2cQVmP84VAp5mEvOP0VqO9kpRJyS+XEY2w2GN4OrsSQoJSBiElOkrBuQBjrFzwSg06eYdLrScb4UP8hh02HMcR17YrsOycaQL2PQdpe1Au0SqHYXIZhc9i+3HD/Jv57UII8N7/cvAbti3ZR4T41eJHw7/0ALxLHv+fxHDMAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="changelog"
        title="changelog"
        src="/static/696715302c8f0da26939c3f074c4a815/799d3/changelog.png"
        srcset="/static/696715302c8f0da26939c3f074c4a815/00d96/changelog.png 148w,
/static/696715302c8f0da26939c3f074c4a815/0b23c/changelog.png 295w,
/static/696715302c8f0da26939c3f074c4a815/799d3/changelog.png 590w,
/static/696715302c8f0da26939c3f074c4a815/38777/changelog.png 719w"
        sizes="(max-width: 590px) 100vw, 590px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p>
<p>From the changelog, the most relevant commits seemed to be <strong>“Remount HTML tags correctly (<a href="https://github.com/sveltejs/svelte/pull/3329">#3329</a>)”</strong></p>
<p>Reading through the PR, it seemed that <a href="https://github.com/sveltejs/svelte/pull/3329">#3329</a> was when <code class="language-text">HtmlTag</code> is first introduced!</p>
<h3 id="htmltag"><a href="#htmltag" aria-label="htmltag permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>HtmlTag</h3>
<p><a href="https://github.com/sveltejs/svelte/blob/1c39f6079f630ea549984b8e9eda1853cd5fa883/src/runtime/internal/dom.ts#L321-L362"><code class="language-text">HtmlTag</code></a> is a helper class that helps Svelte manage raw <a href="https://svelte.dev/tutorial/html-tags"><code class="language-text">{@html ...}</code> tag</a>.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// in the compiled Svelte code,</span>
<span class="token comment">// you would see the use of `HtmlTag`</span>
<span class="token comment">// when you use `{@html ...}`</span>
<span class="token keyword">const</span> html_tag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HtmlTag</span><span class="token punctuation">(</span>anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// mounting raw html string, call the `m`ount method</span>
html_tag<span class="token punctuation">.</span><span class="token function">m</span><span class="token punctuation">(</span><span class="token string">'&lt;div>content&lt;/div>'</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// when the html string content change, call the u`p`date method</span>
html_tag<span class="token punctuation">.</span><span class="token function">p</span><span class="token punctuation">(</span><span class="token string">'&lt;b>new&lt;/b>html&lt;br />'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// when unmount, call the `d`etach method</span>
html_tag<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>The HtmlTag instance provides the <code class="language-text">m</code>, <code class="language-text">p</code>, <code class="language-text">d</code> method, and it will maintain the HTML elements created through the HTML string.</p>
<p>So, before v3.7, <code class="language-text">{@html ...}</code> was handled differently, and from the PR, I assume it was more buggy than the current implementation, albeit getting the case reported by this issue #5012 right. So, there’s no reverting back, nor taking the implementation pre-v3.7 as a reference to figure this bug out.</p>
<p>Reading through the implementation of the <code class="language-text">HtmlTag</code>, it seemed that the <code class="language-text">anchor</code> is a key to this issue.</p>
<p><code class="language-text">HtmlTag</code> uses <a href="https://developer.mozilla.org/en-US/docs/Web/API/Node/insertBefore"><code class="language-text">insertBefore</code></a> to insert HTML elements into the DOM. There’s a nullable 2nd argument for <code class="language-text">insertBefore</code>, if it is <code class="language-text">null</code>, the element will be inserted at the end of the parent.</p>
<p>In this case, the <code class="language-text">anchor</code> is indeed <code class="language-text">null</code>, so when there’s a change in the HTML content, the previous HTML elements were removed and the new HTML elements were inserted at the end of the parent.</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- Initially --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>article</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- slot --></span>
  {@html content}
  <span class="token comment">&lt;!-- slot --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>
    This line should be last.
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>article</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- when the html content changed --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>article</span><span class="token punctuation">></span></span>
  <span class="token comment">&lt;!-- slot --></span>
  <span class="token comment">&lt;!-- {@html content} removed --></span>
  <span class="token comment">&lt;!-- slot --></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>
    This line should be last.
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
  {@html content}
  <span class="token comment">&lt;!-- inserted at the end of the parent --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>article</span><span class="token punctuation">></span></span></code></pre></div>
<p><strong>Why doesn’t the <code class="language-text">{@html content}</code> added at the end of the parent in the initial render?</strong> Well, the elements are added in order during mounting. The HTML elements from <code class="language-text">HtmlTag</code> was added at the end of the parent, followed by the <code class="language-text">&lt;p&gt;This line should be last&lt;/p&gt;</code>.</p>
<p>The <code class="language-text">anchor</code> is an argument to the <code class="language-text">HtmlTag</code> constructor, so one can safely assume that it is not always <code class="language-text">null</code>.</p>
<p>So, I tried out using <code class="language-text">{@html content}</code> in various ways, to figure out what may be an anchor for the <code class="language-text">HtmlTag</code></p>
<p><strong>Repro #1</strong> (<a href="https://svelte.dev/repl/f31104585d974a54a76808aa5d0820a8?version=3.23.2">REPL</a>)</p>
<div class="gatsby-highlight" data-language="svelte"><pre class="language-svelte"><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'first line'</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token language-javascript"><span class="token punctuation">{</span>@html content<span class="token punctuation">}</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click=</span><span class="token language-javascript"><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>content <span class="token operator">=</span> <span class="token string">'line first'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span></code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// compiled js</span>
<span class="token comment">// ...</span>
  <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    button <span class="token operator">=</span> <span class="token function">element</span><span class="token punctuation">(</span><span class="token string">"button"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    html_tag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HtmlTag</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// ...</span></code></pre></div>
<p>In this case, the <code class="language-text">&lt;button /&gt;</code> element turns out to be the anchor, which totally make sense, as the html content should be inserted before <code class="language-text">&lt;button /&gt;</code>.</p>
<p>So, it seemed like the anchor is the next element right after <code class="language-text">{@html ...}</code>. <span class="emoji">🤔</span></p>
<p><strong>Repro #2</strong> (<a href="https://svelte.dev/repl/d469d63a77c94998839603738ea97451?version=3.23.2">REPL</a>)</p>
<div class="gatsby-highlight" data-language="svelte"><pre class="language-svelte"><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword">import</span> Foo <span class="token keyword">from</span> <span class="token string">'./Foo.svelte'</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'first line'</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">on:</span>click=</span><span class="token language-javascript"><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>content <span class="token operator">=</span> <span class="token string">'line first'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span>
<span class="token language-javascript"><span class="token punctuation">{</span>@html content<span class="token punctuation">}</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Foo</span> <span class="token punctuation">/></span></span></code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// compiled js</span>
<span class="token comment">// ...</span>
  <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    button <span class="token operator">=</span> <span class="token function">element</span><span class="token punctuation">(</span><span class="token string">"button"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t <span class="token operator">=</span> <span class="token function">space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    html_anchor <span class="token operator">=</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">create_component</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    html_tag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HtmlTag</span><span class="token punctuation">(</span>html_anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// ...</span></code></pre></div>
<p>If the next element right after <code class="language-text">{@html ...}</code> is a component, then Svelte will insert a empty <a href="https://developer.mozilla.org/en-US/docs/Web/API/Text">Text</a> node in between <code class="language-text">{@html ...}</code> and the component, and the anchor is the empty Text node.</p>
<p>Well, that make sense too, because we can’t see what’s inside the component, we can’t get the first element rendered in the component as the anchor. So, an extra empty Text node is used for anchoring.</p>
<p>So, it seemed like the anchor for the <code class="language-text">HtmlTag</code> depends on the next element, and the <code class="language-text">HtmlTag</code> itself is the last element, then the anchor would be <code class="language-text">null</code>.</p>
<p>This seemed fine in most cases, as in if the <code class="language-text">HtmlTag</code> is indeed the last element of its parent, then, we don’t need an anchor. Adding and updating <code class="language-text">HtmlTag</code> will always add HTML elements at the end of its parent.</p>
<p>However, I figured there are 2 edge cases that this assumption may not be true.</p>
<p>The 1st edge case is the one reported in the issue #5012, if the <code class="language-text">{@html ...}</code> is the last element within a slot. As we can’t tell how the slot would be used in the component, it may not be the last element of it’s parent.</p>
<div class="gatsby-highlight" data-language="svelte"><pre class="language-svelte"><code class="language-svelte"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>This is the last child<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre></div>
<p>The 2nd edge case is that <code class="language-text">{@html ...}</code> is the last element, but it is a the root of the Component.</p>
<div class="gatsby-highlight" data-language="svelte"><pre class="language-svelte"><code class="language-svelte"><span class="token comment">&lt;!-- Component.svelte --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">let</span> content<span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

<span class="token language-javascript"><span class="token punctuation">{</span>@html content<span class="token punctuation">}</span></span>

<span class="token comment">&lt;!-- App.svelte --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">import</span> Component <span class="token keyword">from</span> <span class="token string">'./Component.svelte'</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Component</span> <span class="token attr-name">content=</span><span class="token language-javascript"><span class="token punctuation">{</span><span class="token string">'&lt;div>html string&lt;/div>'</span><span class="token punctuation">}</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>This is the last child<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre></div>
<p><a href="https://svelte.dev/repl/9d19540d1eb249c3af519894e42f0f75?version=3.23.2">REPL</a></p>
<p>As you can see in this contrived example, we can’t assume where the component is being used by its parent, so, even it seemed to be the last element in the component, it may not be the case in the parent component.</p>
<h2 id="fixing-the-bug"><a href="#fixing-the-bug" aria-label="fixing the bug permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fixing the bug</h2>
<p>Once we figured out the cause of the bug, the fix is much simpler.</p>
<p>Just as how Svelte will add a empty Text node as an anchor if the next element is a component, we are going to add the same anchor if</p>
<ul>
<li>the <code class="language-text">{@html ...}</code> has no next element, and</li>
<li>
<p>either</p>
<ul>
<li><code class="language-text">{@html ...}</code> is at the root of a slot, or</li>
<li><code class="language-text">{@html ...}</code> is at the root of a component.</li>
</ul>
</li>
</ul>
<p>I know my way in the Svelte repo, good enough to know where to add this extra condition.</p>
<p>But if you are new, you can try global search the keyword <code class="language-text">html_anchor</code>, the variable name of the anchor added by Svelte, it should lead you to it.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// src/compiler/compile/render_dom/wrappers/RawMustacheTag.ts#L42</span>

<span class="token keyword">const</span> needs_anchor <span class="token operator">=</span> in_head <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">is_dom_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>needs_anchor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  block<span class="token punctuation">.</span><span class="token function">add_element</span><span class="token punctuation">(</span>html_anchor<span class="token punctuation">,</span> x<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@empty()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> x<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@empty()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> parent_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><a href="https://github.com/sveltejs/svelte/blob/1c39f6079f630ea549984b8e9eda1853cd5fa883/src/compiler/compile/render_dom/wrappers/RawMustacheTag.ts#L42">Link to Github</a></p>
<p>Here we see that the condition of adding an anchor is that if</p>
<ul>
<li>it is in the <code class="language-text">&lt;svelte:head&gt;</code>, or</li>
<li>the next element is not a dom element, (which could be a component, or logic blocks <em>(oh why didn’t I think about this case too?)</em>)</li>
</ul>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> needs_anchor <span class="token operator">=</span>
  in_head <span class="token operator">||</span>
  <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>next
    <span class="token operator">?</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>next<span class="token punctuation">.</span><span class="token function">is_dom_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">is_dom_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>So, we check if</p>
<ul>
<li>it has a parent (if it is at the root of component), or</li>
<li>if the parent is not an element (it could be within a slot, or a logic block <code class="language-text">{#if}</code>)</li>
</ul>
<p>For the test case, I used to 2 edge case examples, try to simulate some clicks, and make sure that the <code class="language-text">{@html ...}</code> stay in place even after the HTML content changes.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  html<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;button>Switch&lt;/button>
    &lt;p>Another first line&lt;/p>
    &lt;p>This line should be last.&lt;/p>
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> assert<span class="token punctuation">,</span> target<span class="token punctuation">,</span> window <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> btn <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> clickEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>MouseEvent</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// simulate clicks</span>
    <span class="token keyword">await</span> btn<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>clickEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    assert<span class="token punctuation">.</span><span class="token function">htmlEqual</span><span class="token punctuation">(</span>
      target<span class="token punctuation">.</span>innerHTML<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;button>Switch&lt;/button>
        &lt;p>First line&lt;/p>
        &lt;p>This line should be last.&lt;/p>
      </span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// simulate clicks</span>
    <span class="token keyword">await</span> btn<span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>clickEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    assert<span class="token punctuation">.</span><span class="token function">htmlEqual</span><span class="token punctuation">(</span>
      target<span class="token punctuation">.</span>innerHTML<span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;button>Switch&lt;/button>
        &lt;p>Another first line&lt;/p>
        &lt;p>This line should be last.&lt;/p>
      </span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>You can read the <a href="https://github.com/sveltejs/svelte/pull/5061">Pull Request #5061</a> to see all the test cases written up.</p>
<hr>
<p>If you wish to learn more about Svelte, <a href="https://twitter.com/lihautan">follow me on Twitter</a>.</p>
<p>If you have anything unclear about this article, find me on <a href="https://twitter.com/lihautan">Twitter</a> too!</p></div></article><hr style="margin-bottom:1.58rem"/><p>Thank you for your time reading through this article.<br/>It means a lot to me.</p><p> I would appreciate if you <a href="https://twitter.com/intent/tweet?text=Insightful%20article%20from%20%40lihautan&amp;url=https://lihautan.com/contributing-to-svelte-fixing-issue-5012/">tweet about it.</a></p><hr style="margin-bottom:1.58rem"/><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li></li><li></li></ul></main><footer style="margin-top:3.16rem">Built with <span role="img" class="emoji">💻</span> and <span role="img" class="emoji">❤️</span></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-135921142-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/contributing-to-svelte-fixing-issue-5012/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-8bd1cc8010cedd8acda1.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-5efb7b8fb8a6286e0a5c.js"],"component---src-templates-note-post-js":["/component---src-templates-note-post-js-f59fa8cce9012e7ea455.js"],"component---src-templates-talk-post-js":["/component---src-templates-talk-post-js-4d1e0e4a3b0202bcc81e.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-f06013fc6459663c30aa.js"],"component---src-pages-404-js":["/component---src-pages-404-js-055b71ea0a4fd9dcbccc.js"],"component---src-pages-blogs-js":["/component---src-pages-blogs-js-9270d348e0caf96d536a.js"],"component---src-pages-index-js":["/component---src-pages-index-js-4ebc6c75084ea2b15307.js"],"component---src-pages-notes-js":["/component---src-pages-notes-js-f8c84f6f470347a722e0.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-30e64bddf6d9ab4282e1.js"],"component---src-pages-talks-js":["/component---src-pages-talks-js-c6d25163507a15c56cf7.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-f06013fc6459663c30aa.js" async=""></script><script src="/commons-3e93bd210d644ed6685c.js" async=""></script><script src="/styles-3b48cb4932382e2c1b1c.js" async=""></script><script src="/app-8bd1cc8010cedd8acda1.js" async=""></script><script src="/webpack-runtime-e01135db4acd799ac6d1.js" async=""></script></body></html>