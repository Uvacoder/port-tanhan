<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:118.75%/1.58 'Lora',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.73);font-family:'Lora',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:2rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;color:hsla(0,0%,0%,0.9);font-family:'Varela Round',sans-serif;font-weight:400;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.1;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}ul{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.58rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:0.85rem;line-height:1.58rem;overflow:scroll;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1rem;line-height:1.58rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}blockquote{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0.9875rem;padding-right:0;padding-top:0;margin-bottom:1.58rem;font-size:1.1487rem;line-height:1.58rem;border-left:0.5925rem solid #134896;color:hsla(0,0%,0%,0.65);font-style:italic;border-left-color:#612e77;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.58rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.58rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:0;}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:calc(1.58rem / 2);}li > ul{margin-left:1.58rem;margin-bottom:calc(1.58rem / 2);margin-top:0;}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:0;}code{font-size:0.85rem;line-height:1.58rem;}kbd{font-size:0.85rem;line-height:1.58rem;}samp{font-size:0.85rem;line-height:1.58rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.05333rem;padding-right:1.05333rem;padding-top:0.79rem;padding-bottom:calc(0.79rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}a{color:#612e77;text-decoration:underline;text-shadow:initial;background-image:initial;font-weight:600;}a:hover,a:active{text-shadow:none;background-image:none;}h1,h2,h3,h4,h5,h6{margin-top:2.37rem;margin-bottom:0.79rem;}li>ol,li>ul{margin-left:20px;margin-bottom:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.58rem;color:hsla(0,0%,0%,0.73);font-style:normal;font-weight:400;}blockquote cite:before{content:"— ";}@media only screen and (max-width:480px){html{font-size:106.25%;line-height:28px;}blockquote{border-left:0.29625rem solid #134896;color:hsla(0,0%,0%,0.59);padding-left:0.88875rem;font-style:italic;margin-left:-1.185rem;margin-right:0;}}a.gatsby-resp-image-link{box-shadow:none;}</style><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><style type="text/css">
    .anchor {
      float: left;
      padding-right: 4px;
      margin-left: -20px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var offset = element.offsetTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="Tan Li Hau&#x27;s RSS Feed" href="/rss.xml"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#612e77"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><meta name="generator" content="Gatsby 2.13.6"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><title data-react-helmet="true">Creating custom JavaScript syntax with Babel | Tan Li Hau</title><meta data-react-helmet="true" name="description" content="Forking babel parser and creating your custom JavaScript syntax isn&#x27;t as hard as you think."/><meta data-react-helmet="true" name="image" content="https://lihautan.com/static/hero-twitter-4c916392c8254b09fcd8aa8d4d5725d0.jpg"/><meta data-react-helmet="true" property="og:image" content="https://lihautan.com/static/hero-twitter-4c916392c8254b09fcd8aa8d4d5725d0.jpg"/><meta data-react-helmet="true" property="og:title" content="Creating custom JavaScript syntax with Babel"/><meta data-react-helmet="true" property="og:description" content="Forking babel parser and creating your custom JavaScript syntax isn&#x27;t as hard as you think."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:site" content="@lihautan"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="Tan Li Hau"/><meta data-react-helmet="true" name="twitter:title" content="Creating custom JavaScript syntax with Babel"/><meta data-react-helmet="true" name="twitter:description" content="Forking babel parser and creating your custom JavaScript syntax isn&#x27;t as hard as you think."/><meta data-react-helmet="true" name="twitter:image" content="https://lihautan.com/static/hero-twitter-4c916392c8254b09fcd8aa8d4d5725d0.jpg"/><meta data-react-helmet="true" name="keywords" content="JavaScript, babel, ast, transform"/><style data-href="/styles.d19eeb4e26031af45804.css">@font-face{font-family:Varela Round;font-style:normal;font-display:swap;font-weight:400;src:local("Varela Round Regular "),local("Varela Round-Regular"),url(/static/varela-round-latin-400-579fc6ff502e1f1e998dacea2e83bf37.woff2) format("woff2"),url(/static/varela-round-latin-400-ed1cf004373cd51bd0fd4c0e3dca9fae.woff) format("woff")}@font-face{font-family:Lora;font-style:normal;font-display:swap;font-weight:400;src:local("Lora Regular "),local("Lora-Regular"),url(/static/lora-latin-400-e4cdb14bf148f2846997a6be7ba648bd.woff2) format("woff2"),url(/static/lora-latin-400-0d78d370987954fb6b9f0efec3065e83.woff) format("woff")}@font-face{font-family:Lora;font-style:italic;font-display:swap;font-weight:400;src:local("Lora Regular italic"),local("Lora-Regularitalic"),url(/static/lora-latin-400italic-2c4801fad2634e6dac678d8826cf417c.woff2) format("woff2"),url(/static/lora-latin-400italic-7beffbacbbde86423a7ee771f31c1626.woff) format("woff")}@font-face{font-family:Lora;font-style:normal;font-display:swap;font-weight:700;src:local("Lora Bold "),local("Lora-Bold"),url(/static/lora-latin-700-ce18d17335e3ef2119d76f5dff177c66.woff2) format("woff2"),url(/static/lora-latin-700-1617380e0dea667b61cf44e86f3d0f10.woff) format("woff")}@font-face{font-family:Lora;font-style:italic;font-display:swap;font-weight:700;src:local("Lora Bold italic"),local("Lora-Bolditalic"),url(/static/lora-latin-700italic-b4bb1fa2335d49d4bc7e7ddd944cee44.woff2) format("woff2"),url(/static/lora-latin-700italic-6ec37b950cf9829a2cad7d02b11810c9.woff) format("woff")}img{z-index:1}.gatsby-highlight,p.filename,span.emoji{z-index:1;position:relative}body,div#___gatsby{background:#faf0fd}body.mode--dark{background:#050f02}div#___gatsby:after{content:"";background:#fff;position:fixed;top:0;bottom:0;left:0;right:0;pointer-events:none;mix-blend-mode:difference;opacity:0;-webkit-transition:.5s ease;transition:.5s ease}.mode--dark div#___gatsby:after{opacity:1}.dark-mode-checkbox{position:fixed;bottom:20px;right:20px;z-index:1;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50% 50% 0 0;border:solid #612e77;border-width:0 0 2px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;overflow:hidden;-webkit-tap-highlight-color:transparent}.mode--dark .dark-mode-checkbox{border-color:#9ed188}.dark-mode-checkbox input{display:none}.dark-mode-checkbox span{font-size:30px;line-height:30px;position:absolute;-webkit-animation-duration:.5s;animation-duration:.5s;-webkit-animation-timing-function:ease-in-out;animation-timing-function:ease-in-out}@-webkit-keyframes sun{0%{-webkit-transform:translateY(150%);transform:translateY(150%)}to{-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes sun{0%{-webkit-transform:translateY(150%);transform:translateY(150%)}to{-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes sun-dark{0%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(-150%);transform:translateY(-150%)}}@keyframes sun-dark{0%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(-150%);transform:translateY(-150%)}}@-webkit-keyframes moon{0%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(-150%);transform:translateY(-150%)}}@keyframes moon{0%{-webkit-transform:translateY(0);transform:translateY(0)}to{-webkit-transform:translateY(-150%);transform:translateY(-150%)}}@-webkit-keyframes moon-dark{0%{-webkit-transform:translateY(150%);transform:translateY(150%)}to{-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes moon-dark{0%{-webkit-transform:translateY(150%);transform:translateY(150%)}to{-webkit-transform:translateY(0);transform:translateY(0)}}.dark-mode-checkbox .sun{-webkit-animation-name:sun;animation-name:sun;-webkit-transform:0;transform:0}.dark-mode-checkbox .moon{-webkit-animation-name:moon;animation-name:moon}.dark-mode-checkbox .moon,.mode--dark .dark-mode-checkbox .sun{-webkit-transform:translateY(-150%);transform:translateY(-150%)}.mode--dark .dark-mode-checkbox .sun{-webkit-animation-name:sun-dark;animation-name:sun-dark}.mode--dark .dark-mode-checkbox .moon{-webkit-animation-name:moon-dark;animation-name:moon-dark;-webkit-transform:translateY(0);transform:translateY(0)}.BioImage-module--container--1PFVh{position:relative}.BioImage-module--image1--14nWk{opacity:0;color:green}.BioImage-module--image2--1Blhq{position:absolute!important;left:0;opacity:1}.BioImage-module--image1--14nWk,.BioImage-module--image2--1Blhq{-webkit-transition:opacity .5s ease-in-out;transition:opacity .5s ease-in-out}.BioImage-module--showImage--2hBbU .BioImage-module--image1--14nWk{opacity:1}.BioImage-module--showImage--2hBbU .BioImage-module--image2--1Blhq{opacity:0}.ScrollIndicator-module--container--324ST{top:0;left:0;right:0;height:3px;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.ScrollIndicator-module--indicator--2-U_m{width:100%;height:100%;background:#bd93f9;-webkit-transform-origin:left;transform-origin:left;-webkit-transform:scaleX(0);transform:scaleX(0);-webkit-transition:all 0s ease-in 0s;transition:all 0s ease-in 0s}.Header-module--header--2skx2{position:fixed;width:100%;background:#faf0fd;z-index:10}.Header-module--nav--2MDt5{border-bottom:1px solid rgba(0,0,0,.2)}.Header-module--list--3FHwz{list-style:none;margin:0;padding:0 1em;width:100%;display:flex;overflow-x:scroll;white-space:nowrap;-ms-overflow-style:none;scrollbar-width:none}.Header-module--list--3FHwz::-webkit-scrollbar{display:none}.Header-module--list--3FHwz li{display:content}.Header-module--link--2Oeqp{text-decoration:none;padding:.5em;display:inline-block}.Header-module--link--2Oeqp.Header-module--active--SWH_Q{border-bottom:2px solid #612e77;padding-bottom:calc(.5em - 2px)}li.Header-module--spacer--fYffy{padding:0;width:100%}.Header-module--icon--2L7Gm{height:1em;width:1em;position:relative;top:2px;fill:#612e77}:root{--prism-padding:20px}pre::-webkit-scrollbar{width:14px}pre::-webkit-scrollbar-track{background-color:#6272a4;border-radius:0}pre::-webkit-scrollbar-thumb{background-color:#bd93f9;border-radius:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:#282936;text-shadow:none;font-family:PT Mono,Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background-color:#5a5f80}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background-color:#5a5f80}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{background:#282936!important;border-radius:.5em;padding:var(--prism-padding,1em);margin:.5em 0;overflow:auto;height:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#282936}:not(pre)>code[class*=language-]{padding:4px 7px;border-radius:.3em;white-space:normal}.limit-300{height:300px!important}.limit-400{height:400px!important}.limit-500{height:500px!important}.limit-600{height:600px!important}.limit-700{height:700px!important}.limit-800{height:800px!important}.token.comment{color:#6272a4}.token.prolog{color:#cfcfc2}.token.tag{color:#dc68aa}.token.entity{color:#8be9fd}.token.atrule{color:#62ef75}.token.url{color:#66d9ef}.token.selector{color:#cfcfc2}.token.string{color:#f1fa8c}.token.property{color:#ffb86c}.token.important{color:#ff79c6;font-weight:700}.token.punctuation{color:#e6db74}.token.number{color:#bd93f9}.token.function{color:#50fa7b}.token.class-name{color:#ffb86c}.token.keyword{color:#ff79c6}.token.boolean{color:#ffb86c}.token.operator{color:#8be9fd}.token.char{color:#ff879d}.token.regex,.token.variable{color:#50fa7b}.token.constant,.token.symbol{color:#ffb86c}.token.builtin{color:#ff79c6}.token.attr-value{color:#7ec699}.token.deleted,.token.namespace{color:#e2777a}.token.bold{font-weight:700}.token.italic{font-style:italic}.token{color:#ff79c6}.langague-c .token.string,.langague-cpp .token.string{color:#8be9fd}.language-css .token.selector{color:#50fa7b}.language-css .token.property{color:#ffb86c}.language-java .token.class-name,.language-java span.token.class-name{color:#8be9fd}.language-markup .token.attr-value{color:#66d9ef}.language-markup .token.tag{color:#50fa7b}.language-objectivec .token.property{color:#66d9ef}.language-objectivec .token.string{color:#50fa7b}.language-php .token.boolean{color:#8be9fd}.language-php .token.function{color:#ff79c6}.language-php .token.keyword{color:#66d9ef}.language-ruby .token.symbol{color:#8be9fd}.language-ruby .token.class-name{color:#cfcfc2}pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre.line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}div.code-toolbar{position:relative}div.code-toolbar>.toolbar{position:absolute;top:.3em;right:.2em;-webkit-transition:opacity .3s ease-in-out;transition:opacity .3s ease-in-out;opacity:0}div.code-toolbar:hover>.toolbar{opacity:1}div.code-toolbar>.toolbar .toolbar-item{display:inline-block;padding-right:20px}div.code-toolbar>.toolbar a{cursor:pointer}div.code-toolbar>.toolbar button{background:none;border:0;color:inherit;font:inherit;line-height:normal;overflow:visible;padding:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}div.code-toolbar>.toolbar a,div.code-toolbar>.toolbar button,div.code-toolbar>.toolbar span{color:#ccc;font-size:.8em;padding:.5em;background:#6272a4;border-radius:.5em}div.code-toolbar>.toolbar a:focus,div.code-toolbar>.toolbar a:hover,div.code-toolbar>.toolbar button:focus,div.code-toolbar>.toolbar button:hover,div.code-toolbar>.toolbar span:focus,div.code-toolbar>.toolbar span:hover{color:inherit;text-decoration:none;background-color:var(--verde)}.gatsby-highlight-code-line{background-color:#38394d;display:block;margin-right:-1em;margin-left:-1.25em;padding-right:1em;padding-left:.75em;border-left:.5em solid #ff79c6}:not(pre)>code.language-text{background-color:rgba(40,41,54,.2);color:rgba(0,0,0,.73)}:not(pre)>code.language-text::-moz-selection{color:#fff}:not(pre)>code.language-text::selection{color:#fff}.gatsby-highlight,p.filename{margin-left:calc(-1*var(--prism-padding));margin-right:calc(-1*var(--prism-padding))}.gatsby-highlight+blockquote,.gatsby-highlight+p:not(.filename){margin-top:1.58em}.index-module--list--3C1Zu{margin-bottom:0;margin-top:0}.index-module--p--4EDuH{margin-bottom:.4rem;margin-top:.4rem}.gatsby-highlight+.caption,figcaption{font-size:.8rem;font-style:italic;font-weight:lighter;color:rgba(0,0,0,.65);text-decoration:underline;margin-bottom:1em}.gatsby-highlight+.caption{margin-top:-.5em}.gatsby-highlight+.caption>code[class*=language-],figcaption>code[class*=language-]{padding:2px 4px;font-size:.8em;background-color:rgba(0,0,0,.65);color:#faf0fd}.filename{font-size:.85em;font-style:italic;margin-bottom:0;padding:8px var(--prism-padding);padding-bottom:0;background:#282936;color:#faf0fd;border-top-left-radius:.5em;border-top-right-radius:.5em;text-decoration:underline}.filename+.gatsby-highlight pre{border-top-left-radius:0;border-top-right-radius:0;margin-top:0;padding-top:2px}</style><link href="//fonts.googleapis.com/css?family=Varela+Round:400|Lora:400,400i,700" rel="stylesheet" type="text/css"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-75b0cd5b7b9eaac0fd32.js"/><link as="script" rel="preload" href="/1-562d0fc4e13c5148c893.js"/><link as="script" rel="preload" href="/app-2282d9d737e771c9b274.js"/><link as="script" rel="preload" href="/styles-5547210a1c7c84671dbf.js"/><link as="script" rel="preload" href="/webpack-runtime-070d9725b45c0b94149e.js"/><link as="fetch" rel="preload" href="/page-data/creating-custom-javascript-syntax-with-babel/page-data.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><header class="Header-module--header--2skx2"><nav class="Header-module--nav--2MDt5"><ul class="Header-module--list--3FHwz"><li><a class="Header-module--link--2Oeqp" href="/">Tan Li Hau</a></li><li><a class="Header-module--link--2Oeqp" href="/blogs/">Writings</a></li><li><a class="Header-module--link--2Oeqp" href="/talks/">Talks</a></li><li><a class="Header-module--link--2Oeqp" href="/projects/">Projects</a></li><li><a class="Header-module--link--2Oeqp" href="/notes/">Notes</a></li><li class="Header-module--spacer--fYffy"></li><li><a class="Header-module--link--2Oeqp" href="https://twitter.com/lihautan"><svg viewBox="0 0 24 24" class="Header-module--icon--2L7Gm"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a></li><li><a class="Header-module--link--2Oeqp" href="https://github.com/tanhauhau"><svg viewBox="0 0 24 24" class="Header-module--icon--2L7Gm"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li></ul></nav><div class="ScrollIndicator-module--container--324ST"><div class="ScrollIndicator-module--indicator--2-U_m"></div></div></header><div style="margin-left:auto;margin-right:auto;max-width:37.92rem;padding:2.37rem 1.185rem"><main><script type="application/ld+json">{&quot;@context&quot;:&quot;http://schema.org&quot;,&quot;@type&quot;:&quot;Article&quot;,&quot;author&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;},&quot;copyrightHolder&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;},&quot;copyrightYear&quot;:&quot;2019&quot;,&quot;creator&quot;:{&quot;@type&quot;:&quot;Person&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;},&quot;publisher&quot;:{&quot;@type&quot;:&quot;Organization&quot;,&quot;name&quot;:&quot;Tan Li Hau&quot;,&quot;logo&quot;:{&quot;@type&quot;:&quot;ImageObject&quot;,&quot;url&quot;:&quot;/static/profile-pic-65797d16af424cddbffebd0e19ab2f56.png&quot;}},&quot;datePublished&quot;:&quot;September 25, 2019&quot;,&quot;dateModified&quot;:&quot;September 25, 2019&quot;,&quot;description&quot;:&quot;Forking babel parser and creating your custom JavaScript syntax isn&#x27;t as hard as you think.&quot;,&quot;headline&quot;:&quot;Creating custom JavaScript syntax with Babel&quot;,&quot;inLanguage&quot;:&quot;en&quot;,&quot;url&quot;:&quot;https://lihautan.com//creating-custom-javascript-syntax-with-babel/&quot;,&quot;name&quot;:&quot;Creating custom JavaScript syntax with Babel&quot;,&quot;image&quot;:{&quot;@type&quot;:&quot;ImageObject&quot;,&quot;url&quot;:&quot;https://lihautan.com/static/hero-twitter-4c916392c8254b09fcd8aa8d4d5725d0.jpg&quot;},&quot;mainEntityOfPage&quot;:&quot;https://lihautan.com//creating-custom-javascript-syntax-with-babel/&quot;}</script><script type="application/ld+json">{&quot;@context&quot;:&quot;http://schema.org&quot;,&quot;@type&quot;:&quot;BreadcrumbList&quot;,&quot;description&quot;:&quot;Breadcrumbs list&quot;,&quot;name&quot;:&quot;Breadcrumbs&quot;,&quot;itemListElement&quot;:[{&quot;@type&quot;:&quot;ListItem&quot;,&quot;item&quot;:{&quot;@id&quot;:&quot;https://lihautan.com&quot;,&quot;name&quot;:&quot;Homepage&quot;},&quot;position&quot;:1},{&quot;@type&quot;:&quot;ListItem&quot;,&quot;item&quot;:{&quot;@id&quot;:&quot;https://lihautan.com//creating-custom-javascript-syntax-with-babel/&quot;,&quot;name&quot;:&quot;Creating custom JavaScript syntax with Babel&quot;},&quot;position&quot;:2}]}</script><h1>Creating custom JavaScript syntax with Babel</h1><p style="font-size:0.87055rem;line-height:1.58rem;display:block;margin-bottom:1.58rem;margin-top:-0.79rem">September 25, 2019</p><div><p>Following my previous post on <a href="/step-by-step-guide-for-writing-a-babel-transformation">writing a custom babel transformation</a>, today I am going to show you how you can create a custom JavaScript syntax with Babel.</p>
<h2 id="overview"><a href="#overview" aria-label="overview permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Overview</h2>
<p>Let me show you what we will achieve at the end of this article:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// '@@' makes the function `foo` curried</span>
<span class="token keyword">function</span> @@ <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span></code></pre></div>
<p>We are going to create a <a href="https://en.wikipedia.org/wiki/Currying">curry function</a> syntax <code class="language-text">@@</code>. The syntax is like the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*">generator function</a>, except you place <code class="language-text">@@</code> instead of <code class="language-text">*</code> in between the <code class="language-text">function</code> keyword and the function name, eg <code class="language-text">function @@ name(arg1, arg2)</code>.</p>
<p>In this example, you can have <a href="https://scotch.io/tutorials/javascript-functional-programming-explained-partial-application-and-currying">partial application</a> with the function <code class="language-text">foo</code>. Calling <code class="language-text">foo</code> with the number of parameters less than the arguments required will return a new function of the remaining arguments:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>

<span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (n) => 1 + 2 + n</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span></code></pre></div>
<blockquote>
<p>The reason I choose <code class="language-text">@@</code> is that you can’t have <code class="language-text">@</code> in a variable name, so <code class="language-text">function@@foo(){}</code> is still a valid syntax. And the “operator” <code class="language-text">@</code> is used for <a href="https://medium.com/google-developers/exploring-es7-decorators-76ecb65fb841">decorator functions</a> but I wanted to use something entirely new, thus <code class="language-text">@@</code>.</p>
</blockquote>
<p>To achieve this, we are going to:</p>
<ul>
<li>Fork the babel parser</li>
<li>Create a custom babel transformation plugin</li>
</ul>
<p>Sounds impossible <span class="emoji">😨</span>?</p>
<p>Don’t worry, I will guide you through every step. Hopefully, at the end of this article, you will be the babel master amongst your peers. <span class="emoji">🤠</span></p>
<h2 id="fork-the-babel"><a href="#fork-the-babel" aria-label="fork the babel permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fork the babel</h2>
<p>Head over to <a href="https://github.com/babel/babel">babel’s Github repo</a>, click the “Fork” button located at the top left of the page.</p>
<p>
  <a class="gatsby-resp-image-link" href="/static/cd47851ef23ac57b691450409164108b/bb144/forking.png" style="display: block" target="_blank" rel="noopener">
  
  <figure class="gatsby-resp-image-wrapper" style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 54.57031249999999%; position: relative; bottom: 0; left: 0; background-image: url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABZklEQVQoz4VSaW+CQBTkHzVNa+qFtzX90l9vD/EqCGiseIACCyzT3UUoEm1fMpnlzfDYHVbqv7yi0XlmGEBu9yC3uijLbdSaPVTkDqqNLuqtvuD7UhV3jxWGco7LeHiqo1TroNkdQPreWNhYW+jmCm8TA8PZGsu1he1uD2u7g8XYYNp0rmKuaph9adB0A+rCwEI3oWo6zOVKzOCzpBgAh+8e4dg2DicCzw/gej5IECKiMXwSsB4RfMr1BSIKyjhmQzgkEgRsEYPGccI0YqZIGLnmOE6Gw8EGIUT4iqBnSHv7CF68WSzP86CMJ/gcKRgpYwzfP8TQzH8elpxRdCFRSjNDEWkFYSSOmVaqXXtHumXI95emgelYEetbG0h70l9fSzWem+t6//qygZf5xRfIa795XUNhhwH7oz6/GiGFF1C4JOEwSsIPWY7Cx56PfqL5Zx/nLMP8dnk+NHcFaO4vXvriK75E+wEpIjJZdPoT6gAAAABJRU5ErkJggg==&#x27;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="forking babel" title="Forking babel" src="/static/cd47851ef23ac57b691450409164108b/623ee/forking.png" srcset="/static/cd47851ef23ac57b691450409164108b/816c5/forking.png 148w, /static/cd47851ef23ac57b691450409164108b/c766b/forking.png 295w, /static/cd47851ef23ac57b691450409164108b/623ee/forking.png 590w, /static/cd47851ef23ac57b691450409164108b/e5345/forking.png 885w, /static/cd47851ef23ac57b691450409164108b/7a439/forking.png 1180w, /static/cd47851ef23ac57b691450409164108b/84fe0/forking.png 1770w, /static/cd47851ef23ac57b691450409164108b/bb144/forking.png 2560w" sizes="(max-width: 590px) 100vw, 590px">
    </span>
  <figcaption>Forking babel</figcaption></figure>
  
  </a>
    </p>
<p>If this is your first time forking a popular open-source project, congratulations! <span class="emoji">🎉</span></p>
<p>Clone your forked babel to your local workspace and <a href="https://github.com/tanhauhau/babel/blob/master/CONTRIBUTING.md#setup">set it up</a>:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">$ git clone https://github.com/tanhauhau/babel.git

# set up
$ cd babel
$ make bootstrap
$ make build</code></pre></div>
<p>Meanwhile, let me briefly walk you through how the babel repository is organised.</p>
<p>Babel uses a monorepo structure, all the packages, eg: <code class="language-text">@babel/core</code>, <code class="language-text">@babel/parser</code>, <code class="language-text">@babel/plugin-transform-react-jsx</code>, etc are in the <code class="language-text">packages/</code> folder:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml">- doc
- packages
  - babel-core
  - babel-parser
  - babel-plugin-transform-react-jsx
  - ...
- Gulpfile.js
- Makefile
- ...</code></pre></div>
<blockquote>
<p><small><strong>Trivia:</strong> Babel uses <a href="https://opensource.com/article/18/8/what-how-makefile">Makefile</a> for automating tasks. For build task, such as <code class="language-text">make build</code>, it will use <a href="https://gulpjs.com">Gulp</a> as the task runner.</small></p>
</blockquote>
<h3 id="crash-course-on-parsing-code-to-ast"><a href="#crash-course-on-parsing-code-to-ast" aria-label="crash course on parsing code to ast permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Crash Course on Parsing Code to AST</h3>
<p>Before we proceed, if you are unfamiliar with parsers and Abstract Syntax Tree (AST), I highly recommend to checkout <a href="https://twitter.com/vaidehijoshi">Vaidehi Joshi</a>’s <a href="https://medium.com/basecs/leveling-up-ones-parsing-game-with-asts-d7a6fc2400ff">Leveling Up One’s Parsing Game With ASTs</a>.</p>
<p>To summarise, this is what happened when babel is parsing your code:</p>
<ul>
<li>Your code as a <code class="language-text">string</code> is a long list of characters: <code class="language-text">f, u, n, c, t, i, o, n, , @, @, f, ...</code></li>
<li>The first step is called <strong>tokenization</strong>, where babel scans through each character and creates <em>tokens</em>, like <code class="language-text">function, @@, foo, (, a, ...</code></li>
<li>The tokens then pass through a parser for <strong>Syntax analysis</strong>, where babel creates an AST based on <a href="https://www.ecma-international.org/ecma-262/10.0/index.html#Title">JavaScript language specification</a>.</li>
</ul>
<p>If you want to learn more in-depth on compilers in general, <a href="https://twitter.com/munificentbob?lang=en">Robert Nystrom</a>’s <a href="https://craftinginterpreters.com/introduction.html">Crafting Interpreters</a> is a gem.</p>
<blockquote>
<p><small>Don’t get scared of by the word <strong>compiler</strong>, it is nothing but parsing your code and generate XXX out of it. XXX could be machine code, which is the compiler most of us have in mind; XXX could be JavaScript compatible with older browsers, which is the case for Babel.</small></p>
</blockquote>
<h2 id="our-custom-babel-parser"><a href="#our-custom-babel-parser" aria-label="our custom babel parser permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Our custom babel parser</h2>
<p>The folder we are going to work on is <code class="language-text">packages/babel-parser/</code>:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">- src/
  - tokenizer/
  - parser/
  - plugins/
    - jsx/
    - typescript/
    - flow/
    - ...
- test/</code></pre></div>
<p>We’ve talked about <em>tokenization</em> and <em>parsing</em>, now it’s clear where to find the code for each process. <code class="language-text">plugins/</code> folder contains plugins that extend the base parser and add custom syntaxes, such as <code class="language-text">jsx</code> and <code class="language-text">flow</code>.</p>
<p>Let’s do a <a href="https://en.wikipedia.org/wiki/Test-driven_development">Test-driven development (TDD)</a>. I find it easier to define the test case then slowly work our way to “fix” it. It is especially true in an unfamiliar codebase, TDD allows you to “easily” point out code places you need to change.</p>
<p class="filename">packages/babel-parser/test/curry-function.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../lib'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getParser</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceType<span class="token punctuation">:</span> <span class="token string">'module'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'curry function syntax'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should parse'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getParser</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`function @@ foo() {}`</span></span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>You can run <code class="language-text">TEST_ONLY=babel-parser TEST_GREP=&quot;curry function&quot; make test-only</code> to run tests for <code class="language-text">babel-parser</code> and see your failing case:</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">SyntaxError: Unexpected token (1:9)

at Parser.raise (packages/babel-parser/src/parser/location.js:39:63)
at Parser.raise [as unexpected] (packages/babel-parser/src/parser/util.js:133:16)
at Parser.unexpected [as parseIdentifierName] (packages/babel-parser/src/parser/expression.js:2090:18)
at Parser.parseIdentifierName [as parseIdentifier] (packages/babel-parser/src/parser/expression.js:2052:23)
at Parser.parseIdentifier (packages/babel-parser/src/parser/statement.js:1096:52)</code></pre></div>
<blockquote>
<p><small>If you find scanning through all the test cases takes time, you can directly call <code class="language-text">jest</code> to run the test:</small></p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">BABEL_ENV=test node_modules/.bin/jest -u packages/babel-parser/test/curry-function.js</code></pre></div>
</blockquote>
<p>Our parser found 2 seemingly innocent <code class="language-text">@</code> tokens at a place where they shouldn’t be present.</p>
<p>How do I know that? Let’s start the watch mode, <code class="language-text">make watch</code>, wear our detective cap <span class="emoji">🕵️</span>‍ and start digging!</p>
<p>Tracing the stack trace, led us to <a href="https://github.com/tanhauhau/babel/blob/feat/curry-function/packages/babel-parser/src/parser/expression.js#L2092"><code class="language-text">packages/babel-parser/src/parser/expression.js</code></a> where it throws <code class="language-text">this.unexpected()</code>.</p>
<p>Let us add some <code class="language-text">console.log</code>:</p>
<p class="filename">packages/babel-parser/src/parser/expression.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">parseIdentifierName</span><span class="token punctuation">(</span>pos<span class="token punctuation">:</span> number<span class="token punctuation">,</span> liberal<span class="token operator">?</span><span class="token punctuation">:</span> boolean<span class="token punctuation">)</span><span class="token punctuation">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// current token</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lookahead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// next token</span>
    <span class="token keyword">throw</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unexpected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As you can see, both tokens are <code class="language-text">@</code> token:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">TokenType <span class="token punctuation">{</span>
  label<span class="token punctuation">:</span> <span class="token string">'@'</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>How do I know <code class="language-text">this.state.type</code> and <code class="language-text">this.lookahead().type</code> will give me the current and the next token?</p>
<p>Well, I’ll explained them <a href="#thiseat-thismatch-thisnext">later</a>.</p>
<p>Let’s recap what we’ve done so far before we move on:</p>
<ul>
<li>We’ve written a test case for <code class="language-text">babel-parser</code></li>
<li>We ran <code class="language-text">make test-only</code> to run the test case</li>
<li>We’ve started the watch mode via <code class="language-text">make watch</code></li>
<li>We’ve learned about parser state, and console out the current token type, <code class="language-text">this.state.type</code></li>
</ul>
<p>Here’s what we are going to do next:</p>
<p>If there’s 2 consecutive <code class="language-text">@</code>, it should not be separate tokens, it should be a <code class="language-text">@@</code> token, the new token we just defined for our curry function</p>
<h3 id="a-new-token-"><a href="#a-new-token-" aria-label="a new token  permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A new token: ’@@’</h3>
<p>Let’s first look at where a token type is defined: <a href="https://github.com/tanhauhau/babel/blob/feat/curry-function/packages/babel-parser/src/tokenizer/types.js#L86">packages/babel-parser/src/tokenizer/types.js</a>.</p>
<p>Here you see a list of tokens, so let’s add our new token definition in as well:</p>
<p class="filename">packages/babel-parser/src/tokenizer/types.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">const</span> types<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>name<span class="token punctuation">:</span> string<span class="token punctuation">]</span><span class="token punctuation">:</span> TokenType <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  at<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">TokenType</span><span class="token punctuation">(</span><span class="token string">'@'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="gatsby-highlight-code-line">  atat<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">TokenType</span><span class="token punctuation">(</span><span class="token string">'@@'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Next, let’s find out where the token gets created during <em>tokenization</em>. A quick search on <code class="language-text">tt.at</code> within <code class="language-text">babel-parser/src/tokenizer</code> lead us to <a href="https://github.com/tanhauhau/babel/blob/da0af5fd99a9b747370a2240df3abf2940b9649c/packages/babel-parser/src/tokenizer/index.js#L790">packages/babel-parser/src/tokenizer/index.js</a></p>
<blockquote>
<p><small>Well, token types are import as <code class="language-text">tt</code> throughout the babel-parser.</small></p>
</blockquote>
<p>Let’s create the token <code class="language-text">tt.atat</code> instead of <code class="language-text">tt.at</code> if there’s another <code class="language-text">@</code> succeed the current <code class="language-text">@</code>:</p>
<p class="filename">packages/babel-parser/src/tokenizer/index.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token function">getTokenFromCode</span><span class="token punctuation">(</span>code<span class="token punctuation">:</span> number<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">case</span> charCodes<span class="token punctuation">.</span>atSign<span class="token punctuation">:</span>
<span class="gatsby-highlight-code-line">      <span class="token comment">// if the next character is a `@`</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>input<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>pos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> charCodes<span class="token punctuation">.</span>atSign<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token comment">// create `tt.atat` instead</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finishOp</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>atat<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finishOp</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>at<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token keyword">return</span><span class="token punctuation">;</span></span>    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>If you run the test again, you will see that the current token and the next token has changed:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// current token</span>
TokenType <span class="token punctuation">{</span>
  label<span class="token punctuation">:</span> <span class="token string">'@@'</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// next token</span>
TokenType <span class="token punctuation">{</span>
  label<span class="token punctuation">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Yeah! It looks good and lets move on. <span style="transform:scaleX(-1);display:inline-block;"><span class="emoji">🏃</span>‍</span></p>
<h3 id="the-new-parser"><a href="#the-new-parser" aria-label="the new parser permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The new parser</h3>
<p>Before we move on, let’s inspect how <a href="https://lihautan.com/babel-ast-explorer/#?eyJiYWJlbFNldHRpbmdzIjp7InZlcnNpb24iOiI3LjYuMCJ9LCJ0cmVlU2V0dGluZ3MiOnsiaGlkZUVtcHR5Ijp0cnVlLCJoaWRlTG9jYXRpb24iOnRydWUsImhpZGVUeXBlIjp0cnVlfSwiY29kZSI6ImZ1bmN0aW9uICogZm9vKCkge30ifQ==">generator functions are represented in AST</a>:</p>
<p>
  <a class="gatsby-resp-image-link" href="/static/e9bdfdb9e282f45dd98dc10595532005/bb144/generator-function.png" style="display: block" target="_blank" rel="noopener">
  
  <figure class="gatsby-resp-image-wrapper" style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 37.421875%; position: relative; bottom: 0; left: 0; background-image: url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAxElEQVQoz42PzQqCQBSF3UW2adsbRC1aBS3a1Yv05EEGEUKNlprOz+nMDBNiYl34uPeeGT/GKBM3GGOglMJQNaWGuNd4yoqbtEkHn0VCZJ+PrLgPf6bxKA64ZmvUasVkwSywJHOysUIxKPPYGwp1uUWeRzCIuLObLvG3sF1dYZXvkaYTlHLsBG2pn6fDwpDDxQZa71AVMaSaco/diwLAiH323wttSWnQvC7UHrmdmCecE86Jm312/i0MXWmea7jf78PfA95ETgjzf3vMlgAAAABJRU5ErkJggg==&#x27;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="AST for generator function" title="AST for generator function" src="/static/e9bdfdb9e282f45dd98dc10595532005/623ee/generator-function.png" srcset="/static/e9bdfdb9e282f45dd98dc10595532005/816c5/generator-function.png 148w, /static/e9bdfdb9e282f45dd98dc10595532005/c766b/generator-function.png 295w, /static/e9bdfdb9e282f45dd98dc10595532005/623ee/generator-function.png 590w, /static/e9bdfdb9e282f45dd98dc10595532005/e5345/generator-function.png 885w, /static/e9bdfdb9e282f45dd98dc10595532005/7a439/generator-function.png 1180w, /static/e9bdfdb9e282f45dd98dc10595532005/84fe0/generator-function.png 1770w, /static/e9bdfdb9e282f45dd98dc10595532005/bb144/generator-function.png 2560w" sizes="(max-width: 590px) 100vw, 590px">
    </span>
  <figcaption>AST for generator function</figcaption></figure>
  
  </a>
    </p>
<p>As you can see, a generator function is represented by the <code class="language-text">generator: true</code> attribute of a <code class="language-text">FunctionDeclaration</code>.</p>
<p>Similarly, we can add a <code class="language-text">curry: true</code> attribute of the <code class="language-text">FunctionDeclaration</code> too if it is a curry function:</p>
<p>
  <a class="gatsby-resp-image-link" href="/static/36268014310215f5bf3a152a93983052/bb144/curry-function.png" style="display: block" target="_blank" rel="noopener">
  
  <figure class="gatsby-resp-image-wrapper" style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 39.296875%; position: relative; bottom: 0; left: 0; background-image: url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA9ElEQVQoz42SQW7CMBREvYNNL9SyYNNbsOkFKnZwCI7CEXqJrkFAiENjQCSAiMDYno5TxQpFRFh6Gv/J12gsRXx9S0SLORZRhDRNkSr1p3XoTZYKUkrMpEIsV4iTH8xihVWSYBqv+S2BUmuILNvBWgtjDJqOvjgcc4fD2cI17Ik8z8PgnHvAFT7ldBphe+yi0O/cfqXfIW83hMDHYR5d7tjrB/aZwMUI34X+PXeB/09o6J9d9LHdtBn4Qq9Np0VtlVrRGFjNoaHpYb8TOBQC1t229HfPUw0BAy9aj6mfnIdkwPug1DpPNmQk/wR9ZkuL4NW1Or+7f0+gArXNlgAAAABJRU5ErkJggg==&#x27;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="AST for curry function" title="AST for curry function" src="/static/36268014310215f5bf3a152a93983052/623ee/curry-function.png" srcset="/static/36268014310215f5bf3a152a93983052/816c5/curry-function.png 148w, /static/36268014310215f5bf3a152a93983052/c766b/curry-function.png 295w, /static/36268014310215f5bf3a152a93983052/623ee/curry-function.png 590w, /static/36268014310215f5bf3a152a93983052/e5345/curry-function.png 885w, /static/36268014310215f5bf3a152a93983052/7a439/curry-function.png 1180w, /static/36268014310215f5bf3a152a93983052/84fe0/curry-function.png 1770w, /static/36268014310215f5bf3a152a93983052/bb144/curry-function.png 2560w" sizes="(max-width: 590px) 100vw, 590px">
    </span>
  <figcaption>AST for curry function</figcaption></figure>
  
  </a>
    </p>
<p>We have a plan now, let’s implement it.</p>
<p>A quick search on <em>“FunctionDeclaration”</em> leads us to a function called <code class="language-text">parseFunction</code> in <a href="https://github.com/tanhauhau/babel/blob/da0af5fd99a9b747370a2240df3abf2940b9649c/packages/babel-parser/src/parser/statement.js#L1030">packages/babel-parser/src/parser/statement.js</a>, and here we find a line that sets the <code class="language-text">generator</code> attribute, let’s add one more line:</p>
<p class="filename">packages/babel-parser/src/parser/statement.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">StatementParser</span> <span class="token keyword">extends</span> <span class="token class-name">ExpressionParser</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  parseFunction<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">:</span> <span class="token constant">N</span><span class="token punctuation">.</span>NormalFunction<span class="token operator">></span><span class="token punctuation">(</span>
    node<span class="token punctuation">:</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    statement<span class="token operator">?</span><span class="token punctuation">:</span> number <span class="token operator">=</span> <span class="token constant">FUNC_NO_FLAGS</span><span class="token punctuation">,</span>
    isAsync<span class="token operator">?</span><span class="token punctuation">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token constant">T</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    node<span class="token punctuation">.</span>generator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>star<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">    node<span class="token punctuation">.</span>curry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>atat<span class="token punctuation">)</span><span class="token punctuation">;</span></span>  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>If you run the test again, you will be amazed that it passed!</p>
<div class="gatsby-highlight" data-language="sh"><pre class="language-sh"><code class="language-sh">PASS  packages/babel-parser/test/curry-function.js
  curry function syntax
    ✓ should parse (12ms)</code></pre></div>
<p>That’s it? How did we miraculously fix it?</p>
<p>I am going to briefly explain how parsing works, and in the process hopefully, you understood what that one-liner change did.</p>
<h3 id="how-parsing-works"><a href="#how-parsing-works" aria-label="how parsing works permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How parsing works</h3>
<p>With the list of tokens from the <em>tokenizer</em>, the parser consumes the token one by one and constructs the AST. The parser uses the language grammar specification to decide how to use the tokens, which token to expect next.</p>
<p>The grammar specification looks something like this:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">...
ExponentiationExpression -&gt; UnaryExpression
                            UpdateExpression ** ExponentiationExpression
MultiplicativeExpression -&gt; ExponentiationExpression
                            MultiplicativeExpression (&quot;*&quot; or &quot;/&quot; or &quot;%&quot;) ExponentiationExpression
AdditiveExpression       -&gt; MultiplicativeExpression
                            AdditiveExpression + MultiplicativeExpression
                            AdditiveExpression - MultiplicativeExpression
...</code></pre></div>
<p>It explains the precedence of each expressions/statements. For example, an <code class="language-text">AdditiveExpression</code> is made up of either:</p>
<ul>
<li>a <code class="language-text">MultiplicativeExpression</code>, or</li>
<li>an <code class="language-text">AdditiveExpression</code> followed by <code class="language-text">+</code> operator token followed by <code class="language-text">MultiplicativeExpression</code>, or</li>
<li>an <code class="language-text">AdditiveExpression</code> followed by <code class="language-text">-</code> operator token followed by <code class="language-text">MultiplicativeExpression</code>.</li>
</ul>
<p>So if you have an expression <code class="language-text">1 + 2 * 3</code>, it will be like:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(AdditiveExpression &quot;+&quot; 1 (MultiplicativeExpression &quot;*&quot; 2 3))</code></pre></div>
<p>instead of</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">(MultiplicativeExpression &quot;*&quot; (AdditiveExpression &quot;+&quot; 1 2) 3)</code></pre></div>
<p>With these rules, we translate them into parser code:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Parser</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">parseAdditiveExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> left <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseMultiplicativeExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// if the current token is `+` or `-`</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>plus<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>minus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> operator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
      <span class="token comment">// move on to the next token</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> right <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseMultiplicativeExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// create the node</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finishNode</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          operator<span class="token punctuation">,</span>
          left<span class="token punctuation">,</span>
          right<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'BinaryExpression'</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// return as MultiplicativeExpression</span>
      <span class="token keyword">return</span> left<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="caption">This is a made-up code that oversimplifies what babel have, but I hope you get the gist of it.</div>
<p>As you can see here, the parser is recursively in nature, and it goes from the lowest precedence to the highest precedence expressions/statements. Eg: <code class="language-text">parseAdditiveExpression</code> calls <code class="language-text">parseMultiplicativeExpression</code>, which in turn calls <code class="language-text">parseExponentiationExpression</code>, which in turn calls … . This recursive process is called the <a href="https://craftinginterpreters.com/parsing-expressions.html#recursive-descent-parsing">Recursive Descent Parsing</a>.</p>
<h4 id="thiseat-thismatch-thisnext"><a href="#thiseat-thismatch-thisnext" aria-label="thiseat thismatch thisnext permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>this.eat, this.match, this.next</h4>
<p>If you have noticed, in my examples above, I used some utility function, such as <code class="language-text">this.eat</code>, <code class="language-text">this.match</code>, <code class="language-text">this.next</code>, etc. These are babel parser’s internal functions, yet they are quite ubiquitous amongst parsers as well:</p>
<ul>
<li><strong><code class="language-text">this.match</code></strong> returns a <code class="language-text">boolean</code> indicating whether the current token matches the condition</li>
<li><strong><code class="language-text">this.next</code></strong> moves the token list forward to point to the next token</li>
<li>
<p><strong><code class="language-text">this.eat</code></strong> return what <code class="language-text">this.match</code> returns and if <code class="language-text">this.match</code> returns <code class="language-text">true</code>, will do <code class="language-text">this.next</code></p>
<ul>
<li><code class="language-text">this.eat</code> is commonly used for optional operators, like <code class="language-text">*</code> in generator function, <code class="language-text">;</code> at the end of statements, and <code class="language-text">?</code> in typescript types.</li>
</ul>
</li>
<li><strong><code class="language-text">this.lookahead</code></strong> get the next token without moving forward to make a decision on the current node</li>
</ul>
<p>If you take a look again the parser code we just changed, it’s easier to read it in now.</p>
<p class="filename">packages/babel-parser/src/parser/statement.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">StatementParser</span> <span class="token keyword">extends</span> <span class="token class-name">ExpressionParser</span> <span class="token punctuation">{</span>
  <span class="token function">parseStatementContent</span><span class="token punctuation">(</span><span class="token comment">/* ...*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// NOTE: we call match to check the current token</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>_function<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// NOTE: function statement has a higher precendence than a generic statement</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token function">parseFunction</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// NOTE: we call eat to check whether the optional token exists</span>
    node<span class="token punctuation">.</span>generator <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>star<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">    node<span class="token punctuation">.</span>curry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>atat<span class="token punctuation">)</span><span class="token punctuation">;</span></span>    node<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseFunctionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>I know I didn’t do a good job explaining how a parser works. Here are some resources that I learned from, and I highly recommend them:</p>
<ul>
<li><a href="https://craftinginterpreters.com/introduction.html">Crafting Interpreters</a> by <a href="https://twitter.com/munificentbob?lang=en">Robert Nystrom</a></li>
<li><a href="https://www.udacity.com/course/compilers-theory-and-practice--ud168">Free Udacity course: “Compilers: Theory and Practice”</a>, offered by Georgia Tech</li>
</ul>
<hr>
<p><strong>Side Note</strong>: You might be curious how am I able to visualize the custom syntax in the Babel AST Explorer, where I showed you the new “curry” attribute in the AST.</p>
<p>That’s because I’ve added a new feature in the Babel AST Explorer where you can upload your custom parser!</p>
<p>If you go to <code class="language-text">packages/babel-parser/lib</code>, you would find the compiled version of your parser and the source map. Open the drawer of the Babel AST Explorer, you will see a button to upload a custom parser. Drag the <code class="language-text">packages/babel-parser/lib/index.js</code> in and you will be visualizing the AST generated via your custom parser!</p>
<p><img src="/custom-parser-9655bf2b7ba72e0c61e31a63a29e3f22.gif" alt="Uploading custom parser"></p>
<hr>
<h2 id="our-babel-plugin"><a href="#our-babel-plugin" aria-label="our babel plugin permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Our babel plugin</h2>
<p>With our custom babel parser done, let’s move on to write our babel plugin.</p>
<p>But maybe before that, you may have some doubts on how are we going to use our custom babel parser, especially with whatever build stack we are using right now?</p>
<p>Well, fret not. A babel plugin can provide a custom parser, which is <a href="https://babeljs.io/docs/en/babel-parser#will-the-babel-parser-support-a-plugin-system">documented on the babel website</a></p>
<p class="filename">babel-plugin-transformation-curry-function.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> customParser <span class="token keyword">from</span> <span class="token string">'./custom-parser'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ourBabelPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function">parserOverride</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> customParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Since we forked out the babel parser, all existing babel parser options or built-in plugins will still work perfectly.</p>
<p>With this doubt out of the way, let see how we can make our curry function curryable? <em>(not entirely sure there’s such word)</em></p>
<hr>
<p>Before we start, if you have eagerly tried to add our plugin into your build system, you would notice that the curry function gets compiled to a normal function.</p>
<p>This is because, after parsing + transformation, babel will use <a href="https://babeljs.io/docs/en/babel-generator">@babel/generator</a> to generate code from the transformed AST. Since the <code class="language-text">@babel/generator</code> has no idea about the new <code class="language-text">curry</code> attribute we added, it will be omitted.</p>
<blockquote>
<p>If one day curry function becomes the new JavaScript syntax, you may want to make a pull request to add one more line <a href="https://github.com/tanhauhau/babel/blob/da0af5fd99a9b747370a2240df3abf2940b9649c/packages/babel-generator/src/generators/methods.js#L82">here</a>!</p>
</blockquote>
<hr>
<p>Ok, to make our function curryable, we can wrap it with a <code class="language-text">currying</code> helper higher-order function:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">currying</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> numParamsRequired <span class="token operator">=</span> fn<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">curryFactory</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newParams <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newParams<span class="token punctuation">.</span>length <span class="token operator">>=</span> numParamsRequired<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>newParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">curryFactory</span><span class="token punctuation">(</span>newParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">curryFactory</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>If you want to learn how to write a currying function, you can read this <a href="https://hackernoon.com/currying-in-js-d9ddc64f162e">Currying in JS</a> by <a href="https://twitter.com/zhirzh">Shirsh Zibbu</a></p>
</blockquote>
<p>So when we transform our curry function, we can transform it into the following:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// from</span>
<span class="token keyword">function</span> @@ <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// to</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">currying</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<blockquote>
<p>Let’s first ignore <a href="https://scotch.io/tutorials/understanding-hoisting-in-javascript">function hoisting</a> in JavaScript, where you can call <code class="language-text">foo</code> before it is defined.</p>
</blockquote>
<p>If you have read my <a href="/step-by-step-guide-for-writing-a-babel-transformation">step-by-step guide on babel transformation</a>, writing this transformation should be manageable:</p>
<p class="filename">babel-plugin-transformation-curry-function.js</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">ourBabelPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="gatsby-highlight-code-line">    visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">      <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'curry'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">          <span class="token comment">// const foo = curry(function () { ... });</span></span><span class="gatsby-highlight-code-line">          path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>curry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">          path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">            t<span class="token punctuation">.</span><span class="token function">variableDeclaration</span><span class="token punctuation">(</span><span class="token string">'const'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span></span><span class="gatsby-highlight-code-line">              t<span class="token punctuation">.</span><span class="token function">variableDeclarator</span><span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">                t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'id.name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'currying'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span></span><span class="gatsby-highlight-code-line">                  t<span class="token punctuation">.</span><span class="token function">toExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">              <span class="token punctuation">)</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">            <span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">          <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span class="gatsby-highlight-code-line">        <span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The question is how do we provide the <code class="language-text">currying</code> function?</p>
<p>There are 2 ways:</p>
<h3 id="1-assume-code-classlanguage-textcurryingcode-has-been-declared-in-the-global-scope"><a href="#1-assume-code-classlanguage-textcurryingcode-has-been-declared-in-the-global-scope" aria-label="1 assume code classlanguage textcurryingcode has been declared in the global scope permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. Assume <code class="language-text">currying</code> has been declared in the global scope.</h3>
<p>Basically, your job is done here. </p>
<p>If <code class="language-text">currying</code> is not defined, then when executing the compiled code, the runtime will scream out <em>“currying is not defined”</em>, just like the <a href="https://www.google.com/search?q=regeneratorRuntime+is+not+defined">“regeneratorRuntime is not defined”</a>.</p>
<p>So probably you have to educate the users to install <code class="language-text">currying</code> polyfills in order to use your <code class="language-text">babel-plugin-transformation-curry-function</code>.</p>
<h3 id="2-use-the-code-classlanguage-textbabelhelperscode"><a href="#2-use-the-code-classlanguage-textbabelhelperscode" aria-label="2 use the code classlanguage textbabelhelperscode permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. Use the <code class="language-text">@babel/helpers</code></h3>
<p>You can add a new helper to <code class="language-text">@babel/helpers</code>, which of course you are unlikely to merge that into the official <code class="language-text">@babel/helpers</code>, so you would have to figure a way to make <code class="language-text">@babel/core</code> to resolve to your <code class="language-text">@babel/helpers</code>:</p>
<p class="filename">package.json</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token string">"resolutions"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"@babel/helpers"</span><span class="token punctuation">:</span> <span class="token string">"7.6.0--your-custom-forked-version"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="caption"> I have not personally tried this, but I believe it will work. If you encountered problems trying this, , I am very happy to discuss it with you.</div>
<p>Adding a new helper function into <code class="language-text">@babel/helpers</code> is very easy.</p>
<p>Head over to <a href="https://github.com/tanhauhau/babel/blob/feat/curry-function/packages/babel-helpers/src/helpers.js">packages/babel-helpers/src/helpers.js</a> and add a new entry:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">helpers<span class="token punctuation">.</span>currying <span class="token operator">=</span> <span class="token function">helper</span><span class="token punctuation">(</span><span class="token string">"7.6.0"</span><span class="token punctuation">)</span><span class="token template-string"><span class="token string">`
  export default function currying(fn) {
    const numParamsRequired = fn.length;
    function curryFactory(params) {
      return function (...args) {
        const newParams = params.concat(args);
        if (newParams.length >= numParamsRequired) {
          return fn(...newParams);
        }
        return curryFactory(newParams);
      }
    }
    return curryFactory([]);
  }
`</span></span><span class="token punctuation">;</span></code></pre></div>
<p>The helper tag function specifies the <code class="language-text">@babel/core</code> version required. The trick here is to <code class="language-text">export default</code> the <code class="language-text">currying</code> function.</p>
<p>To use the helper, just call the <code class="language-text">this.addHelper()</code>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// ...</span>
path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
  t<span class="token punctuation">.</span><span class="token function">variableDeclaration</span><span class="token punctuation">(</span><span class="token string">'const'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    t<span class="token punctuation">.</span><span class="token function">variableDeclarator</span><span class="token punctuation">(</span>
      t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'id.name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span>
      t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addHelper</span><span class="token punctuation">(</span><span class="token string">"currying"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        t<span class="token punctuation">.</span><span class="token function">toExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>The <code class="language-text">this.addHelper</code> will inject the helper at the top of the file if needed, and returns an <code class="language-text">Identifier</code> to the injected function.</p>
<h2 id="closing-note"><a href="#closing-note" aria-label="closing note permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Closing Note</h2>
<p>We’ve seen how we can modify the babel parser function, write our own babel transform plugin <em>(which was brief mainly because I have <a href="/step-by-step-guide-for-writing-a-babel-transformation">a detailed cover in my previous post</a>)</em>, a brief touch on <code class="language-text">@babel/generator</code> and also how we can add helper functions via <code class="language-text">@babel/helpers</code>.</p>
<p>Along the way, we had a crash course on how a parser works, which I will provide the links to <a href="#further-reading">further reading</a> at the bottom.</p>
<p>The steps we’ve gone through above is similar to part of the <a href="https://github.com/tc39/proposals">TC39 proposal</a> <a href="https://tc39.es/process-document/">process</a> when defining a new JavaScript specification. When proposing a new specification, the champion of the proposal usually write polyfills or forked out babel to write proof-of-concept demos. As you’ve seen, forking a parser or writing polyfills is not the hardest part of the process, but to define the problem space, plan and think through the use cases and edge cases, and gather opinions and suggestions from the community. To this end, I am grateful to the proposal champion, for their effort in pushing the JavaScript language forward.</p>
<p>Finally, if you want to see the code we’ve done so far in a full picture, you can <a href="https://github.com/tanhauhau/babel/compare/3a7b6e1c2...b793efad1">check it out from Github</a>.</p>
<hr>
<h2 id="editors-note"><a href="#editors-note" aria-label="editors note permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Editor’s Note</h2>
<p>I’ve worked on the babel repository for a while, yet I’ve never added a new syntax to the babel parser before. Most of my contributions were just fixing bugs and specs compliance feature.</p>
<p>Yet this idea of creating a new syntax has been in my mind for a while. So I took the chance of writing a blog to try it out. It is an exhilarating experience to see it work as expected.</p>
<p>Having the ability to manipulate the syntax of the language you are writing is invigorating. It empowers us the possibility of writing less code or more straightforward code and shifts that complexity to compile time. Just as how <code class="language-text">async-await</code> solves the callback hell and promise-chaining hell.</p>
<p>If this article inspires you to some great idea, and you wish to discuss it with somebody, you are always more than welcome to reach out to me through <a href="https://twitter.com/lihautan">Twitter</a>.</p>
<h2 id="further-reading"><a href="#further-reading" aria-label="further reading permalink" class="anchor"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Further Reading</h2>
<p>About compilers:</p>
<ul>
<li><a href="https://craftinginterpreters.com/introduction.html">Crafting Interpreters</a> by <a href="https://twitter.com/munificentbob?lang=en">Robert Nystrom</a></li>
<li><a href="https://www.udacity.com/course/compilers-theory-and-practice--ud168">Free Udacity course: “Compilers: Theory and Practice”</a>, offered by Georgia Tech</li>
<li><a href="https://medium.com/basecs/leveling-up-ones-parsing-game-with-asts-d7a6fc2400ff">Leveling Up One’s Parsing Game With ASTs</a> by <a href="https://twitter.com/vaidehijoshi">Vaidehi Joshi</a></li>
</ul>
<p>Misc:</p>
<ul>
<li><a href="https://scotch.io/tutorials/understanding-hoisting-in-javascript">Understanding hoisting in JavaScript</a> by <a href="https://twitter.com/emabishi">Mabishi Wakio</a></li>
<li><a href="https://hackernoon.com/currying-in-js-d9ddc64f162e">Currying in JS</a> by <a href="https://twitter.com/zhirzh">Shirsh Zibbu</a></li>
<li><a href="https://github.com/tc39/proposals">TC39 Proposals</a></li>
<li><a href="https://tc39.es/process-document/">TC39 Process Document</a></li>
</ul></div><hr style="margin-bottom:1.58rem"/><p>Thank you for your time reading through this article.<br/>It means a lot to me.</p><p> If you like what you have just read,<br/><a href="https://twitter.com/intent/tweet?text=Insightful%20article%20from%20%40lihautan&amp;url=undefined">Tweet about it</a> so I will write more related articles;<br/>If you disagree or you have opinions about this article,<br/><a href="https://twitter.com/intent/tweet?text=I%20disgree%20with%20%40lihautan&#x27;s%20article&amp;url=undefined">Tweet about it too</a> so I can take your suggestions and improve on it.</p><hr style="margin-bottom:1.58rem"/><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/i-wrote-my-module-bundler/">← <!-- -->I wrote my module bundler</a></li><li></li></ul></main><footer style="margin-top:3.16rem">Built with <span role="img" class="emoji">💻</span> and <span role="img" class="emoji">❤️</span></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-135921142-1', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/creating-custom-javascript-syntax-with-babel/";window.webpackCompilationHash="d240442f94aec6f203b8";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-2282d9d737e771c9b274.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-5fb99864479fcc93f7c9.js"],"component---src-templates-note-post-js":["/component---src-templates-note-post-js-a2a7c7f6527a32eb77ed.js"],"component---src-templates-talk-post-js":["/component---src-templates-talk-post-js-94c411ef19bab9ee7014.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-75b0cd5b7b9eaac0fd32.js"],"component---src-pages-404-js":["/component---src-pages-404-js-b54e192a6489c9682447.js"],"component---src-pages-blogs-js":["/component---src-pages-blogs-js-2829f588e4bbb559808b.js"],"component---src-pages-index-js":["/component---src-pages-index-js-646c1d9039a9c9462c3d.js"],"component---src-pages-notes-js":["/component---src-pages-notes-js-d41478b80b74fc0ea7a6.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-a62da246ed5b7ec5dfef.js"],"component---src-pages-talks-js":["/component---src-pages-talks-js-9f69cbce6882b23340c3.js"]};/*]]>*/</script><script src="/webpack-runtime-070d9725b45c0b94149e.js" async=""></script><script src="/styles-5547210a1c7c84671dbf.js" async=""></script><script src="/app-2282d9d737e771c9b274.js" async=""></script><script src="/1-562d0fc4e13c5148c893.js" async=""></script><script src="/component---src-templates-blog-post-js-75b0cd5b7b9eaac0fd32.js" async=""></script></body></html>