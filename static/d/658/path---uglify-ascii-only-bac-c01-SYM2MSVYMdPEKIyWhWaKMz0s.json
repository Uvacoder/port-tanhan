{"data":{"site":{"siteMetadata":{"title":"Tan Li Hau","author":"Tan Li Hau"}},"markdownRemark":{"id":"c417abb4-2bb9-5f89-a991-a0299cb6041c","excerpt":"The background story I was working on a chrome extension, and trying to add some emojis 😍😀😎 into the extension, however I realised the 😍😀😎 are not…","html":"<p>The background story</p>\n<p>I was working on a chrome extension, and trying to add some emojis 😍😀😎 into the extension, however I realised the 😍😀😎 are not rendered correctly!</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ff2b81e03b2f2d9068a97743adcb69c8/5e68e/problem.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 66.32911392405065%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAAZElEQVQoz+2NwQqAIAyGff837FBIJJubmrm8ZuvQPfIWfbCf8Y+PGe89eppmN4zWLrA4h4hElFICgBgjM4cQmFh3ANTUq6aWpta65rwV0Smyi4g27RmmdXDJx80buevzL39fPgFFRwLqWPWYuwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"The 😍😍😀😀isn’t rendered correctly in chrome extension\"\n        title=\"\"\n        src=\"/static/ff2b81e03b2f2d9068a97743adcb69c8/623ee/problem.png\"\n        srcset=\"/static/ff2b81e03b2f2d9068a97743adcb69c8/816c5/problem.png 148w,\n/static/ff2b81e03b2f2d9068a97743adcb69c8/c766b/problem.png 295w,\n/static/ff2b81e03b2f2d9068a97743adcb69c8/623ee/problem.png 590w,\n/static/ff2b81e03b2f2d9068a97743adcb69c8/e5345/problem.png 885w,\n/static/ff2b81e03b2f2d9068a97743adcb69c8/7a439/problem.png 1180w,\n/static/ff2b81e03b2f2d9068a97743adcb69c8/5e68e/problem.png 1580w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>And so I inspect the source code loaded into the chrome extension, it wasn’t loaded correctly as well!</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d6b5e9c1ff4877c011da49ac7779e01/daa55/problem-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 52.05158264947245%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsSAAALEgHS3X78AAAAYUlEQVQoz+3MuxJAMBSE4bz/CyqMwi0Rl8E5J8sEwQOg0Sh8xXb/qrZu8rTMCh3FidGm0rq3lrvOiYAZ507XiEh5753DSATAi8zDuBCtzJvDJrwCIYT9htpfUA/Hf/yp+AB7gVDwv+I1sAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"problem with the source too\"\n        title=\"\"\n        src=\"/static/1d6b5e9c1ff4877c011da49ac7779e01/623ee/problem-2.png\"\n        srcset=\"/static/1d6b5e9c1ff4877c011da49ac7779e01/816c5/problem-2.png 148w,\n/static/1d6b5e9c1ff4877c011da49ac7779e01/c766b/problem-2.png 295w,\n/static/1d6b5e9c1ff4877c011da49ac7779e01/623ee/problem-2.png 590w,\n/static/1d6b5e9c1ff4877c011da49ac7779e01/e5345/problem-2.png 885w,\n/static/1d6b5e9c1ff4877c011da49ac7779e01/7a439/problem-2.png 1180w,\n/static/1d6b5e9c1ff4877c011da49ac7779e01/daa55/problem-2.png 1706w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>And so I think, probably the encoding issue was caused by the webpack compilation, but, my compiled code looks exactly fine!</p>\n<p><img src=\"./source.png\" alt=\"The compiled code seems okay!\"></p>\n<p>So, most likely is a decoding issue when the emoji code get loaded into chrome extension. So I manually changed the emoji in the compiled code to <code class=\"language-text\">\\ud83d\\ude0d</code> (unicode for 😍). Guess what? The emoji is showing correctly in the chrome extension!</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c3d91cd8d55265438e63eb08b5570a4d/c2902/expectation.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 53.37423312883436%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAAAWklEQVQoz+2LOw6AIBBEuf/9tFESFcIi+6OxsAHhBiaWMsVLZibPxBgdnLPdpsWu+0HM3ntR7RTpr3NZNYTQKgAgYkqpjzkbIkJmFm28L62l1Ncx9UOG/A/5AYJKiv/XIO9rAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"😍!\"\n        title=\"\"\n        src=\"/static/c3d91cd8d55265438e63eb08b5570a4d/623ee/expectation.png\"\n        srcset=\"/static/c3d91cd8d55265438e63eb08b5570a4d/816c5/expectation.png 148w,\n/static/c3d91cd8d55265438e63eb08b5570a4d/c766b/expectation.png 295w,\n/static/c3d91cd8d55265438e63eb08b5570a4d/623ee/expectation.png 590w,\n/static/c3d91cd8d55265438e63eb08b5570a4d/e5345/expectation.png 885w,\n/static/c3d91cd8d55265438e63eb08b5570a4d/7a439/expectation.png 1180w,\n/static/c3d91cd8d55265438e63eb08b5570a4d/c2902/expectation.png 1304w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>So I changed my source code to manually type in the unicode, and compiled it using webpack. To my surprise, the unicode was compiled back into the emoji (😍) it represents!</p>\n<p>I googled around and I found <a href=\"https://github.com/babel/babel/pull/4478\">this fix for babel-generator</a>:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/89e01cd1223b85be658c2ea05cfbd0ab/5be9e/babel-issue.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 41.375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABBklEQVQY031Ry07EMAzM/38IEgf+AQ7ADQkEFM50d1W1TdPEcd4p0+3CcmFHqWNHGo89Fe/P7cfrbtbaGGPZEjFZNkRmjcfEGO+9Y7xbZi6lLD8QT7fdy0NHRM45BpuDtsH5YDjOBApeXa11+YO61BxjzVmwNzhENoR4jAHtoYGSV6rLpWQAiqVuyCWzmpK14ubquu/HUc6DVFJpOc1rVFoT+5hdSLhQzppciH0/4Jz0axXBe/RNKSHWWlKM5+Hqed4ta5rmq223EhSBzPuw2x8mpeEQO7/8D6wjJ4X5t+YrGevtD90wTpb9ZTJk8F+geXIbH3y6u398az7XbaW6QIZ/cPS3/AZH589NEecGCQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"babel issue\"\n        title=\"\"\n        src=\"/static/89e01cd1223b85be658c2ea05cfbd0ab/623ee/babel-issue.png\"\n        srcset=\"/static/89e01cd1223b85be658c2ea05cfbd0ab/816c5/babel-issue.png 148w,\n/static/89e01cd1223b85be658c2ea05cfbd0ab/c766b/babel-issue.png 295w,\n/static/89e01cd1223b85be658c2ea05cfbd0ab/623ee/babel-issue.png 590w,\n/static/89e01cd1223b85be658c2ea05cfbd0ab/e5345/babel-issue.png 885w,\n/static/89e01cd1223b85be658c2ea05cfbd0ab/7a439/babel-issue.png 1180w,\n/static/89e01cd1223b85be658c2ea05cfbd0ab/5be9e/babel-issue.png 1600w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>I checked my babel version, and it had included this fix. So what went wrong?</p>\n<hr>\n<p>My colleague reminded me that during webpack compilation, there are 2 phases, the <strong>transpilation</strong> (via babel) and the <strong>minification</strong> (via uglify plugin).</p>\n<p>So I disabled the optimisation in webpack config, and noticed that my compiled code contains the original unicode string (<code class=\"language-text\">\\ud83d\\ude0d</code>), instead of the emoji (😍) string. So the unicode string was converted to emoji string during minification!</p>\n<p>So I went to my favourite <a href=\"https://skalman.github.io/UglifyJS-online/\">Online JavaScript Minifier</a> (by <a href=\"https://github.com/skalman\">skalman</a>) to try it out.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3c362481f7109a36963627eb1ab37cf3/560b9/uglify.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 21.19521912350598%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAkklEQVQI12OYvGb95NXr5u/aO3PT1nk7d8/YuGXmxq1ztu4EMtacPrvmxIk1R4+uO3Fi3cmTa48d23T27PbLl7ddugRBDG8+f//248evv3//////D4yArL//gPT/+28+3Hr69O+vn79+gwCQ/PPnz18kwPDl5x+INmTwD6z54ZsPj96+hXMxAcPnH79xaX5ASDMA2CDb/Ms6D0sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"online javasript minifier\"\n        title=\"\"\n        src=\"/static/3c362481f7109a36963627eb1ab37cf3/623ee/uglify.png\"\n        srcset=\"/static/3c362481f7109a36963627eb1ab37cf3/816c5/uglify.png 148w,\n/static/3c362481f7109a36963627eb1ab37cf3/c766b/uglify.png 295w,\n/static/3c362481f7109a36963627eb1ab37cf3/623ee/uglify.png 590w,\n/static/3c362481f7109a36963627eb1ab37cf3/e5345/uglify.png 885w,\n/static/3c362481f7109a36963627eb1ab37cf3/7a439/uglify.png 1180w,\n/static/3c362481f7109a36963627eb1ab37cf3/84fe0/uglify.png 1770w,\n/static/3c362481f7109a36963627eb1ab37cf3/560b9/uglify.png 2510w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>After some googling, I <a href=\"https://github.com/mishoo/UglifyJS2/issues/490\">found this issue</a> which described my scenario perfectly.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7080b1d2cff0afacdf72b3196c9d5a13/d40b5/babel-issue-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 42.30396902226525%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABKElEQVQY031Qu1LDMBD0/38IDRVDT0dBQQNDSWCw4jixLVnW86STzDrJwNBws9KcpF3t3TVS634c21b0/VGI/TCMXXcATqcTjoe+33fdV9sO4AhhrF3X9ejHm929cH0z7D7Fy5uc5GKM1ou1zhhwEM46F2L0wTvnich7z8wQR6YPI3wOjXl8Gm7vQAEPAVJKiSLFEC/Uf6J5eH59HxR85sXMeoOxnjJT4kg5UAqUkfhAPpLzHnXVWq/i46SVNlIqqeaMgB2XUtdSK3bQuFRc8Pk+hLAsBslVjIU3pZdJzTBXs56kQg7IWUulHUxTjgn/FrSdUv4tGytzPgvt1aEUEDfwtuOISgBUgclhNn/EeIcDrFD/pPQ4SrSXmLfOt+bzBSnDGWOlH/E3Ub3LvmAYyTcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"why uglifyjs always compress unicode characters to utf8\"\n        title=\"\"\n        src=\"/static/7080b1d2cff0afacdf72b3196c9d5a13/623ee/babel-issue-2.png\"\n        srcset=\"/static/7080b1d2cff0afacdf72b3196c9d5a13/816c5/babel-issue-2.png 148w,\n/static/7080b1d2cff0afacdf72b3196c9d5a13/c766b/babel-issue-2.png 295w,\n/static/7080b1d2cff0afacdf72b3196c9d5a13/623ee/babel-issue-2.png 590w,\n/static/7080b1d2cff0afacdf72b3196c9d5a13/e5345/babel-issue-2.png 885w,\n/static/7080b1d2cff0afacdf72b3196c9d5a13/7a439/babel-issue-2.png 1180w,\n/static/7080b1d2cff0afacdf72b3196c9d5a13/84fe0/babel-issue-2.png 1770w,\n/static/7080b1d2cff0afacdf72b3196c9d5a13/d40b5/babel-issue-2.png 2066w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Turned out there is a <code class=\"language-text\">ascii_only</code> for <a href=\"https://github.com/mishoo/UglifyJS2#output-options\">output options</a>, and it is default to <code class=\"language-text\">false</code>. So I set <code class=\"language-text\">ascii_only</code> to <code class=\"language-text\">true</code>, ran webpack, and checked my compiled code, it contained the unicode string (<code class=\"language-text\">\\ud83d\\ude0d</code>)! And even when I wrote emoji string (😍) in my source code, it got compiled to unicode as well.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> UglifyJsPlugin <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'uglifyjs-webpack-plugin'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//...</span>\n  optimization<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    minimizer<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UglifyJsPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      uglifyOptions<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">        output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">          <span class=\"token comment\">// true for `ascii_only`</span></span><span class=\"gatsby-highlight-code-line\">          ascii_only<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h2>TIL: UglifyJs ascii_only option, use it when you want to escape Unicode characters.</h2>\n<hr>\n<p>Why is there a <code class=\"language-text\">ascii_only</code> option?</p>\n<p>My guess is that it takes less space for a unicode character (16–17bit) than the escaped ascii characters (6 * 8 bit — 12 * bit), that’s why using unicode character is the default option (<code class=\"language-text\">ascii_only=false</code>).</p>","frontmatter":{"title":"The `ascii_only` option in uglify-js","date":"October 27, 2018","description":"that get my emoji showing in my chrome extension"}}},"pageContext":{"slug":"/uglify-ascii-only/","previous":{"fields":{"slug":"/dead-code-elimination/"},"frontmatter":{"title":"Dead-code elimination"}},"next":null}}